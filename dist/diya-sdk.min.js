!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.d1=e()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function noop(){}var process=module.exports={};process.nextTick=function(){var canSetImmediate="undefined"!=typeof window&&window.setImmediate,canPost="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(canSetImmediate)return function(f){return window.setImmediate(f)};if(canPost){var queue=[];return window.addEventListener("message",function(ev){var source=ev.source;if((source===window||null===source)&&"process-tick"===ev.data&&(ev.stopPropagation(),queue.length>0)){var fn=queue.shift();fn()}},!0),function(fn){queue.push(fn),window.postMessage("process-tick","*")}}return function(fn){setTimeout(fn,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],2:[function(require,module,exports){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},{}],3:[function(require,module,exports){(function(process,global){function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};return array.forEach(function(val,idx){hash[val]=!0}),hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=arrayToHash(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(0>recurseTimes)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}return isNumber(value)?ctx.stylize(""+value,"number"):isBoolean(value)?ctx.stylize(""+value,"boolean"):isNull(value)?ctx.stylize("null","null"):void 0}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;l>i;++i)hasOwnProperty(value,String(i))?output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0)):output.push("");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if(desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]},desc.get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0,length=output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);return length>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||"undefined"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return 10>n?"0"+n.toString(10):n.toString(10)}function timestamp(){var d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));return objects.join(" ")}for(var i=1,args=arguments,len=args.length,str=String(f).replace(formatRegExp,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];len>i;x=args[++i])str+=isNull(x)||!isObject(x)?" "+x:" "+inspect(x);return str},exports.deprecate=function(fn,msg){function deprecated(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(fn,msg).apply(this,arguments)};if(process.noDeprecation===!0)return fn;var warned=!1;return deprecated};var debugEnviron,debugs={};exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":2,_process:1,inherits:4}],4:[function(require,module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],5:[function(require,module,exports){function EventEmitter(){EventEmitter.init.call(this)}var util={};util.isObject=function(arg){return"object"==typeof arg&&null!==arg},util.isNumber=function(arg){return"number"==typeof arg},util.isUndefined=function(arg){return void 0===arg},util.isFunction=function(arg){return"function"==typeof arg},module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.init=function(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(n){if(!util.isNumber(n)||0>n||isNaN(n))throw TypeError("n must be a positive number");return this._maxListeners=n,this},EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(this._events||(this._events={}),"error"===type&&!this._events.error)throw er=arguments[1],er instanceof Error?er:Error('Uncaught, unspecified "error" event.');if(handler=this._events[type],util.isUndefined(handler))return!1;if(util.isFunction(handler))switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];handler.apply(this,args)}else if(util.isObject(handler)){for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];for(listeners=handler.slice(),len=listeners.length,i=0;len>i;i++)listeners[i].apply(this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){var m;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",type,util.isFunction(listener.listener)?listener.listener:listener),this._events[type]?util.isObject(this._events[type])?this._events[type].push(listener):this._events[type]=[this._events[type],listener]:this._events[type]=listener,util.isObject(this._events[type])&&!this._events[type].warned){var m;m=util.isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,m&&m>0&&this._events[type].length>m&&(this._events[type].warned=!0,util.isFunction(console.error)&&console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[type].length),util.isFunction(console.trace)&&console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(type,listener){function g(){this.removeListener(type,g),fired||(fired=!0,listener.apply(this,arguments))}if(!util.isFunction(listener))throw TypeError("listener must be a function");var fired=!1;return g.listener=listener,this.on(type,g),this},EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;if(list=this._events[type],length=list.length,position=-1,list===listener||util.isFunction(list.listener)&&list.listener===listener)delete this._events[type],this._events.removeListener&&this.emit("removeListener",type,listener);else if(util.isObject(list)){for(i=length;i-->0;)if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}if(0>position)return this;1===list.length?(list.length=0,delete this._events[type]):list.splice(position,1),this._events.removeListener&&this.emit("removeListener",type,listener)}return this},EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[type]&&delete this._events[type],this;if(0===arguments.length){for(key in this._events)"removeListener"!==key&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events={},this}if(listeners=this._events[type],util.isFunction(listeners))this.removeListener(type,listeners);else if(Array.isArray(listeners))for(;listeners.length;)this.removeListener(type,listeners[listeners.length-1]);return delete this._events[type],this},EventEmitter.prototype.listeners=function(type){var ret;return ret=this._events&&this._events[type]?util.isFunction(this._events[type])?[this._events[type]]:this._events[type].slice():[]},EventEmitter.listenerCount=function(emitter,type){var ret;return ret=emitter._events&&emitter._events[type]?util.isFunction(emitter._events[type])?1:emitter._events[type].length:0}},{}],6:[function(require,module,exports){(function(process){!function(definition){"use strict";if("function"==typeof bootstrap)bootstrap("promise",definition);else if("object"==typeof exports&&"object"==typeof module)module.exports=definition();else if("function"==typeof define&&define.amd)define(definition);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=definition}else{if("undefined"==typeof window&&"undefined"==typeof self)throw new Error("This environment was not anticipated by Q. Please file a bug.");var global="undefined"!=typeof window?window:self,previousQ=global.Q;global.Q=definition(),global.Q.noConflict=function(){return global.Q=previousQ,this}}}(function(){"use strict";function uncurryThis(f){return function(){return call.apply(f,arguments)}}function isObject(value){return value===Object(value)}function isStopIteration(exception){return"[object StopIteration]"===object_toString(exception)||exception instanceof QReturnValue}function makeStackTraceLong(error,promise){if(hasStacks&&promise.stack&&"object"==typeof error&&null!==error&&error.stack&&-1===error.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var stacks=[],p=promise;p;p=p.source)p.stack&&stacks.unshift(p.stack);stacks.unshift(error.stack);var concatedStacks=stacks.join("\n"+STACK_JUMP_SEPARATOR+"\n");error.stack=filterStackString(concatedStacks)}}function filterStackString(stackString){for(var lines=stackString.split("\n"),desiredLines=[],i=0;i<lines.length;++i){var line=lines[i];isInternalFrame(line)||isNodeFrame(line)||!line||desiredLines.push(line)}return desiredLines.join("\n")}function isNodeFrame(stackLine){return-1!==stackLine.indexOf("(module.js:")||-1!==stackLine.indexOf("(node.js:")}function getFileNameAndLineNumber(stackLine){var attempt1=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);if(attempt1)return[attempt1[1],Number(attempt1[2])];var attempt2=/at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);if(attempt2)return[attempt2[1],Number(attempt2[2])];var attempt3=/.*@(.+):(\d+)$/.exec(stackLine);return attempt3?[attempt3[1],Number(attempt3[2])]:void 0}function isInternalFrame(stackLine){var fileNameAndLineNumber=getFileNameAndLineNumber(stackLine);if(!fileNameAndLineNumber)return!1;var fileName=fileNameAndLineNumber[0],lineNumber=fileNameAndLineNumber[1];return fileName===qFileName&&lineNumber>=qStartingLine&&qEndingLine>=lineNumber}function captureLine(){if(hasStacks)try{throw new Error}catch(e){var lines=e.stack.split("\n"),firstLine=lines[0].indexOf("@")>0?lines[1]:lines[2],fileNameAndLineNumber=getFileNameAndLineNumber(firstLine);if(!fileNameAndLineNumber)return;return qFileName=fileNameAndLineNumber[0],fileNameAndLineNumber[1]}}function deprecate(callback,name,alternative){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(name+" is deprecated, use "+alternative+" instead.",new Error("").stack),callback.apply(callback,arguments)}}function Q(value){return value instanceof Promise?value:isPromiseAlike(value)?coerce(value):fulfill(value)}function defer(){function become(newPromise){resolvedPromise=newPromise,promise.source=newPromise,array_reduce(messages,function(undefined,message){Q.nextTick(function(){newPromise.promiseDispatch.apply(newPromise,message)})},void 0),messages=void 0,progressListeners=void 0}var resolvedPromise,messages=[],progressListeners=[],deferred=object_create(defer.prototype),promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,operands){var args=array_slice(arguments);messages?(messages.push(args),"when"===op&&operands[1]&&progressListeners.push(operands[1])):Q.nextTick(function(){resolvedPromise.promiseDispatch.apply(resolvedPromise,args)})},promise.valueOf=function(){if(messages)return promise;var nearerValue=nearer(resolvedPromise);return isPromise(nearerValue)&&(resolvedPromise=nearerValue),nearerValue},promise.inspect=function(){return resolvedPromise?resolvedPromise.inspect():{state:"pending"}},Q.longStackSupport&&hasStacks)try{throw new Error}catch(e){promise.stack=e.stack.substring(e.stack.indexOf("\n")+1)}return deferred.promise=promise,deferred.resolve=function(value){resolvedPromise||become(Q(value))},deferred.fulfill=function(value){resolvedPromise||become(fulfill(value))},deferred.reject=function(reason){resolvedPromise||become(reject(reason))},deferred.notify=function(progress){resolvedPromise||array_reduce(progressListeners,function(undefined,progressListener){Q.nextTick(function(){progressListener(progress)})},void 0)},deferred}function promise(resolver){if("function"!=typeof resolver)throw new TypeError("resolver must be a function.");var deferred=defer();try{resolver(deferred.resolve,deferred.reject,deferred.notify)}catch(reason){deferred.reject(reason)}return deferred.promise}function race(answerPs){return promise(function(resolve,reject){for(var i=0,len=answerPs.length;len>i;i++)Q(answerPs[i]).then(resolve,reject)})}function Promise(descriptor,fallback,inspect){void 0===fallback&&(fallback=function(op){return reject(new Error("Promise does not support operation: "+op))}),void 0===inspect&&(inspect=function(){return{state:"unknown"}});var promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,args){var result;try{result=descriptor[op]?descriptor[op].apply(promise,args):fallback.call(promise,op,args)}catch(exception){result=reject(exception)}resolve&&resolve(result)},promise.inspect=inspect,inspect){var inspected=inspect();"rejected"===inspected.state&&(promise.exception=inspected.reason),promise.valueOf=function(){var inspected=inspect();return"pending"===inspected.state||"rejected"===inspected.state?promise:inspected.value}}return promise}function when(value,fulfilled,rejected,progressed){return Q(value).then(fulfilled,rejected,progressed)}function nearer(value){if(isPromise(value)){var inspected=value.inspect();if("fulfilled"===inspected.state)return inspected.value}return value}function isPromise(object){return object instanceof Promise}function isPromiseAlike(object){return isObject(object)&&"function"==typeof object.then}function isPending(object){return isPromise(object)&&"pending"===object.inspect().state}function isFulfilled(object){return!isPromise(object)||"fulfilled"===object.inspect().state}function isRejected(object){return isPromise(object)&&"rejected"===object.inspect().state}function resetUnhandledRejections(){unhandledReasons.length=0,unhandledRejections.length=0,trackUnhandledRejections||(trackUnhandledRejections=!0)}function trackRejection(promise,reason){trackUnhandledRejections&&("object"==typeof process&&"function"==typeof process.emit&&Q.nextTick.runAfter(function(){-1!==array_indexOf(unhandledRejections,promise)&&(process.emit("unhandledRejection",reason,promise),reportedUnhandledRejections.push(promise))}),unhandledRejections.push(promise),reason&&"undefined"!=typeof reason.stack?unhandledReasons.push(reason.stack):unhandledReasons.push("(no stack) "+reason))}function untrackRejection(promise){if(trackUnhandledRejections){var at=array_indexOf(unhandledRejections,promise);-1!==at&&("object"==typeof process&&"function"==typeof process.emit&&Q.nextTick.runAfter(function(){var atReport=array_indexOf(reportedUnhandledRejections,promise);-1!==atReport&&(process.emit("rejectionHandled",unhandledReasons[at],promise),reportedUnhandledRejections.splice(atReport,1))}),unhandledRejections.splice(at,1),unhandledReasons.splice(at,1))}}function reject(reason){var rejection=Promise({when:function(rejected){return rejected&&untrackRejection(this),rejected?rejected(reason):this}},function(){return this},function(){return{state:"rejected",reason:reason}});return trackRejection(rejection,reason),rejection}function fulfill(value){return Promise({when:function(){return value},get:function(name){return value[name]},set:function(name,rhs){value[name]=rhs},"delete":function(name){delete value[name]},post:function(name,args){return null===name||void 0===name?value.apply(void 0,args):value[name].apply(value,args)},apply:function(thisp,args){return value.apply(thisp,args)},keys:function(){return object_keys(value)}},void 0,function(){return{state:"fulfilled",value:value}})}function coerce(promise){var deferred=defer();return Q.nextTick(function(){try{promise.then(deferred.resolve,deferred.reject,deferred.notify)}catch(exception){deferred.reject(exception)}}),deferred.promise}function master(object){return Promise({isDef:function(){}},function(op,args){return dispatch(object,op,args)},function(){return Q(object).inspect()})}function spread(value,fulfilled,rejected){return Q(value).spread(fulfilled,rejected)}function async(makeGenerator){return function(){function continuer(verb,arg){var result;if("undefined"==typeof StopIteration){try{result=generator[verb](arg)}catch(exception){return reject(exception)}return result.done?Q(result.value):when(result.value,callback,errback)}try{result=generator[verb](arg)}catch(exception){return isStopIteration(exception)?Q(exception.value):reject(exception)}return when(result,callback,errback)}var generator=makeGenerator.apply(this,arguments),callback=continuer.bind(continuer,"next"),errback=continuer.bind(continuer,"throw");return callback()}}function spawn(makeGenerator){Q.done(Q.async(makeGenerator)())}function _return(value){throw new QReturnValue(value)}function promised(callback){return function(){return spread([this,all(arguments)],function(self,args){return callback.apply(self,args)})}}function dispatch(object,op,args){return Q(object).dispatch(op,args)}function all(promises){return when(promises,function(promises){var pendingCount=0,deferred=defer();return array_reduce(promises,function(undefined,promise,index){var snapshot;isPromise(promise)&&"fulfilled"===(snapshot=promise.inspect()).state?promises[index]=snapshot.value:(++pendingCount,when(promise,function(value){promises[index]=value,0===--pendingCount&&deferred.resolve(promises)},deferred.reject,function(progress){deferred.notify({index:index,value:progress})}))},void 0),0===pendingCount&&deferred.resolve(promises),deferred.promise})}function any(promises){if(0===promises.length)return Q.resolve();var deferred=Q.defer(),pendingCount=0;return array_reduce(promises,function(prev,current,index){function onFulfilled(result){deferred.resolve(result)}function onRejected(){pendingCount--,0===pendingCount&&deferred.reject(new Error("Can't get fulfillment value from any promise, all promises were rejected."))}function onProgress(progress){deferred.notify({index:index,value:progress})}var promise=promises[index];pendingCount++,when(promise,onFulfilled,onRejected,onProgress)},void 0),deferred.promise}function allResolved(promises){return when(promises,function(promises){return promises=array_map(promises,Q),when(all(array_map(promises,function(promise){return when(promise,noop,noop)})),function(){return promises})})}function allSettled(promises){return Q(promises).allSettled()}function progress(object,progressed){return Q(object).then(void 0,void 0,progressed)}function nodeify(object,nodeback){return Q(object).nodeify(nodeback)}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qFileName,QReturnValue,qStartingLine=captureLine(),noop=function(){},nextTick=function(){function flush(){for(var task,domain;head.next;)head=head.next,task=head.task,head.task=void 0,domain=head.domain,domain&&(head.domain=void 0,domain.enter()),runSingle(task,domain);for(;laterQueue.length;)task=laterQueue.pop(),runSingle(task);flushing=!1}function runSingle(task,domain){try{task()}catch(e){if(isNodeJS)throw domain&&domain.exit(),setTimeout(flush,0),domain&&domain.enter(),e;setTimeout(function(){throw e},0)}domain&&domain.exit()}var head={task:void 0,next:null},tail=head,flushing=!1,requestTick=void 0,isNodeJS=!1,laterQueue=[];if(nextTick=function(task){tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null},flushing||(flushing=!0,requestTick())},"object"==typeof process&&"[object process]"===process.toString()&&process.nextTick)isNodeJS=!0,requestTick=function(){process.nextTick(flush)};else if("function"==typeof setImmediate)requestTick="undefined"!=typeof window?setImmediate.bind(window,flush):function(){setImmediate(flush)};else if("undefined"!=typeof MessageChannel){var channel=new MessageChannel;channel.port1.onmessage=function(){requestTick=requestPortTick,channel.port1.onmessage=flush,flush()};var requestPortTick=function(){channel.port2.postMessage(0)};requestTick=function(){setTimeout(flush,0),requestPortTick()}}else requestTick=function(){setTimeout(flush,0)};return nextTick.runAfter=function(task){laterQueue.push(task),flushing||(flushing=!0,requestTick())},nextTick}(),call=Function.call,array_slice=uncurryThis(Array.prototype.slice),array_reduce=uncurryThis(Array.prototype.reduce||function(callback,basis){var index=0,length=this.length;if(1===arguments.length)for(;;){if(index in this){basis=this[index++];break}if(++index>=length)throw new TypeError}for(;length>index;index++)index in this&&(basis=callback(basis,this[index],index));return basis}),array_indexOf=uncurryThis(Array.prototype.indexOf||function(value){for(var i=0;i<this.length;i++)if(this[i]===value)return i;return-1}),array_map=uncurryThis(Array.prototype.map||function(callback,thisp){var self=this,collect=[];return array_reduce(self,function(undefined,value,index){collect.push(callback.call(thisp,value,index,self))},void 0),collect}),object_create=Object.create||function(prototype){function Type(){}return Type.prototype=prototype,new Type},object_hasOwnProperty=uncurryThis(Object.prototype.hasOwnProperty),object_keys=Object.keys||function(object){var keys=[];for(var key in object)object_hasOwnProperty(object,key)&&keys.push(key);return keys},object_toString=uncurryThis(Object.prototype.toString);QReturnValue="undefined"!=typeof ReturnValue?ReturnValue:function(value){this.value=value};var STACK_JUMP_SEPARATOR="From previous event:";Q.resolve=Q,Q.nextTick=nextTick,Q.longStackSupport=!1,"object"==typeof process&&process&&process.env&&process.env.Q_DEBUG&&(Q.longStackSupport=!0),Q.defer=defer,defer.prototype.makeNodeResolver=function(){var self=this;return function(error,value){error?self.reject(error):arguments.length>2?self.resolve(array_slice(arguments,1)):self.resolve(value)}},Q.Promise=promise,Q.promise=promise,promise.race=race,promise.all=all,promise.reject=reject,promise.resolve=Q,Q.passByCopy=function(object){return object},Promise.prototype.passByCopy=function(){return this},Q.join=function(x,y){return Q(x).join(y)},Promise.prototype.join=function(that){return Q([this,that]).spread(function(x,y){if(x===y)return x;throw new Error("Can't join: not the same: "+x+" "+y)})},Q.race=race,Promise.prototype.race=function(){return this.then(Q.race)},Q.makePromise=Promise,Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(fulfilled,rejected,progressed){function _fulfilled(value){try{return"function"==typeof fulfilled?fulfilled(value):value}catch(exception){return reject(exception)}}function _rejected(exception){if("function"==typeof rejected){makeStackTraceLong(exception,self);try{return rejected(exception)}catch(newException){return reject(newException)}}return reject(exception)}function _progressed(value){return"function"==typeof progressed?progressed(value):value}var self=this,deferred=defer(),done=!1;return Q.nextTick(function(){self.promiseDispatch(function(value){done||(done=!0,deferred.resolve(_fulfilled(value)))},"when",[function(exception){done||(done=!0,deferred.resolve(_rejected(exception)))}])}),self.promiseDispatch(void 0,"when",[void 0,function(value){var newValue,threw=!1;try{newValue=_progressed(value)}catch(e){if(threw=!0,!Q.onerror)throw e;Q.onerror(e)}threw||deferred.notify(newValue)}]),deferred.promise},Q.tap=function(promise,callback){return Q(promise).tap(callback)},Promise.prototype.tap=function(callback){return callback=Q(callback),
this.then(function(value){return callback.fcall(value).thenResolve(value)})},Q.when=when,Promise.prototype.thenResolve=function(value){return this.then(function(){return value})},Q.thenResolve=function(promise,value){return Q(promise).thenResolve(value)},Promise.prototype.thenReject=function(reason){return this.then(function(){throw reason})},Q.thenReject=function(promise,reason){return Q(promise).thenReject(reason)},Q.nearer=nearer,Q.isPromise=isPromise,Q.isPromiseAlike=isPromiseAlike,Q.isPending=isPending,Promise.prototype.isPending=function(){return"pending"===this.inspect().state},Q.isFulfilled=isFulfilled,Promise.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},Q.isRejected=isRejected,Promise.prototype.isRejected=function(){return"rejected"===this.inspect().state};var unhandledReasons=[],unhandledRejections=[],reportedUnhandledRejections=[],trackUnhandledRejections=!0;Q.resetUnhandledRejections=resetUnhandledRejections,Q.getUnhandledReasons=function(){return unhandledReasons.slice()},Q.stopUnhandledRejectionTracking=function(){resetUnhandledRejections(),trackUnhandledRejections=!1},resetUnhandledRejections(),Q.reject=reject,Q.fulfill=fulfill,Q.master=master,Q.spread=spread,Promise.prototype.spread=function(fulfilled,rejected){return this.all().then(function(array){return fulfilled.apply(void 0,array)},rejected)},Q.async=async,Q.spawn=spawn,Q["return"]=_return,Q.promised=promised,Q.dispatch=dispatch,Promise.prototype.dispatch=function(op,args){var self=this,deferred=defer();return Q.nextTick(function(){self.promiseDispatch(deferred.resolve,op,args)}),deferred.promise},Q.get=function(object,key){return Q(object).dispatch("get",[key])},Promise.prototype.get=function(key){return this.dispatch("get",[key])},Q.set=function(object,key,value){return Q(object).dispatch("set",[key,value])},Promise.prototype.set=function(key,value){return this.dispatch("set",[key,value])},Q.del=Q["delete"]=function(object,key){return Q(object).dispatch("delete",[key])},Promise.prototype.del=Promise.prototype["delete"]=function(key){return this.dispatch("delete",[key])},Q.mapply=Q.post=function(object,name,args){return Q(object).dispatch("post",[name,args])},Promise.prototype.mapply=Promise.prototype.post=function(name,args){return this.dispatch("post",[name,args])},Q.send=Q.mcall=Q.invoke=function(object,name){return Q(object).dispatch("post",[name,array_slice(arguments,2)])},Promise.prototype.send=Promise.prototype.mcall=Promise.prototype.invoke=function(name){return this.dispatch("post",[name,array_slice(arguments,1)])},Q.fapply=function(object,args){return Q(object).dispatch("apply",[void 0,args])},Promise.prototype.fapply=function(args){return this.dispatch("apply",[void 0,args])},Q["try"]=Q.fcall=function(object){return Q(object).dispatch("apply",[void 0,array_slice(arguments,1)])},Promise.prototype.fcall=function(){return this.dispatch("apply",[void 0,array_slice(arguments)])},Q.fbind=function(object){var promise=Q(object),args=array_slice(arguments,1);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Promise.prototype.fbind=function(){var promise=this,args=array_slice(arguments);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Q.keys=function(object){return Q(object).dispatch("keys",[])},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Q.all=all,Promise.prototype.all=function(){return all(this)},Q.any=any,Promise.prototype.any=function(){return any(this)},Q.allResolved=deprecate(allResolved,"allResolved","allSettled"),Promise.prototype.allResolved=function(){return allResolved(this)},Q.allSettled=allSettled,Promise.prototype.allSettled=function(){return this.then(function(promises){return all(array_map(promises,function(promise){function regardless(){return promise.inspect()}return promise=Q(promise),promise.then(regardless,regardless)}))})},Q.fail=Q["catch"]=function(object,rejected){return Q(object).then(void 0,rejected)},Promise.prototype.fail=Promise.prototype["catch"]=function(rejected){return this.then(void 0,rejected)},Q.progress=progress,Promise.prototype.progress=function(progressed){return this.then(void 0,void 0,progressed)},Q.fin=Q["finally"]=function(object,callback){return Q(object)["finally"](callback)},Promise.prototype.fin=Promise.prototype["finally"]=function(callback){return callback=Q(callback),this.then(function(value){return callback.fcall().then(function(){return value})},function(reason){return callback.fcall().then(function(){throw reason})})},Q.done=function(object,fulfilled,rejected,progress){return Q(object).done(fulfilled,rejected,progress)},Promise.prototype.done=function(fulfilled,rejected,progress){var onUnhandledError=function(error){Q.nextTick(function(){if(makeStackTraceLong(error,promise),!Q.onerror)throw error;Q.onerror(error)})},promise=fulfilled||rejected||progress?this.then(fulfilled,rejected,progress):this;"object"==typeof process&&process&&process.domain&&(onUnhandledError=process.domain.bind(onUnhandledError)),promise.then(void 0,onUnhandledError)},Q.timeout=function(object,ms,error){return Q(object).timeout(ms,error)},Promise.prototype.timeout=function(ms,error){var deferred=defer(),timeoutId=setTimeout(function(){error&&"string"!=typeof error||(error=new Error(error||"Timed out after "+ms+" ms"),error.code="ETIMEDOUT"),deferred.reject(error)},ms);return this.then(function(value){clearTimeout(timeoutId),deferred.resolve(value)},function(exception){clearTimeout(timeoutId),deferred.reject(exception)},deferred.notify),deferred.promise},Q.delay=function(object,timeout){return void 0===timeout&&(timeout=object,object=void 0),Q(object).delay(timeout)},Promise.prototype.delay=function(timeout){return this.then(function(value){var deferred=defer();return setTimeout(function(){deferred.resolve(value)},timeout),deferred.promise})},Q.nfapply=function(callback,args){return Q(callback).nfapply(args)},Promise.prototype.nfapply=function(args){var deferred=defer(),nodeArgs=array_slice(args);return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfcall=function(callback){var args=array_slice(arguments,1);return Q(callback).nfapply(args)},Promise.prototype.nfcall=function(){var nodeArgs=array_slice(arguments),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfbind=Q.denodeify=function(callback){var baseArgs=array_slice(arguments,1);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(callback).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nfbind=Promise.prototype.denodeify=function(){var args=array_slice(arguments);return args.unshift(this),Q.denodeify.apply(void 0,args)},Q.nbind=function(callback,thisp){var baseArgs=array_slice(arguments,2);return function(){function bound(){return callback.apply(thisp,arguments)}var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(bound).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nbind=function(){var args=array_slice(arguments,0);return args.unshift(this),Q.nbind.apply(void 0,args)},Q.nmapply=Q.npost=function(object,name,args){return Q(object).npost(name,args)},Promise.prototype.nmapply=Promise.prototype.npost=function(name,args){var nodeArgs=array_slice(args||[]),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nsend=Q.nmcall=Q.ninvoke=function(object,name){var nodeArgs=array_slice(arguments,2),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(object).dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Promise.prototype.nsend=Promise.prototype.nmcall=Promise.prototype.ninvoke=function(name){var nodeArgs=array_slice(arguments,1),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nodeify=nodeify,Promise.prototype.nodeify=function(nodeback){return nodeback?void this.then(function(value){Q.nextTick(function(){nodeback(null,value)})},function(error){Q.nextTick(function(){nodeback(error)})}):this},Q.noConflict=function(){throw new Error("Q.noConflict only works when Q is used as a global")};var qEndingLine=captureLine();return Q})}).call(this,require("_process"))},{_process:1}],7:[function(require,module,exports){function DiyaNode(){EventEmitter.call(this),this._status="closed",this._addr=null,this._socket=null,this._nextId=0,this._connectionDeferred=null,this._disconnectionDeferred=null,this._pendingMessages=[],this._peers=[],this._reconnectTimeout=1e3}var Q=require("q"),EventEmitter=require("node-event-emitter"),inherits=require("inherits"),DEBUG=!0,Logger={log:function(message){DEBUG&&console.log(message)},error:function(message){DEBUG&&console.error(message)}};inherits(DiyaNode,EventEmitter),DiyaNode.prototype.connect=function(addr,WSocket){var that=this;return"opened"===this._status&&this._addr===addr?Q():this.close().then(function(){return that._addr=addr,that._connectionDeferred=Q.defer(),WSocket||(WSocket=window.WebSocket),that._WSocket=WSocket,that._socket=new WSocket(that._addr),that._socket.onclose=that._onclose.bind(that),that._socket.onmessage=that._onmessage.bind(that),that._socket.onerror=function(err){Logger.error("[WS] error : "+err)},that._connectionDeferred.promise})},DiyaNode.prototype.close=function(){return this._disconnectionDeferred?this._disconnectionDeferred.promise:this._socket&&"opened"===this._status?(this._disconnectionDeferred=new Q.defer,this._socket.close(),this._disconnectionDeferred.promise):("closed"===this._status,Q())},DiyaNode.prototype.isConnected=function(){return this._socket&&this._socket.readyState==this._WSocket.OPEN&&"opened"===this._status},DiyaNode.prototype.request=function(params,callback,timeout){var that=this;if(!params.service)return void Logger.error("No service defined for request !");var message=this._createMessage(params,"Request");return this._appendMessage(message,callback),!isNaN(timeout)&&timeout>0&&setTimeout(function(){var handler=that._removeMessage(message.id);handler&&that._notifyListener(handler,"Timeout exceeded ("+timeout+"ms) !")},timeout),this._send(message)?!0:(this._removeMessage(message.id),Logger.error("Cannot send request !"),!1)},DiyaNode.prototype.subscribe=function(params,callback){if(!params.service)return void Logger.error("No service defined for subscription !");var message=this._createMessage(params,"Subscription");return this._appendMessage(message,callback),this._send(message)?message.id:(this._removeMessage(message.id),Logger.error("Cannot send subscription !"),-1)},DiyaNode.prototype.unsubscribe=function(subId){if(this._pendingMessages[subId]&&"Subscription"===this._pendingMessages[subId].type){var subscription=this._removeMessage(subId),message=this._createMessage({target:subscription.target,data:{subId:subId}},"Unsubscribe");return this._send(message)?!0:(Logger.error("Cannot send unsubscribe !"),!1)}},DiyaNode.prototype.peers=function(){return this._peers},DiyaNode.prototype._appendMessage=function(message,callback){this._pendingMessages[message.id]={callback:callback,type:message.type,target:message.target}},DiyaNode.prototype._removeMessage=function(messageId){var handler=this._pendingMessages[messageId];return handler?(delete this._pendingMessages[messageId],handler):null},DiyaNode.prototype._clearMessages=function(err,data){for(var messageId in this._pendingMessages){var handler=this._removeMessage(messageId);this._notifyListener(handler,err,data)}},DiyaNode.prototype._clearPeers=function(){for(;this._peers.length;)this.emit("peer-disconnected",this._peers.pop())},DiyaNode.prototype._getMessageHandler=function(messageId){var handler=this._pendingMessages[messageId];return handler?handler:null},DiyaNode.prototype._notifyListener=function(handler,error,data){handler&&"function"==typeof handler.callback&&(error=error?error:null,data=data?data:null,handler.callback(error,data))},DiyaNode.prototype._send=function(message){try{var data=JSON.stringify(message)}catch(err){return Logger.error("Cannot serialize message"),!1}try{this._socket.send(data)}catch(err){return Logger.error("Cannot send message"),!1}return!0},DiyaNode.prototype._onmessage=function(evt){try{var message=JSON.parse(evt.data)}catch(err){return void Logger.error("[WS] cannot parse message, dropping...")}if(isNaN(message.id))this._handleInternalMessage(message);else{var handler=this._getMessageHandler(message.id);if(handler)switch(handler.type){case"Request":this._handleRequest(handler,message);break;case"Subscription":this._handleSubscription(handler,message)}}},DiyaNode.prototype._onclose=function(){var that=this;this._clearMessages("PeerDisconnected"),this._clearPeers(),this._status="closed",this._connectionDeferred&&(this._connectionDeferred.reject(),this._connectionDeferred=null),this._disconnectionDeferred?(this._disconnectionDeferred.resolve(),this._disconnectionDeferred=null):setTimeout(function(){that.connect(that._addr)},that._reconnectTimeout),this.emit("close",this._addr)},DiyaNode.prototype._handleInternalMessage=function(message){switch(message.type){case"PeerConnected":this._handlePeerConnected(message);break;case"PeerDisconnected":this._handlePeerDisconnected(message);break;case"Handshake":this._handleHandshake(message)}},DiyaNode.prototype._handleHandshake=function(message){if(void 0===message.peers)return void Logger.error("Missing argumnents for Handshake message, dropping...");for(var i=0;i<message.peers.length;i++)this._peers.push(message.peers[i]),this.emit("peer-connected",message.peers[i]);this._connectionDeferred&&!this._connectionDeferred.promise.isFulfilled()&&(this._connectionDeferred.resolve(),this.emit("open",this._addr),this._status="opened",this._connectionDeferred=null)},DiyaNode.prototype._handlePeerConnected=function(message){return void 0===message.peerId?void Logger.error("Missing arguments for PeerConnected message, dropping..."):(this._peers.push(message.peerId),void this.emit("peer-connected",message.peerId))},DiyaNode.prototype._handlePeerDisconnected=function(message){if(void 0===message.peerId)return void Logger.error("Missing arguments for PeerDisconnected Message, dropping...");for(var messageId in this._pendingMessages){var handler=this._getMessageHandler(messageId);handler&&handler.target===message.peerId&&(this._removeMessage(messageId),this._notifyListener(handler,"PeerDisconnected",null))}for(var i=this._peers.length-1;i>=0;i--)if(this._peers[i]===message.peerId){this._peers.splice(i,1);break}this.emit("peer-disconnected",message.peerId)},DiyaNode.prototype._handleRequest=function(handler,message){this._removeMessage(message.id),this._notifyListener(handler,message.error,message.data)},DiyaNode.prototype._handleSubscription=function(handler,message){"closed"===message.result&&(this._removeMessage(message.id),message.error="SubscriptionClosed"),this._notifyListener(handler,message.error,message.data?message.data:null)},DiyaNode.prototype._createMessage=function(params,type){return!params||!type||"Request"!==type&&"Subscription"!==type&&"Unsubscribe"!==type?null:{type:type,id:this._generateId(),service:params.service,target:params.target,token:params.token,func:params.func,obj:params.obj,data:params.data}},DiyaNode.prototype._generateId=function(){var id=this._nextId;return this._nextId++,id},module.exports=DiyaNode},{inherits:4,"node-event-emitter":5,q:6}],8:[function(require,module,exports){function d1(selector){return new DiyaSelector(selector)}function DiyaSelector(selector){EventEmitter.call(this),this._selector=selector,this._listenerCount=0,this._listenCallback=null,this._callbackAttached=!1}function match(selector,str){return"String"===selector.constructor.name?matchString(selector,str):"RegExp"===selector.constructor.name?matchRegExp(selector,str):Array.isArray(selector)?matchArray(selector,str):!1}function matchString(selector,str){return selector===str}function matchRegExp(selector,str){return str.match(selector)}function matchArray(selector,str){for(var i=0;i<selector.length;i++)if(selector[i]===str)return!0;return!1}var EventEmitter=(require("q"),require("node-event-emitter")),inherits=require("inherits"),DiyaNode=require("./DiyaNode"),connection=new DiyaNode,token=(new EventEmitter,null);d1.DiyaNode=DiyaNode,d1.DiyaSelector=DiyaSelector,d1.connect=function(addr){return connection.connect(addr)},d1.disconnect=function(){return token=null,connection.close()},d1.currentServer=function(){return connection._addr},d1.on=function(event,callback){return connection.on(event,callback),d1},d1.deauthenticate=function(){token=null},inherits(DiyaSelector,EventEmitter),DiyaSelector.prototype._select=function(selectorFunction){var that=this;return connection?connection.peers().filter(function(peerId){return match(that._selector,peerId)}):[]},DiyaSelector.prototype._addConnectionListener=function(){0===this._listenerCount&&this._attachListenCallback(),this._listenerCount++},DiyaSelector.prototype._removeConnectionListener=function(){0!==this._listenerCount&&(this._listenerCount--,0===this._listenerCount&&this._detachListenCallback())},DiyaSelector.prototype._attachListenCallback=function(){if(this._connectedCallback=this._handlePeerConnected.bind(this),this._disconnectedCallback=this._handlePeerDisconnected.bind(this),connection.on("peer-connected",this._connectedCallback),connection.on("peer-disconnected",this._disconnectedCallback),connection.isConnected())for(var peers=connection.peers(),i=0;i<peers.length;i++)connection.emit("peer-connected",peers[i])},DiyaSelector.prototype._detachListenCallback=function(){connection.removeListener("peer-connected",this._connectedCallback),connection.removeListener("peer-disconnected",this._disconnectedCallback)},DiyaSelector.prototype._handlePeerConnected=function(peerId){match(this._selector,peerId)&&this.emit("peer-connected",peerId)},DiyaSelector.prototype._handlePeerDisconnected=function(peerId){match(this._selector,peerId)&&this.emit("peer-disconnected",peerId)},DiyaSelector.prototype.listen=function(){return this._addConnectionListener(),this},DiyaSelector.prototype.each=function(cb){for(var peers=this._select(),i=0;i<peers.length;i++)cb.bind(this)(peers[i]);return this},DiyaSelector.prototype.request=function(params,callback,timeout){return connection?this.each(function(peerId){params.target=peerId,params.token=token,connection.request(params,function(err,data){"function"==typeof callback&&callback(peerId,err,data)},timeout)}):this},DiyaSelector.prototype.subscribe=function(params,callback,options){function doSubscribe(peerId){params.target=peerId,params.token=token;var subId=connection.subscribe(params,function(err,data){callback(peerId,err,data)});options&&Array.isArray(options.subIds)&&(options.subIds[peerId]=subId)}return this.each(doSubscribe),options&&options.auto&&(this._addConnectionListener(),this.on("peer-connected",doSubscribe)),this},DiyaSelector.prototype.unsubscribe=function(subIds){return this.each(function(peerId){var subId=subIds[peerId];subId&&connection.unsubscribe(subId)})},DiyaSelector.prototype.auth=function(user,password,callback,timeout){return callback=callback.bind(this),this.request({service:"auth",func:"Authenticate",data:{user:user,password:password}},function(peerId,err,data){return"ServiceNotFound"===err?void callback(peerId,!0):void(!err&&data&&data.authenticated&&data.token?(token=data.token,callback(peerId,!0)):callback(peerId,!1))},timeout)},module.exports=d1},{"./DiyaNode":7,inherits:4,"node-event-emitter":5,q:6}],9:[function(require,module,exports){var d1=require("./DiyaSelector.js");require("./services/timer/timer.js"),require("./services/rtc/rtc.js"),require("./services/update/update.js"),module.exports=d1},{"./DiyaSelector.js":8,"./services/rtc/rtc.js":11,"./services/timer/timer.js":12,"./services/update/update.js":13}],10:[function(require,module,exports){function Message(service,func,obj,permanent){this.service=service,this.func=func,this.obj=obj,this.permanent=permanent}Message.buildSignature=function(msg){return msg.service+"."+msg.func+"."+msg.obj},Message.prototype.signature=function(){return this.service+"."+this.func+"."+this.obj},Message.prototype.exec=function(data){return{service:this.service,func:this.func,obj:this.obj,data:data}},module.exports=Message},{}],11:[function(require,module,exports){function Channel(dnId,name,open_cb){EventEmitter.call(this),this.name=name,this.dnId=dnId,this.frequency=20,this.channel=void 0,this.onopen=open_cb,this.closed=!1}function Peer(dnId,rtc,id,channels){this.dn=d1(dnId),this.dnId=dnId,this.id=id,this.channels=channels,this.rtc=rtc,this.peer=null,this.connected=!1,this.closed=!1,this._connect()}function RTC(selector){this.selector=selector,this.requestedChannels=[]}function createNeuronsFromDOM(domNode,rtc){if(domNode&&domNode.querySelectorAll){for(var neuronNodeList=domNode.querySelectorAll("*"),neuronNodes=[],i=0;i<neuronNodeList.length;i++)isNeuronTag(neuronNodeList[i])&&neuronNodes.push(neuronNodeList[i]);neuronNodes.forEach(function(neuronNode){rtc.use(neuronNode.attributes.name.value,function(dnId,neuron){neuronNode.setNeuron(dnId,neuron)})})}}function isNeuronTag(node){return node.tagName.startsWith("NEURON-")&&node.attributes.name&&"function"==typeof node.setNeuron}DiyaSelector=require("../../DiyaSelector").DiyaSelector,EventEmitter=require("node-event-emitter"),inherits=require("inherits");var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;inherits(Channel,EventEmitter),Channel.prototype.setChannel=function(datachannel){this.channel=datachannel,this._negociate()},Channel.prototype.close=function(){this.closed=!0},Channel.prototype.write=function(index,value){return 0>index||index>this.size||isNaN(value)?!1:(this._buffer[index]=value,this._requestSend(),!0)},Channel.prototype.writeAll=function(values){if(!Array.isArray(values)||values.length!==this.size)return!1;for(var i=0;i<values.length;i++){if(isNaN(values[i]))return!1;this._buffer[i]=values[i]}this._requestSend()},Channel.prototype._requestSend=function(){function doSend(){that._sendRequested=!1,that._lastSendTimestamp=(new Date).getTime(),that._send(that._buffer)}var that=this,elapsedTime=(new Date).getTime()-this._lastSendTimestamp,period=1e3/this.frequency;elapsedTime>=period?doSend():this._sendRequested||(this._sendRequested=!0,setTimeout(doSend,period-elapsedTime))},Channel.prototype._send=function(msg){if(this.closed)return!1;if("open"===this.channel.readyState){try{this.channel.send(msg)}catch(e){console.log("[rtc.channel.write] exception occured while sending data")}return!0}return console.log("[rtc.channel.write] warning : webrtc datachannel state = "+this.channel.readyState),!1},Channel.prototype._negociate=function(){var that=this;this.channel.onmessage=function(message){var view=new DataView(message.data),typeChar=String.fromCharCode(view.getUint8(0));"O"===typeChar?that.type="input":"I"===typeChar&&(that.type="output");var size=view.getInt32(1,!0);void 0!=size&&(that.size=size,that._buffer=new Float32Array(size)),that.channel.onmessage=that._onMessage.bind(that),"function"==typeof that.onopen&&that.onopen(that.dnId,that)}},Channel.prototype._onMessage=function(message){var valArray=new Float32Array(message.data);this.emit("value",valArray)},Peer.prototype._connect=function(){var that=this;this.subIds=[],this.dn.subscribe({service:"rtc",func:"Connect",obj:this.channels,data:{promID:this.id}},function(diya,err,data){data&&that._handleNegociationMessage(data)},this.subIds),setTimeout(function(){that.connected||that.closed||that._reconnect()},1e4)},Peer.prototype._reconnect=function(){this.close(),this.peer=null,this.connected=!1,this.closed=!1,this._connect()},Peer.prototype._handleNegociationMessage=function(msg){"RemoteOffer"===msg.eventType?this._createPeer(msg):"RemoteICECandidate"===msg.eventType&&this._addRemoteICECandidate(msg)};var servers={iceServers:[{url:"stun:stun.l.google.com:19302"}]};Peer.prototype._createPeer=function(data){var that=this,peer=new RTCPeerConnection(servers,{mandatory:[{DtlsSrtpKeyAgreement:!0},{EnableDtlsSrtp:!0}]});this.peer=peer,peer.setRemoteDescription(new RTCSessionDescription({sdp:data.sdp,type:data.type})),peer.createAnswer(function(session_description){peer.setLocalDescription(session_description),that.dn.request({service:"rtc",func:"Answer",data:{promID:data.promID,peerId:data.peerId,sdp:session_description.sdp,type:session_description.type}})},function(err){console.log("RTC: cannot create answer :"),console.log(err)},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}),peer.oniceconnectionstatechange=function(){console.log("RTC: state change("+that.id+":"+that.dnId+") : "+peer.iceConnectionState),"connected"===peer.iceConnectionState?(that.connected=!0,that.dn.unsubscribe(that.subIds)):"disconnected"===peer.iceConnectionState&&(that.closed||that._reconnect())},peer.onicecandidate=function(evt){that.dn.request({service:"rtc",func:"ICECandidate",data:{peerId:data.peerId,promID:that.id,candidate:evt.candidate}})},peer.ondatachannel=function(evt){that.connected=!0,that.rtc._onDataChannel(that.dnId,evt.channel)}},Peer.prototype._addRemoteICECandidate=function(data){var that=this;try{var candidate=new RTCIceCandidate(data.candidate);this.peer.addIceCandidate(candidate,function(){console.log("RTC: candidate added("+that.id+":"+that.dnId+") : "+that.peer.iceConnectionState)},function(err){console.error("RTC: cannot add RemoteICECandidate :"),console.error(err)})}catch(err){console.error("RTC: cannot add RemoteICECandidate : "),console.error(err)}},Peer.prototype.close=function(){if(this.dn.unsubscribe(this.subIds),this.peer){try{this.peer.close()}catch(e){}this.connected=!1,this.closed=!0}},RTC.prototype.disconnect=function(){var that=this;return this.selector.each(function(dnId){for(var promID in that[dnId].peers)that._closePeer(dnId,promID)}),this.selector.unsubscribe(this.subIds),this},RTC.prototype.use=function(name_regex,onopen_callback){return this.requestedChannels.push({regex:name_regex,cb:onopen_callback}),this},RTC.prototype.connect=function(){var that=this;return this.subIds=[],this.selector.subscribe({service:"rtc",func:"ListenPeers"},function(dnId,err,data){if(that[dnId]||that._createDiyaNode(dnId),"SubscriptionClosed"===err||"PeerDisconnected"===err)return void that._closeDiyaNode(dnId);if(data&&data.eventType&&void 0!==data.promID)if("PeerConnected"===data.eventType){if(!that[dnId].peers[data.promID]){var channels=that._matchChannels(dnId,data.channels);channels.length>0&&(that[dnId].peers[data.promID]=new Peer(dnId,that,data.promID,channels))}}else"PeerClosed"===data.eventType&&that[dnId].peers[data.promID]&&(that._closePeer(dnId,data.promID),"function"==typeof that.onclose&&that.onclose(dnId))},{subIds:this.subIds,auto:!0}),this},RTC.prototype._createDiyaNode=function(dnId){var that=this;this[dnId]={dnId:dnId,usedChannels:[],requestedChannels:[],peers:[]},this.requestedChannels.forEach(function(c){that[dnId].requestedChannels.push(c)})},RTC.prototype._closeDiyaNode=function(dnId){for(var promID in this[dnId].peers)this._closePeer(dnId,promID);delete this[dnId]},RTC.prototype._closePeer=function(dnId,promID){if(this[dnId].peers[promID]){var p=this[dnId].peers[promID];p.close();for(var i=0;i<p.channels.length;i++)delete this[dnId].usedChannels[p.channels[i]];delete this[dnId].peers[promID]}},RTC.prototype._matchChannels=function(dnId,receivedChannels){for(var that=this,channels=[],i=0;i<receivedChannels.length;i++)for(var name=receivedChannels[i],j=0;j<that[dnId].requestedChannels.length;j++){var req=that[dnId].requestedChannels[j];name&&name.match(req.regex)&&!that[dnId].usedChannels[name]&&(that[dnId].usedChannels[name]=new Channel(dnId,name,req.cb),channels.push(name))}return channels},RTC.prototype._onDataChannel=function(dnId,datachannel){console.log("Channel "+datachannel.label+" created !");var channel=this[dnId].usedChannels[datachannel.label];return channel?void channel.setChannel(datachannel):void datachannel.close()},DiyaSelector.prototype.rtc=function(domNode){var rtc=new RTC(this);return domNode&&createNeuronsFromDOM(domNode,rtc),rtc}},{"../../DiyaSelector":8,inherits:4,"node-event-emitter":5}],12:[function(require,module,exports){DiyaSelector=require("../../DiyaSelector").DiyaSelector,DiyaSelector.prototype.time=function(loop,callback){return loop?this.subscribe({service:"timer",func:"SubscribeTimer"},callback,{auto:!0}):this.request({service:"timer",func:"GetTime"},callback),this}},{"../../DiyaSelector":8}],13:[function(require,module,exports){require("util");DiyaSelector=require("../../DiyaSelector").DiyaSelector;require("../message");DiyaSelector.prototype.statusLockApt=function(SubID,callback){this.subscribe({service:"update",func:"SubscribeLockStatus"},function(peerId,error,res){callback(null,res.lockStatus),console.log(res.lockStatus)},{auto:!0,subIds:SubID})},DiyaSelector.prototype.listPackages=function(callback){this.request({service:"update",func:"ListPackages"},function(peerId,error,data){data.packages&&callback(null,data.packages),error&&callback(error,null)})},DiyaSelector.prototype.updateAll=function(callback){this.request({service:"update",func:"UpdateAll"},function(peerId,error,data){data&&data.packages&&callback(null,data.packages),error&&callback(error,null)})},DiyaSelector.prototype.installPackage=function(pkg,callback){if("Undefined"===pkg||"string"!=typeof pkg||pkg.length<2)callback("undefinedPackage",null);else{var INVALID_PARAMETERS_REGEX=/^-|[^\s]\s+[^\s]|-$/,testNamePkg=INVALID_PARAMETERS_REGEX.test(pkg);testNamePkg?callback("InvalidParameters",null):this.request({service:"update",func:"InstallPackage",data:{"package":pkg}},function(peerId,error,data){data&&data.packages&&callback(null,data.packages),error&&callback(error,null)})}},DiyaSelector.prototype.removePackage=function(pkg,callback){if("Undefined"===pkg||"string"!=typeof pkg||pkg.length<2)callback("undefinedPackage",null);else{var INVALID_PARAMETERS_REGEX=/^[+ -]|[^\s]\s+[^\s]|[+ -]$/,testNamePkg=INVALID_PARAMETERS_REGEX.test(pkg);testNamePkg?callback("InvalidParameters",null):this.request({service:"update",func:"RemovePackage",data:{"package":pkg}},function(peerId,error,data){data&&data.packages&&callback(null,data.packages),error&&callback(error,null)})}}},{"../../DiyaSelector":8,"../message":10,util:3}]},{},[9])(9)});
