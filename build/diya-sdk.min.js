!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.d1=f()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){(function(global){!function(root){var freeExports="object"==typeof exports&&exports,freeModule="object"==typeof module&&module&&module.exports==freeExports&&module,freeGlobal="object"==typeof global&&global;freeGlobal.global!==freeGlobal&&freeGlobal.window!==freeGlobal||(root=freeGlobal);var InvalidCharacterError=function(message){this.message=message};InvalidCharacterError.prototype=new Error,InvalidCharacterError.prototype.name="InvalidCharacterError";var error=function(message){throw new InvalidCharacterError(message)},TABLE="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",decode=function(input){input=String(input).replace(/[\t\n\f\r ]/g,"");var length=input.length;length%4==0&&(input=input.replace(/==?$/,""),length=input.length),(length%4==1||/[^+a-zA-Z0-9\/]/.test(input))&&error("Invalid character: the string to be decoded is not correctly encoded.");for(var bitStorage,buffer,bitCounter=0,output="",position=-1;++position<length;)buffer=TABLE.indexOf(input.charAt(position)),bitStorage=bitCounter%4?64*bitStorage+buffer:buffer,bitCounter++%4&&(output+=String.fromCharCode(255&bitStorage>>(-2*bitCounter&6)));return output},encode=function(input){input=String(input),/[^\0-\xFF]/.test(input)&&error("The string to be encoded contains characters outside of the Latin1 range.");for(var a,b,c,buffer,padding=input.length%3,output="",position=-1,length=input.length-padding;++position<length;)a=input.charCodeAt(position)<<16,b=input.charCodeAt(++position)<<8,c=input.charCodeAt(++position),buffer=a+b+c,output+=TABLE.charAt(buffer>>18&63)+TABLE.charAt(buffer>>12&63)+TABLE.charAt(buffer>>6&63)+TABLE.charAt(63&buffer);return 2==padding?(a=input.charCodeAt(position)<<8,b=input.charCodeAt(++position),buffer=a+b,output+=TABLE.charAt(buffer>>10)+TABLE.charAt(buffer>>4&63)+TABLE.charAt(buffer<<2&63)+"="):1==padding&&(buffer=input.charCodeAt(position),output+=TABLE.charAt(buffer>>2)+TABLE.charAt(buffer<<4&63)+"=="),output},base64={encode:encode,decode:decode,version:"0.1.0"};if("function"==typeof define&&"object"==typeof define.amd&&define.amd)define(function(){return base64});else if(freeExports&&!freeExports.nodeType)if(freeModule)freeModule.exports=base64;else for(var key in base64)base64.hasOwnProperty(key)&&(freeExports[key]=base64[key]);else root.base64=base64}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(require,module,exports){},{}],3:[function(require,module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],4:[function(require,module,exports){function EventEmitter(){EventEmitter.init.call(this)}var util={};util.isObject=function(arg){return"object"==typeof arg&&null!==arg},util.isNumber=function(arg){return"number"==typeof arg},util.isUndefined=function(arg){return void 0===arg},util.isFunction=function(arg){return"function"==typeof arg},module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.init=function(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(n){if(!util.isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");return this._maxListeners=n,this},EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(this._events||(this._events={}),"error"===type&&!this._events.error)throw er=arguments[1],er instanceof Error?er:Error('Uncaught, unspecified "error" event.');if(handler=this._events[type],util.isUndefined(handler))return!1;if(util.isFunction(handler))switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:for(len=arguments.length,args=new Array(len-1),i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}else if(util.isObject(handler)){for(len=arguments.length,args=new Array(len-1),i=1;i<len;i++)args[i-1]=arguments[i];for(listeners=handler.slice(),len=listeners.length,i=0;i<len;i++)listeners[i].apply(this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){var m;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",type,util.isFunction(listener.listener)?listener.listener:listener),this._events[type]?util.isObject(this._events[type])?this._events[type].push(listener):this._events[type]=[this._events[type],listener]:this._events[type]=listener,util.isObject(this._events[type])&&!this._events[type].warned){var m;m=util.isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,m&&m>0&&this._events[type].length>m&&(this._events[type].warned=!0,util.isFunction(console.error)&&console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[type].length),util.isFunction(console.trace)&&console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(type,listener){function g(){this.removeListener(type,g),fired||(fired=!0,listener.apply(this,arguments))}if(!util.isFunction(listener))throw TypeError("listener must be a function");var fired=!1;return g.listener=listener,this.on(type,g),this},EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;if(list=this._events[type],length=list.length,position=-1,list===listener||util.isFunction(list.listener)&&list.listener===listener)delete this._events[type],this._events.removeListener&&this.emit("removeListener",type,listener);else if(util.isObject(list)){for(i=length;i-- >0;)if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}if(position<0)return this;1===list.length?(list.length=0,delete this._events[type]):list.splice(position,1),this._events.removeListener&&this.emit("removeListener",type,listener)}return this},EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[type]&&delete this._events[type],this;if(0===arguments.length){for(key in this._events)"removeListener"!==key&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events={},this}if(listeners=this._events[type],util.isFunction(listeners))this.removeListener(type,listeners);else if(Array.isArray(listeners))for(;listeners.length;)this.removeListener(type,listeners[listeners.length-1]);return delete this._events[type],this},EventEmitter.prototype.listeners=function(type){return this._events&&this._events[type]?util.isFunction(this._events[type])?[this._events[type]]:this._events[type].slice():[]},EventEmitter.listenerCount=function(emitter,type){return emitter._events&&emitter._events[type]?util.isFunction(emitter._events[type])?1:emitter._events[type].length:0}},{}],5:[function(require,module,exports){function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,runClearTimeout(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}var cachedSetTimeout,cachedClearTimeout,process=module.exports={};!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],6:[function(require,module,exports){arguments[4][3][0].apply(exports,arguments)},{dup:3}],7:[function(require,module,exports){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},{}],8:[function(require,module,exports){(function(process,global){function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};return array.forEach(function(val,idx){hash[val]=!0}),hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=arrayToHash(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value)){base=" [Function"+(value.name?": "+value.name:"")+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(recurseTimes<0)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}return isNumber(value)?ctx.stylize(""+value,"number"):isBoolean(value)?ctx.stylize(""+value,"boolean"):isNull(value)?ctx.stylize("null","null"):void 0}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;i<l;++i)hasOwnProperty(value,String(i))?output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0)):output.push("");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if(desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]},desc.get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;return output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||void 0===arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}function timestamp(){var d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));return objects.join(" ")}for(var i=1,args=arguments,len=args.length,str=String(f).replace(/%[sdj%]/g,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];i<len;x=args[++i])isNull(x)||!isObject(x)?str+=" "+x:str+=" "+inspect(x);return str},exports.deprecate=function(fn,msg){function deprecated(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(fn,msg).apply(this,arguments)};if(!0===process.noDeprecation)return fn;var warned=!1;return deprecated};var debugEnviron,debugs={};exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":7,_process:5,inherits:6}],9:[function(require,module,exports){"use strict";!function(){var logging=require("./utils").log,browserDetails=require("./utils").browserDetails;module.exports.browserDetails=browserDetails,module.exports.extractVersion=require("./utils").extractVersion,module.exports.disableLog=require("./utils").disableLog,require("./utils").disableLog(!0);var chromeShim=require("./chrome/chrome_shim")||null,edgeShim=require("./edge/edge_shim")||null,firefoxShim=require("./firefox/firefox_shim")||null,safariShim=require("./safari/safari_shim")||null;switch(browserDetails.browser){case"opera":case"chrome":if(!chromeShim||!chromeShim.shimPeerConnection)return void logging("Chrome shim is not included in this adapter release.");logging("adapter.js shimming chrome."),module.exports.browserShim=chromeShim,chromeShim.shimGetUserMedia(),chromeShim.shimSourceObject(),chromeShim.shimPeerConnection(),chromeShim.shimOnTrack();break;case"firefox":if(!firefoxShim||!firefoxShim.shimPeerConnection)return void logging("Firefox shim is not included in this adapter release.");logging("adapter.js shimming firefox."),module.exports.browserShim=firefoxShim,firefoxShim.shimGetUserMedia(),firefoxShim.shimSourceObject(),firefoxShim.shimPeerConnection(),firefoxShim.shimOnTrack();break;case"edge":if(!edgeShim||!edgeShim.shimPeerConnection)return void logging("MS edge shim is not included in this adapter release.");logging("adapter.js shimming edge."),module.exports.browserShim=edgeShim,edgeShim.shimPeerConnection();break;case"safari":if(!safariShim)return void logging("Safari shim is not included in this adapter release.");logging("adapter.js shimming safari."),module.exports.browserShim=safariShim,safariShim.shimGetUserMedia();break;default:logging("Unsupported browser!")}}()},{"./chrome/chrome_shim":10,"./edge/edge_shim":13,"./firefox/firefox_shim":14,"./safari/safari_shim":16,"./utils":17}],10:[function(require,module,exports){"use strict";var logging=require("../utils.js").log,browserDetails=require("../utils.js").browserDetails,chromeShim={shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(f){var self=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=f),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(te){var event=new Event("track");event.track=te.track,event.receiver={track:te.track},event.streams=[e.stream],self.dispatchEvent(event)}),e.stream.getTracks().forEach(function(track){var event=new Event("track");event.track=track,event.receiver={track:track},event.streams=[e.stream],this.dispatchEvent(event)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(stream){var self=this;if(this._srcObject=stream,this.src&&URL.revokeObjectURL(this.src),!stream)return void(this.src="");this.src=URL.createObjectURL(stream),stream.addEventListener("addtrack",function(){self.src&&URL.revokeObjectURL(self.src),self.src=URL.createObjectURL(stream)}),stream.addEventListener("removetrack",function(){self.src&&URL.revokeObjectURL(self.src),self.src=URL.createObjectURL(stream)})}}))},shimPeerConnection:function(){window.RTCPeerConnection=function(pcConfig,pcConstraints){logging("PeerConnection"),pcConfig&&pcConfig.iceTransportPolicy&&(pcConfig.iceTransports=pcConfig.iceTransportPolicy);var pc=new webkitRTCPeerConnection(pcConfig,pcConstraints),origGetStats=pc.getStats.bind(pc);return pc.getStats=function(selector,successCallback,errorCallback){var self=this,args=arguments;if(arguments.length>0&&"function"==typeof selector)return origGetStats(selector,successCallback);var fixChromeStats_=function(response){var standardReport={};return response.result().forEach(function(report){var standardStats={id:report.id,timestamp:report.timestamp,type:report.type};report.names().forEach(function(name){standardStats[name]=report.stat(name)}),standardReport[standardStats.id]=standardStats}),standardReport};if(arguments.length>=2){var successCallbackWrapper_=function(response){args[1](fixChromeStats_(response))};return origGetStats.apply(this,[successCallbackWrapper_,arguments[0]])}return new Promise(function(resolve,reject){1===args.length&&"object"==typeof selector?origGetStats.apply(self,[function(response){resolve.apply(null,[fixChromeStats_(response)])},reject]):origGetStats.apply(self,[resolve,reject])})},pc},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){var self=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var opts=1===arguments.length?arguments[0]:void 0;return new Promise(function(resolve,reject){nativeMethod.apply(self,[resolve,reject,opts])})}return nativeMethod.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){var args=arguments,self=this;return args[0]=new("addIceCandidate"===method?RTCIceCandidate:RTCSessionDescription)(args[0]),new Promise(function(resolve,reject){nativeMethod.apply(self,[args[0],function(){resolve(),args.length>=2&&args[1].apply(null,[])},function(err){reject(err),args.length>=3&&args[2].apply(null,[err])}])})}})},attachMediaStream:function(element,stream){logging("DEPRECATED, attachMediaStream will soon be removed."),browserDetails.version>=43?element.srcObject=stream:void 0!==element.src?element.src=URL.createObjectURL(stream):logging("Error attaching stream to element.")},reattachMediaStream:function(to,from){logging("DEPRECATED, reattachMediaStream will soon be removed."),browserDetails.version>=43?to.srcObject=from.srcObject:to.src=from.src}};module.exports={shimOnTrack:chromeShim.shimOnTrack,shimSourceObject:chromeShim.shimSourceObject,shimPeerConnection:chromeShim.shimPeerConnection,shimGetUserMedia:require("./getusermedia"),attachMediaStream:chromeShim.attachMediaStream,reattachMediaStream:chromeShim.reattachMediaStream}},{"../utils.js":17,"./getusermedia":11}],11:[function(require,module,exports){"use strict";var logging=require("../utils.js").log;module.exports=function(){var constraintsToChrome_=function(c){if("object"!=typeof c||c.mandatory||c.optional)return c;var cc={};return Object.keys(c).forEach(function(key){if("require"!==key&&"advanced"!==key&&"mediaSource"!==key){var r="object"==typeof c[key]?c[key]:{ideal:c[key]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var oldname_=function(prefix,name){return prefix?prefix+name.charAt(0).toUpperCase()+name.slice(1):"deviceId"===name?"sourceId":name};if(void 0!==r.ideal){cc.optional=cc.optional||[];var oc={};"number"==typeof r.ideal?(oc[oldname_("min",key)]=r.ideal,cc.optional.push(oc),oc={},oc[oldname_("max",key)]=r.ideal,cc.optional.push(oc)):(oc[oldname_("",key)]=r.ideal,cc.optional.push(oc))}void 0!==r.exact&&"number"!=typeof r.exact?(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname_("",key)]=r.exact):["min","max"].forEach(function(mix){void 0!==r[mix]&&(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname_(mix,key)]=r[mix])})}}),c.advanced&&(cc.optional=(cc.optional||[]).concat(c.advanced)),cc},getUserMedia_=function(constraints,onSuccess,onError){return constraints=JSON.parse(JSON.stringify(constraints)),constraints.audio&&(constraints.audio=constraintsToChrome_(constraints.audio)),constraints.video&&(constraints.video=constraintsToChrome_(constraints.video)),logging("chrome: "+JSON.stringify(constraints)),navigator.webkitGetUserMedia(constraints,onSuccess,onError)};navigator.getUserMedia=getUserMedia_;var getUserMediaPromise_=function(constraints){return new Promise(function(resolve,reject){navigator.getUserMedia(constraints,resolve,reject)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:getUserMediaPromise_,enumerateDevices:function(){return new Promise(function(resolve){var kinds={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(devices){resolve(devices.map(function(device){return{label:device.label,kind:kinds[device.kind],deviceId:device.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return c&&(logging("spec:   "+JSON.stringify(c)),c.audio=constraintsToChrome_(c.audio),c.video=constraintsToChrome_(c.video),logging("chrome: "+JSON.stringify(c))),origGetUserMedia(c)}.bind(this)}else navigator.mediaDevices.getUserMedia=function(constraints){return getUserMediaPromise_(constraints)};void 0===navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){logging("Dummy mediaDevices.addEventListener called.")}),void 0===navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){logging("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":17}],12:[function(require,module,exports){"use strict";var SDPUtils={};SDPUtils.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},SDPUtils.localCName=SDPUtils.generateIdentifier(),SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map(function(line){return line.trim()})},SDPUtils.splitSections=function(blob){return blob.split("\nm=").map(function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"})},SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter(function(line){return 0===line.indexOf(prefix)})},SDPUtils.parseCandidate=function(line){var parts;parts=0===line.indexOf("a=candidate:")?line.substring(12).split(" "):line.substring(10).split(" ");for(var candidate={foundation:parts[0],component:parts[1],protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],port:parseInt(parts[5],10),type:parts[7]},i=8;i<parts.length;i+=2)switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1]}return candidate},SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation),sdp.push(candidate.component),sdp.push(candidate.protocol.toUpperCase()),sdp.push(candidate.priority),sdp.push(candidate.ip),sdp.push(candidate.port);var type=candidate.type;return sdp.push("typ"),sdp.push(type),"host"!==type&&candidate.relatedAddress&&candidate.relatedPort&&(sdp.push("raddr"),sdp.push(candidate.relatedAddress),sdp.push("rport"),sdp.push(candidate.relatedPort)),candidate.tcpType&&"tcp"===candidate.protocol.toLowerCase()&&(sdp.push("tcptype"),sdp.push(candidate.tcpType)),"candidate:"+sdp.join(" ")},SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" "),parsed={payloadType:parseInt(parts.shift(),10)};return parts=parts[0].split("/"),parsed.name=parts[0],parsed.clockRate=parseInt(parts[1],10),
parsed.numChannels=3===parts.length?parseInt(parts[2],10):1,parsed},SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;return void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(1!==codec.numChannels?"/"+codec.numChannels:"")+"\r\n"},SDPUtils.parseExtmap=function(line){var parts=line.substr(9).split(" ");return{id:parseInt(parts[0],10),uri:parts[1]}},SDPUtils.writeExtmap=function(headerExtension){return"a=extmap:"+(headerExtension.id||headerExtension.preferredId)+" "+headerExtension.uri+"\r\n"},SDPUtils.parseFmtp=function(line){for(var kv,parsed={},parts=line.substr(line.indexOf(" ")+1).split(";"),j=0;j<parts.length;j++)kv=parts[j].trim().split("="),parsed[kv[0].trim()]=kv[1];return parsed},SDPUtils.writeFmtp=function(codec){var line="",pt=codec.payloadType;if(void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),codec.parameters&&Object.keys(codec.parameters).length){var params=[];Object.keys(codec.parameters).forEach(function(param){params.push(param+"="+codec.parameters[param])}),line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line},SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}},SDPUtils.writeRtcpFb=function(codec){var lines="",pt=codec.payloadType;return void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),codec.rtcpFeedback&&codec.rtcpFeedback.length&&codec.rtcpFeedback.forEach(function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+" "+fb.parameter+"\r\n"}),lines},SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" "),parts={ssrc:parseInt(line.substr(7,sp-7),10)},colon=line.indexOf(":",sp);return colon>-1?(parts.attribute=line.substr(sp+1,colon-sp-1),parts.value=line.substr(colon+1)):parts.attribute=line.substr(sp+1),parts},SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);lines=lines.concat(SDPUtils.splitLines(sessionpart));var fpLine=lines.filter(function(line){return 0===line.indexOf("a=fingerprint:")})[0].substr(14);return{role:"auto",fingerprints:[{algorithm:fpLine.split(" ")[0],value:fpLine.split(" ")[1]}]}},SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";return params.fingerprints.forEach(function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"}),sdp},SDPUtils.getIceParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);return lines=lines.concat(SDPUtils.splitLines(sessionpart)),{usernameFragment:lines.filter(function(line){return 0===line.indexOf("a=ice-ufrag:")})[0].substr(12),password:lines.filter(function(line){return 0===line.indexOf("a=ice-pwd:")})[0].substr(10)}},SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\na=ice-pwd:"+params.password+"\r\n"},SDPUtils.parseRtpParameters=function(mediaSection){for(var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},lines=SDPUtils.splitLines(mediaSection),mline=lines[0].split(" "),i=3;i<mline.length;i++){var pt=mline[i],rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline),fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");switch(codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{},codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb),description.codecs.push(codec),codec.name.toUpperCase()){case"RED":case"ULPFEC":description.fecMechanisms.push(codec.name.toUpperCase())}}}return SDPUtils.matchPrefix(mediaSection,"a=extmap:").forEach(function(line){description.headerExtensions.push(SDPUtils.parseExtmap(line))}),description},SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";return sdp+="m="+kind+" ",sdp+=caps.codecs.length>0?"9":"0",sdp+=" UDP/TLS/RTP/SAVPF ",sdp+=caps.codecs.map(function(codec){return void 0!==codec.preferredPayloadType?codec.preferredPayloadType:codec.payloadType}).join(" ")+"\r\n",sdp+="c=IN IP4 0.0.0.0\r\n",sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n",caps.codecs.forEach(function(codec){sdp+=SDPUtils.writeRtpMap(codec),sdp+=SDPUtils.writeFmtp(codec),sdp+=SDPUtils.writeRtcpFb(codec)}),sdp+="a=rtcp-mux\r\n"},SDPUtils.parseRtpEncodingParameters=function(mediaSection){var secondarySsrc,encodingParameters=[],description=SDPUtils.parseRtpParameters(mediaSection),hasRed=-1!==description.fecMechanisms.indexOf("RED"),hasUlpfec=-1!==description.fecMechanisms.indexOf("ULPFEC"),ssrcs=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return"cname"===parts.attribute}),primarySsrc=ssrcs.length>0&&ssrcs[0].ssrc,flows=SDPUtils.matchPrefix(mediaSection,"a=ssrc-group:FID").map(function(line){var parts=line.split(" ");return parts.shift(),parts.map(function(part){return parseInt(part,10)})});flows.length>0&&flows[0].length>1&&flows[0][0]===primarySsrc&&(secondarySsrc=flows[0][1]),description.codecs.forEach(function(codec){if("RTX"===codec.name.toUpperCase()&&codec.parameters.apt){var encParam={ssrc:primarySsrc,codecPayloadType:parseInt(codec.parameters.apt,10),rtx:{ssrc:secondarySsrc}};encodingParameters.push(encParam),hasRed&&(encParam=JSON.parse(JSON.stringify(encParam)),encParam.fec={ssrc:secondarySsrc,mechanism:hasUlpfec?"red+ulpfec":"red"},encodingParameters.push(encParam))}}),0===encodingParameters.length&&primarySsrc&&encodingParameters.push({ssrc:primarySsrc});var bandwidth=SDPUtils.matchPrefix(mediaSection,"b=");return bandwidth.length&&(0===bandwidth[0].indexOf("b=TIAS:")?bandwidth=parseInt(bandwidth[0].substr(7),10):0===bandwidth[0].indexOf("b=AS:")&&(bandwidth=parseInt(bandwidth[0].substr(5),10)),encodingParameters.forEach(function(params){params.maxBitrate=bandwidth})),encodingParameters},SDPUtils.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);if(sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters()),sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),"offer"===type?"actpass":"active"),sdp+="a=mid:"+transceiver.mid+"\r\n",transceiver.rtpSender&&transceiver.rtpReceiver?sdp+="a=sendrecv\r\n":transceiver.rtpSender?sdp+="a=sendonly\r\n":transceiver.rtpReceiver?sdp+="a=recvonly\r\n":sdp+="a=inactive\r\n",transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid,sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid}return sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n"},SDPUtils.getDirection=function(mediaSection,sessionpart){for(var lines=SDPUtils.splitLines(mediaSection),i=0;i<lines.length;i++)switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2)}return sessionpart?SDPUtils.getDirection(sessionpart):"sendrecv"},module.exports=SDPUtils},{}],13:[function(require,module,exports){"use strict";var SDPUtils=require("./edge_sdp"),logging=require("../utils").log,edgeShim={shimPeerConnection:function(){window.RTCIceGatherer&&(window.RTCIceCandidate||(window.RTCIceCandidate=function(args){return args}),window.RTCSessionDescription||(window.RTCSessionDescription=function(args){return args})),window.RTCPeerConnection=function(config){var self=this,_eventTarget=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(method){self[method]=_eventTarget[method].bind(_eventTarget)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return self.localStreams},this.getRemoteStreams=function(){return self.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},config&&config.iceTransportPolicy)switch(config.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=config.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}config&&config.iceServers&&(this.iceOptions.iceServers=config.iceServers.filter(function(server){return!(!server||!server.urls)&&(server.urls=server.urls.filter(function(url){return 0===url.indexOf("turn:")&&-1!==url.indexOf("transport=udp")})[0],!!server.urls)})),this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var self=this,sections=SDPUtils.splitSections(self.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(event){if(event.candidate&&0!==Object.keys(event.candidate).length)-1===event.candidate.candidate.indexOf("typ endOfCandidates")&&(sections[event.candidate.sdpMLineIndex+1]+="a="+event.candidate.candidate+"\r\n");else for(var j=1;j<sections.length;j++)-1===sections[j].indexOf("\r\na=end-of-candidates\r\n")&&(sections[j]+="a=end-of-candidates\r\n");if(self.localDescription.sdp=sections.join(""),self.dispatchEvent(event),null!==self.onicecandidate&&self.onicecandidate(event),!event.candidate&&"complete"!==self.iceGatheringState){self.transceivers.every(function(transceiver){return transceiver.iceGatherer&&"completed"===transceiver.iceGatherer.state})&&(self.iceGatheringState="complete")}}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.addStream=function(stream){this.localStreams.push(stream.clone()),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(stream){var idx=this.localStreams.indexOf(stream);idx>-1&&(this.localStreams.splice(idx,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype._getCommonCapabilities=function(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]};return localCapabilities.codecs.forEach(function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate&&lCodec.numChannels===rCodec.numChannels){commonCapabilities.codecs.push(rCodec);break}}}),localCapabilities.headerExtensions.forEach(function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}}),commonCapabilities},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(mid,sdpMLineIndex){var self=this,iceGatherer=new RTCIceGatherer(self.iceOptions),iceTransport=new RTCIceTransport(iceGatherer);iceGatherer.onlocalcandidate=function(evt){var event=new Event("icecandidate");event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate,end=!cand||0===Object.keys(cand).length;end?(void 0===iceGatherer.state&&(iceGatherer.state="completed"),event.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"):(cand.component="RTCP"===iceTransport.component?2:1,event.candidate.candidate=SDPUtils.writeCandidate(cand));var complete=self.transceivers.every(function(transceiver){return transceiver.iceGatherer&&"completed"===transceiver.iceGatherer.state});switch(self.iceGatheringState){case"new":self._localIceCandidatesBuffer.push(event),end&&complete&&self._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":self._emitBufferedCandidates(),self.dispatchEvent(event),null!==self.onicecandidate&&self.onicecandidate(event),complete&&(self.dispatchEvent(new Event("icecandidate")),null!==self.onicecandidate&&self.onicecandidate(new Event("icecandidate")),self.iceGatheringState="complete")}},iceTransport.onicestatechange=function(){self._updateConnectionState()};var dtlsTransport=new RTCDtlsTransport(iceTransport);return dtlsTransport.ondtlsstatechange=function(){self._updateConnectionState()},dtlsTransport.onerror=function(){dtlsTransport.state="failed",self._updateConnectionState()},{iceGatherer:iceGatherer,iceTransport:iceTransport,dtlsTransport:dtlsTransport}},window.RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=this._getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);send&&transceiver.rtpSender&&(params.encodings=transceiver.sendEncodingParameters,params.rtcp={cname:SDPUtils.localCName},transceiver.recvEncodingParameters.length&&(params.rtcp.ssrc=transceiver.recvEncodingParameters[0].ssrc),transceiver.rtpSender.send(params)),recv&&transceiver.rtpReceiver&&(params.encodings=transceiver.recvEncodingParameters,params.rtcp={cname:transceiver.cname},transceiver.sendEncodingParameters.length&&(params.rtcp.ssrc=transceiver.sendEncodingParameters[0].ssrc),transceiver.rtpReceiver.receive(params))},window.RTCPeerConnection.prototype.setLocalDescription=function(description){var sections,sessionpart,self=this;switch("offer"===description.type?this._pendingOffer&&(sections=SDPUtils.splitSections(description.sdp),sessionpart=sections.shift(),sections.forEach(function(mediaSection,sdpMLineIndex){var caps=SDPUtils.parseRtpParameters(mediaSection);self._pendingOffer[sdpMLineIndex].localCapabilities=caps}),this.transceivers=this._pendingOffer,delete this._pendingOffer):"answer"===description.type&&(sections=SDPUtils.splitSections(self.remoteDescription.sdp),sessionpart=sections.shift(),sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver=self.transceivers[sdpMLineIndex],iceGatherer=transceiver.iceGatherer,iceTransport=transceiver.iceTransport,dtlsTransport=transceiver.dtlsTransport,localCapabilities=transceiver.localCapabilities,remoteCapabilities=transceiver.remoteCapabilities;if("0"!==mediaSection.split("\n",1)[0].split(" ",2)[1]){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);iceTransport.start(iceGatherer,remoteIceParameters,"controlled");var remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);dtlsTransport.start(remoteDtlsParameters);var params=self._getCommonCapabilities(localCapabilities,remoteCapabilities);self._transceive(transceiver,params.codecs.length>0,!1)}})),this.localDescription={type:description.type,sdp:description.sdp},description.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+description.type+'"')}var hasCallback=arguments.length>1&&"function"==typeof arguments[1];if(hasCallback){var cb=arguments[1];window.setTimeout(function(){cb(),"new"===self.iceGatheringState&&(self.iceGatheringState="gathering"),self._emitBufferedCandidates()},0)}var p=Promise.resolve();return p.then(function(){hasCallback||("new"===self.iceGatheringState&&(self.iceGatheringState="gathering"),window.setTimeout(self._emitBufferedCandidates.bind(self),500))}),p},window.RTCPeerConnection.prototype.setRemoteDescription=function(description){var self=this,stream=new MediaStream,receiverList=[],sections=SDPUtils.splitSections(description.sdp),sessionpart=sections.shift();switch(sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver,iceGatherer,iceTransport,dtlsTransport,rtpSender,rtpReceiver,sendEncodingParameters,recvEncodingParameters,localCapabilities,track,remoteIceParameters,remoteDtlsParameters,lines=SDPUtils.splitLines(mediaSection),mline=lines[0].substr(2).split(" "),kind=mline[0],rejected="0"===mline[1],direction=SDPUtils.getDirection(mediaSection,sessionpart),remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);rejected||(remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart),remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart)),recvEncodingParameters=SDPUtils.parseRtpEncodingParameters(mediaSection);var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:");mid=mid.length?mid[0].substr(6):SDPUtils.generateIdentifier();var cname,remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(obj){return"cname"===obj.attribute})[0];remoteSsrc&&(cname=remoteSsrc.value);var isComplete=SDPUtils.matchPrefix(mediaSection,"a=end-of-candidates").length>0,cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map(function(cand){return SDPUtils.parseCandidate(cand)}).filter(function(cand){return"1"===cand.component});if("offer"!==description.type||rejected)"answer"!==description.type||rejected||(transceiver=self.transceivers[sdpMLineIndex],iceGatherer=transceiver.iceGatherer,iceTransport=transceiver.iceTransport,dtlsTransport=transceiver.dtlsTransport,rtpSender=transceiver.rtpSender,rtpReceiver=transceiver.rtpReceiver,sendEncodingParameters=transceiver.sendEncodingParameters,localCapabilities=transceiver.localCapabilities,self.transceivers[sdpMLineIndex].recvEncodingParameters=recvEncodingParameters,self.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities,self.transceivers[sdpMLineIndex].cname=cname,isComplete&&iceTransport.setRemoteCandidates(cands),iceTransport.start(iceGatherer,remoteIceParameters,"controlling"),dtlsTransport.start(remoteDtlsParameters),self._transceive(transceiver,"sendrecv"===direction||"recvonly"===direction,"sendrecv"===direction||"sendonly"===direction),!rtpReceiver||"sendrecv"!==direction&&"sendonly"!==direction?delete transceiver.rtpReceiver:(track=rtpReceiver.track,receiverList.push([track,rtpReceiver]),stream.addTrack(track)));else{var transports=self._createIceAndDtlsTransports(mid,sdpMLineIndex);if(isComplete&&transports.iceTransport.setRemoteCandidates(cands),localCapabilities=RTCRtpReceiver.getCapabilities(kind),sendEncodingParameters=[{ssrc:1001*(2*sdpMLineIndex+2)}],rtpReceiver=new RTCRtpReceiver(transports.dtlsTransport,kind),track=rtpReceiver.track,receiverList.push([track,rtpReceiver]),stream.addTrack(track),self.localStreams.length>0&&self.localStreams[0].getTracks().length>=sdpMLineIndex){var localtrack=self.localStreams[0].getTracks()[sdpMLineIndex];rtpSender=new RTCRtpSender(localtrack,transports.dtlsTransport)}self.transceivers[sdpMLineIndex]={iceGatherer:transports.iceGatherer,iceTransport:transports.iceTransport,dtlsTransport:transports.dtlsTransport,localCapabilities:localCapabilities,remoteCapabilities:remoteCapabilities,rtpSender:rtpSender,rtpReceiver:rtpReceiver,kind:kind,mid:mid,cname:cname,sendEncodingParameters:sendEncodingParameters,recvEncodingParameters:recvEncodingParameters},self._transceive(self.transceivers[sdpMLineIndex],!1,"sendrecv"===direction||"sendonly"===direction)}}),this.remoteDescription={type:description.type,sdp:description.sdp},description.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+description.type+'"')}return stream.getTracks().length&&(self.remoteStreams.push(stream),window.setTimeout(function(){var event=new Event("addstream");event.stream=stream,self.dispatchEvent(event),null!==self.onaddstream&&window.setTimeout(function(){self.onaddstream(event)},0),receiverList.forEach(function(item){var track=item[0],receiver=item[1],trackEvent=new Event("track");trackEvent.track=track,trackEvent.receiver=receiver,trackEvent.streams=[stream],self.dispatchEvent(event),null!==self.ontrack&&window.setTimeout(function(){self.ontrack(trackEvent)},0)})},0)),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(transceiver){transceiver.iceTransport&&transceiver.iceTransport.stop(),transceiver.dtlsTransport&&transceiver.dtlsTransport.stop(),transceiver.rtpSender&&transceiver.rtpSender.stop(),transceiver.rtpReceiver&&transceiver.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState;var event=new Event("signalingstatechange");this.dispatchEvent(event),null!==this.onsignalingstatechange&&this.onsignalingstatechange(event)},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var event=new Event("negotiationneeded");this.dispatchEvent(event),null!==this.onnegotiationneeded&&this.onnegotiationneeded(event)},window.RTCPeerConnection.prototype._updateConnectionState=function(){var newState,self=this,states={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach(function(transceiver){states[transceiver.iceTransport.state]++,states[transceiver.dtlsTransport.state]++}),states.connected+=states.completed,newState="new",states.failed>0?newState="failed":states.connecting>0||states.checking>0?newState="connecting":states.disconnected>0?newState="disconnected":states.new>0?newState="new":(states.connected>0||states.completed>0)&&(newState="connected"),newState!==self.iceConnectionState){self.iceConnectionState=newState;var event=new Event("iceconnectionstatechange");this.dispatchEvent(event),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(event)}},window.RTCPeerConnection.prototype.createOffer=function(){var self=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var offerOptions;1===arguments.length&&"function"!=typeof arguments[0]?offerOptions=arguments[0]:3===arguments.length&&(offerOptions=arguments[2]);var tracks=[],numAudioTracks=0,numVideoTracks=0;if(this.localStreams.length&&(numAudioTracks=this.localStreams[0].getAudioTracks().length,numVideoTracks=this.localStreams[0].getVideoTracks().length),offerOptions){if(offerOptions.mandatory||offerOptions.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==offerOptions.offerToReceiveAudio&&(numAudioTracks=offerOptions.offerToReceiveAudio),void 0!==offerOptions.offerToReceiveVideo&&(numVideoTracks=offerOptions.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(track){tracks.push({kind:track.kind,track:track,wantReceive:"audio"===track.kind?numAudioTracks>0:numVideoTracks>0}),"audio"===track.kind?numAudioTracks--:"video"===track.kind&&numVideoTracks--});numAudioTracks>0||numVideoTracks>0;)numAudioTracks>0&&(tracks.push({kind:"audio",wantReceive:!0}),numAudioTracks--),numVideoTracks>0&&(tracks.push({kind:"video",wantReceive:!0}),numVideoTracks--);var sdp=SDPUtils.writeSessionBoilerplate(),transceivers=[];tracks.forEach(function(mline,sdpMLineIndex){var rtpSender,rtpReceiver,track=mline.track,kind=mline.kind,mid=SDPUtils.generateIdentifier(),transports=self._createIceAndDtlsTransports(mid,sdpMLineIndex),localCapabilities=RTCRtpSender.getCapabilities(kind),sendEncodingParameters=[{ssrc:1001*(2*sdpMLineIndex+1)}];track&&(rtpSender=new RTCRtpSender(track,transports.dtlsTransport)),mline.wantReceive&&(rtpReceiver=new RTCRtpReceiver(transports.dtlsTransport,kind)),transceivers[sdpMLineIndex]={iceGatherer:transports.iceGatherer,iceTransport:transports.iceTransport,dtlsTransport:transports.dtlsTransport,localCapabilities:localCapabilities,remoteCapabilities:null,rtpSender:rtpSender,rtpReceiver:rtpReceiver,kind:kind,mid:mid,sendEncodingParameters:sendEncodingParameters,recvEncodingParameters:null};var transceiver=transceivers[sdpMLineIndex];sdp+=SDPUtils.writeMediaSection(transceiver,transceiver.localCapabilities,"offer",self.localStreams[0])}),this._pendingOffer=transceivers;var desc=new RTCSessionDescription({type:"offer",sdp:sdp});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,desc),Promise.resolve(desc)},window.RTCPeerConnection.prototype.createAnswer=function(){var self=this,sdp=SDPUtils.writeSessionBoilerplate();this.transceivers.forEach(function(transceiver){var commonCapabilities=self._getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);sdp+=SDPUtils.writeMediaSection(transceiver,commonCapabilities,"answer",self.localStreams[0])});var desc=new RTCSessionDescription({type:"answer",sdp:sdp});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,desc),Promise.resolve(desc)},window.RTCPeerConnection.prototype.addIceCandidate=function(candidate){var mLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid)for(var i=0;i<this.transceivers.length;i++)if(this.transceivers[i].mid===candidate.sdpMid){mLineIndex=i;break}var transceiver=this.transceivers[mLineIndex];if(transceiver){var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if("tcp"===cand.protocol&&0===cand.port)return;if("1"!==cand.component)return;"endOfCandidates"===cand.type&&(cand={}),transceiver.iceTransport.addRemoteCandidate(cand);var sections=SDPUtils.splitSections(this.remoteDescription.sdp);sections[mLineIndex+1]+=(cand.type?candidate.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=sections.join("")}return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var promises=[];this.transceivers.forEach(function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(method){transceiver[method]&&promises.push(transceiver[method].getStats())})});var cb=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(resolve){var results={};Promise.all(promises).then(function(res){res.forEach(function(result){Object.keys(result).forEach(function(id){results[id]=result[id]})}),cb&&window.setTimeout(cb,0,results),resolve(results)})})}},attachMediaStream:function(element,stream){logging("DEPRECATED, attachMediaStream will soon be removed."),element.srcObject=stream},reattachMediaStream:function(to,from){logging("DEPRECATED, reattachMediaStream will soon be removed."),to.srcObject=from.srcObject}};module.exports={shimPeerConnection:edgeShim.shimPeerConnection,attachMediaStream:edgeShim.attachMediaStream,reattachMediaStream:edgeShim.reattachMediaStream}},{"../utils":17,"./edge_sdp":12}],14:[function(require,module,exports){"use strict";var logging=require("../utils").log,browserDetails=require("../utils").browserDetails,firefoxShim={shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(f){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=f),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(track){var event=new Event("track");event.track=track,event.receiver={track:track},event.streams=[e.stream],this.dispatchEvent(event)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(stream){this.mozSrcObject=stream}}))},shimPeerConnection:function(){window.RTCPeerConnection||(window.RTCPeerConnection=function(pcConfig,pcConstraints){if(browserDetails.version<38&&pcConfig&&pcConfig.iceServers){for(var newIceServers=[],i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];if(server.hasOwnProperty("urls"))for(var j=0;j<server.urls.length;j++){var newServer={url:server.urls[j]};0===server.urls[j].indexOf("turn")&&(newServer.username=server.username,newServer.credential=server.credential),newIceServers.push(newServer)}else newIceServers.push(pcConfig.iceServers[i])}pcConfig.iceServers=newIceServers}return new mozRTCPeerConnection(pcConfig,pcConstraints)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){return arguments[0]=new("addIceCandidate"===method?RTCIceCandidate:RTCSessionDescription)(arguments[0]),nativeMethod.apply(this,arguments)}})},shimGetUserMedia:function(){var getUserMedia_=function(constraints,onSuccess,onError){var constraintsToFF37_=function(c){if("object"!=typeof c||c.require)return c;var require=[];return Object.keys(c).forEach(function(key){if("require"!==key&&"advanced"!==key&&"mediaSource"!==key){var r=c[key]="object"==typeof c[key]?c[key]:{ideal:c[key]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||require.push(key),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:c[key]=r.exact,delete r.exact),void 0!==r.ideal){c.advanced=c.advanced||[];var oc={};"number"==typeof r.ideal?oc[key]={min:r.ideal,max:r.ideal}:oc[key]=r.ideal,c.advanced.push(oc),delete r.ideal,Object.keys(r).length||delete c[key]}}}),require.length&&(c.require=require),c};return constraints=JSON.parse(JSON.stringify(constraints)),browserDetails.version<38&&(logging("spec: "+JSON.stringify(constraints)),constraints.audio&&(constraints.audio=constraintsToFF37_(constraints.audio)),constraints.video&&(constraints.video=constraintsToFF37_(constraints.video)),logging("ff37: "+JSON.stringify(constraints))),navigator.mozGetUserMedia(constraints,onSuccess,onError)};navigator.getUserMedia=getUserMedia_;var getUserMediaPromise_=function(constraints){return new Promise(function(resolve,reject){navigator.getUserMedia(constraints,resolve,reject)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:getUserMediaPromise_,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(resolve){resolve([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},browserDetails.version<41){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}},attachMediaStream:function(element,stream){logging("DEPRECATED, attachMediaStream will soon be removed."),element.srcObject=stream},reattachMediaStream:function(to,from){logging("DEPRECATED, reattachMediaStream will soon be removed."),to.srcObject=from.srcObject}};module.exports={shimOnTrack:firefoxShim.shimOnTrack,shimSourceObject:firefoxShim.shimSourceObject,shimPeerConnection:firefoxShim.shimPeerConnection,shimGetUserMedia:require("./getusermedia"),attachMediaStream:firefoxShim.attachMediaStream,reattachMediaStream:firefoxShim.reattachMediaStream}},{"../utils":17,"./getusermedia":15}],15:[function(require,module,exports){"use strict";var logging=require("../utils").log,browserDetails=require("../utils").browserDetails;module.exports=function(){
var getUserMedia_=function(constraints,onSuccess,onError){var constraintsToFF37_=function(c){if("object"!=typeof c||c.require)return c;var require=[];return Object.keys(c).forEach(function(key){if("require"!==key&&"advanced"!==key&&"mediaSource"!==key){var r=c[key]="object"==typeof c[key]?c[key]:{ideal:c[key]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||require.push(key),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:c[key]=r.exact,delete r.exact),void 0!==r.ideal){c.advanced=c.advanced||[];var oc={};"number"==typeof r.ideal?oc[key]={min:r.ideal,max:r.ideal}:oc[key]=r.ideal,c.advanced.push(oc),delete r.ideal,Object.keys(r).length||delete c[key]}}}),require.length&&(c.require=require),c};return constraints=JSON.parse(JSON.stringify(constraints)),browserDetails.version<38&&(logging("spec: "+JSON.stringify(constraints)),constraints.audio&&(constraints.audio=constraintsToFF37_(constraints.audio)),constraints.video&&(constraints.video=constraintsToFF37_(constraints.video)),logging("ff37: "+JSON.stringify(constraints))),navigator.mozGetUserMedia(constraints,onSuccess,onError)};navigator.getUserMedia=getUserMedia_;var getUserMediaPromise_=function(constraints){return new Promise(function(resolve,reject){navigator.getUserMedia(constraints,resolve,reject)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:getUserMediaPromise_,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(resolve){resolve([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},browserDetails.version<41){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}}},{"../utils":17}],16:[function(require,module,exports){"use strict";var safariShim={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};module.exports={shimGetUserMedia:safariShim.shimGetUserMedia}},{}],17:[function(require,module,exports){"use strict";var logDisabled_=!1,utils={disableLog:function(bool){return"boolean"!=typeof bool?new Error("Argument type: "+typeof bool+". Please use a boolean."):(logDisabled_=bool,bool?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==typeof window){if(logDisabled_)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)},detectBrowser:function(){var result={};if(result.browser=null,result.version=null,result.minVersion=null,"undefined"==typeof window||!window.navigator)return result.browser="Not a browser.",result;if(navigator.mozGetUserMedia)result.browser="firefox",result.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),result.minVersion=31;else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)result.browser="chrome",result.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),result.minVersion=38;else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return result.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",result;result.browser="safari",result.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1),result.minVersion=602}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return result.browser="Not a supported browser.",result;result.browser="edge",result.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),result.minVersion=10547}return result.version<result.minVersion&&utils.log("Browser: "+result.browser+" Version: "+result.version+" < minimum supported version: "+result.minVersion+"\n some things might not work!"),result}};module.exports={log:utils.log,disableLog:utils.disableLog,browserDetails:utils.detectBrowser(),extractVersion:utils.extractVersion}},{}],18:[function(require,module,exports){"use strict";function DiyaNode(){EventEmitter.call(this),this._user=null,this._authenticated=null,this._pass=null,this._status="closed",this._addr=null,this._socket=null,this._nextId=0,this._connectionDeferred=null,this._disconnectionDeferred=null,this._pendingMessages=[],this._peers=[],this._reconnectTimeout=1e3,this._connectTimeout=5e3}function SocketHandler(WSocket,addr,timeout){var that=this;this.addr=addr,WSocket?this._WSocket=WSocket:this._WSocket||(this._WSocket=window.WebSocket),WSocket=this._WSocket,this._status="opening";try{this._socket=0===addr.indexOf("wss://")?new WSocket(addr,void 0,{rejectUnauthorized:!1}):new WSocket(addr),this._socketOpenCallback=this._onopen.bind(this),this._socketCloseCallback=this._onclose.bind(this),this._socketMessageCallback=this._onmessage.bind(this),this._socketErrorCallback=this._onerror.bind(this),this._socket.addEventListener("open",this._socketOpenCallback),this._socket.addEventListener("close",this._socketCloseCallback),this._socket.addEventListener("message",this._socketMessageCallback),this._socket.addEventListener("error",this._socketErrorCallback),this._socket.addEventListener("error",function(err){Logger.error("[WS] error : "+JSON.stringify(err)),that._socket.close()}),setTimeout(function(){"opened"!==that._status&&"closed"!==that._status&&(Logger.log("d1: "+that.addr+" timed out while connecting"),that.close(),that.emit("timeout",that._socket))},timeout)}catch(e){throw Logger.error(e.stack),that.close(),e}}var isBrowser=!("undefined"==typeof window),UNIXSocketHandler=void 0;if(isBrowser)var Q=window.Q;else{var Q=require("q");UNIXSocketHandler=require("./UNIXSocketHandler")}var EventEmitter=require("node-event-emitter"),inherits=require("inherits"),Logger={log:function(message){},error:function(message){}};inherits(DiyaNode,EventEmitter),DiyaNode.prototype.user=function(user){if(!user)return this._user;this._user=user},DiyaNode.prototype.authenticated=function(authenticated){if(void 0===authenticated)return this._authenticated;this._authenticated=authenticated},DiyaNode.prototype.pass=function(pass){if(void 0===pass)return this._pass;this._pass=pass},DiyaNode.prototype.addr=function(){return this._addr},DiyaNode.prototype.peers=function(){return this._peers},DiyaNode.prototype.self=function(){return this._self},DiyaNode.prototype.setSecured=function(bSecured){this._secured=!1!==bSecured},DiyaNode.prototype.setWSocket=function(WSocket){this._WSocket=WSocket},DiyaNode.prototype.connect=function(addr,WSocket){var _this=this;if(this.bDontReconnect=!1,addr.startsWith("unix://")){if(this._addr===addr){if(console.log("[SDK/DiyaNode] Address is identical to our address..."),"opened"===this._status)return console.log("[SDK/DiyaNode] ... and the connection is still openened, returning it."),Q(this.self());if(this._connectionDeferred&&this._connectionDeferred.promise&&this._connectionDeferred.promise.isPending())return console.log("[SDK/DiyaNode]... and the connection is pending, so returning the pending connection."),this._connectionDeferred.promise}return this.close().then(function(_){_this._addr=addr,_this._connectionDeferred=Q.defer(),Logger.log("d1: connect to "+_this._addr);var sock=new UNIXSocketHandler(_this._addr.substr("unix://".length),_this._connectTimeout);return _this._socketHandler||(_this._socketHandler=sock),_this._onopening(),sock.on("open",function(_){if(_this._socketHandler!==sock)return void console.log("[SDK/DiyaNode] Socket responded but already connected to a different one");_this._status="opened",_this._setupPingResponse()}),sock.on("closing",function(_){_this._socketHandler===sock&&_this._onclosing()}),sock.on("close",function(_){_this._socketHandler===sock&&(_this._socketHandler=null,_this._status="closed",_this._stopPingResponse(),_this._onclose(),_this._connectionDeferred&&(_this._connectionDeferred.reject("closed"),_this._connectionDeferred=null))}),sock.on("error",function(error){_this._socketHandler===sock&&_this._onerror(error)}),sock.on("timeout",function(_){_this._socketHandler===sock&&(_this._socketHandler=null,_this._status="closed",_this._connectionDeferred&&(_this._connectionDeferred.reject("closed"),_this._connectionDeferred=null))}),sock.on("message",_this._onmessage.bind(_this)),_this._connectionDeferred.promise})}if(void 0!==WSocket?this._WSocket=WSocket:void 0===this._WSocket&&(this._WSocket=window.WebSocket),WSocket=this._WSocket,addr.startsWith("ws://")&&this._secured)return Q.reject("Please use a secured connection ("+addr+")");if(addr.startsWith("wss://")&&!1===this._secured)return Q.reject("Please use a non-secured connection ("+addr+")");if(addr.startsWith("ws://")||addr.startsWith("wss://")||(addr=this._secured?"wss://"+addr:"ws://"+addr),this._addr===addr){if("opened"===this._status)return Q(this.self());if(this._connectionDeferred&&this._connectionDeferred.promise&&this._connectionDeferred.promise.isPending())return this._connectionDeferred.promise}return this.close().then(function(_){_this._addr=addr,_this._connectionDeferred=Q.defer(),Logger.log("d1: connect to "+_this._addr);var sock=new SocketHandler(WSocket,_this._addr,_this._connectTimeout);return _this._socketHandler||(_this._socketHandler=sock),_this._onopening(),sock.on("open",function(_){if(_this._socketHandler!==sock)return void console.log("[d1] Websocket responded but already connected to a different one");_this._socketHandler=sock,_this._status="opened",_this._setupPingResponse()}),sock.on("closing",function(_){_this._socketHandler===sock&&_this._onclosing()}),sock.on("close",function(_){_this._socketHandler===sock&&(_this._socketHandler=null,_this._status="closed",_this._stopPingResponse(),_this._onclose(),_this._connectionDeferred&&(_this._connectionDeferred.reject("closed"),_this._connectionDeferred=null))}),sock.on("error",function(error){_this._socketHandler===sock&&_this._onerror(error)}),sock.on("timeout",function(_){_this._socketHandler===sock&&(_this._socketHandler=null,_this._status="closed",_this._connectionDeferred&&(_this._connectionDeferred.reject("closed"),_this._connectionDeferred=null))}),sock.on("message",_this._onmessage.bind(_this)),_this._connectionDeferred.promise})},DiyaNode.prototype.disconnect=function(){return this.bDontReconnect=!0,this.close()},DiyaNode.prototype.close=function(){return this._stopPingResponse(),this._socketHandler?this._socketHandler.close():Q()},DiyaNode.prototype.isConnected=function(){return this._socketHandler&&this._socketHandler.isConnected()},DiyaNode.prototype.request=function(params,callback,timeout,options){var that=this;if(options||(options={}),params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}if(!params.service)return Logger.error("No service defined for request !"),!1;var message=this._createMessage(params,"Request");return this._appendMessage(message,callback),"function"==typeof options.callback_partial&&(this._pendingMessages[message.id].callback_partial=options.callback_partial),message.options=options,!isNaN(timeout)&&timeout>0&&setTimeout(function(){var handler=that._removeMessage(message.id);handler&&that._notifyListener(handler,"Timeout exceeded ("+timeout+"ms) !")},timeout),!!this._send(message)||(this._removeMessage(message.id),console.error("Cannot send request !"),!1)},DiyaNode.prototype.subscribe=function(params,callback){if(params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}if(!params.service)return Logger.error("No service defined for subscription !"),-1;var message=this._createMessage(params,"Subscription");return this._appendMessage(message,callback),this._send(message)?message.id:(this._removeMessage(message.id),Logger.error("Cannot send subscription !"),-1)},DiyaNode.prototype.unsubscribe=function(subId){if(this._pendingMessages[subId]&&"Subscription"===this._pendingMessages[subId].type){var subscription=this._removeMessage(subId),message=this._createMessage({target:subscription.target,data:{subId:subId}},"Unsubscribe");return!!this._send(message)||(Logger.error("Cannot send unsubscribe !"),!1)}return!1},DiyaNode.prototype._appendMessage=function(message,callback){this._pendingMessages[message.id]={callback:callback,type:message.type,target:message.target}},DiyaNode.prototype._removeMessage=function(messageId){var handler=this._pendingMessages[messageId];return handler?(delete this._pendingMessages[messageId],handler):null},DiyaNode.prototype._clearMessages=function(err,data){for(var messageId in this._pendingMessages){var handler=this._removeMessage(messageId);this._notifyListener(handler,err,data)}},DiyaNode.prototype._clearPeers=function(){for(;this._peers.length;)this.emit("peer-disconnected",this._peers.pop())},DiyaNode.prototype._getMessageHandler=function(messageId){var handler=this._pendingMessages[messageId];return handler||null},DiyaNode.prototype._notifyListener=function(handler,error,data){if(handler&&"function"==typeof handler.callback){error=error||null,data=data||null;try{handler.callback(error,data)}catch(e){console.log((e.stack,e.stack))}}},DiyaNode.prototype._send=function(message){return this._socketHandler&&this._socketHandler.send(message)},DiyaNode.prototype._setupPingResponse=function(){function checkPing(){(new Date).getTime()-that._lastPing>that._pingTimeout?(that._forceClose(),Logger.log("d1:  timed out !")):(Logger.log("d1: last ping ok"),that._pingSetTimeoutId=setTimeout(checkPing,Math.round(that._pingTimeout/2.1)))}var that=this;this._pingTimeout=15e3,this._lastPing=(new Date).getTime(),checkPing()},DiyaNode.prototype._stopPingResponse=function(){clearTimeout(this._pingSetTimeoutId)},DiyaNode.prototype._forceClose=function(){this._socketHandler.close(),this._onclose()},DiyaNode.prototype._onmessage=function(message){if(isNaN(message.id))return this._handleInternalMessage(message);var handler=this._getMessageHandler(message.id);if(handler)switch(handler.type){case"Request":this._handleRequest(handler,message);break;case"Subscription":this._handleSubscription(handler,message)}},DiyaNode.prototype._onopening=function(){this.emit("opening",this)},DiyaNode.prototype._onerror=function(error){this.emit("error",new Error(error))},DiyaNode.prototype._onclosing=function(){this.emit("closing",this)},DiyaNode.prototype._onclose=function(){var that=this;this._clearMessages("PeerDisconnected"),this._clearPeers(),this.bDontReconnect||(Logger.log("d1: connection lost, try reconnecting"),setTimeout(function(){that.connect(that._addr,that._WSocket).catch(function(err){})},that._reconnectTimeout)),this.emit("close",this._addr)},DiyaNode.prototype._handleInternalMessage=function(message){switch(message.type){case"PeerConnected":this._handlePeerConnected(message);break;case"PeerDisconnected":this._handlePeerDisconnected(message);break;case"Handshake":this._handleHandshake(message);break;case"Ping":this._handlePing(message)}},DiyaNode.prototype._handlePing=function(message){message.type="Pong",this._lastPing=(new Date).getTime(),this._send(message)},DiyaNode.prototype._handleHandshake=function(message){if(void 0===message.peers||"string"!=typeof message.self)return void Logger.error("Missing arguments for Handshake message, dropping...");this._self=message.self;for(var i=0;i<message.peers.length;i++)this._peers.push(message.peers[i]),this.emit("peer-connected",message.peers[i]);this._connectionDeferred.resolve(this.self()),this.emit("open",this._addr),this._status="opened",this._connectionDeferred=null},DiyaNode.prototype._handlePeerConnected=function(message){if(void 0===message.peerId)return void Logger.error("Missing arguments for PeerConnected message, dropping...");this._peers.push(message.peerId),this.emit("peer-connected",message.peerId)},DiyaNode.prototype._handlePeerDisconnected=function(message){if(void 0===message.peerId)return void Logger.error("Missing arguments for PeerDisconnected Message, dropping...");for(var messageId in this._pendingMessages){var handler=this._getMessageHandler(messageId);handler&&handler.target===message.peerId&&(this._removeMessage(messageId),this._notifyListener(handler,"PeerDisconnected",null))}for(var i=this._peers.length-1;i>=0;i--)if(this._peers[i]===message.peerId){this._peers.splice(i,1);break}this.emit("peer-disconnected",message.peerId)},DiyaNode.prototype._handleRequest=function(handler,message){if("PartialAnswer"===message.type){if("function"==typeof this._pendingMessages[message.id].callback_partial){var error=message.error?message.error:null,data=message.data?message.data:null;this._pendingMessages[message.id].callback_partial(error,data)}}else this._removeMessage(message.id),this._notifyListener(handler,message.error,message.data)},DiyaNode.prototype._handleSubscription=function(handler,message){"closed"===message.result&&(this._removeMessage(message.id),message.error="SubscriptionClosed"),this._notifyListener(handler,message.error,message.data?message.data:null)},inherits(SocketHandler,EventEmitter),SocketHandler.prototype.close=function(){return this._disconnectionDeferred&&this._disconnectionDeferred.promise?this._disconnectionDeferred.promise:(this._disconnectionDeferred=Q.defer(),this._status="closing",this.emit("closing",this._socket),this._socket&&this._socket.close(),this._disconnectionDeferred.promise)},SocketHandler.prototype.send=function(message){try{var data=JSON.stringify(message)}catch(err){return console.error("Cannot serialize message"),!1}try{this._socket.send(data)}catch(err){return console.error("Cannot send message"),console.error(err),!1}return!0},SocketHandler.prototype.isConnected=function(){return this._socket.readyState==this._WSocket.OPEN&&"opened"===this._status},SocketHandler.prototype._onopen=function(){this._status="opened",this.emit("open",this._socket)},SocketHandler.prototype._onclose=function(evt){this._status="closed",this.unregisterCallbacks(),this.emit("close",this._socket),this._disconnectionDeferred&&this._disconnectionDeferred.promise&&this._disconnectionDeferred.resolve()},SocketHandler.prototype._onmessage=function(evt){try{var message=JSON.parse(evt.data);this.emit("message",message)}catch(err){throw Logger.error("[WS] cannot parse message, dropping..."),err}},SocketHandler.prototype._onerror=function(evt){this.emit("error",evt)},SocketHandler.prototype.unregisterCallbacks=function(){this._socket&&"function"==typeof this._socket.removeEventListener?(this._socket.removeEventListener("open",this._socketOpenCallback),this._socket.removeEventListener("close",this._socketCloseCallback),this._socket.removeEventListener("message",this._socketMessageCallback)):this._socket&&"function"==typeof this._socket.removeAllListeners&&this._socket.removeAllListeners()},DiyaNode.prototype._createMessage=function(params,type){return!params||!type||"Request"!==type&&"Subscription"!==type&&"Unsubscribe"!==type?null:{type:type,id:this._generateId(),service:params.service,target:params.target,func:params.func,obj:params.obj,data:params.data,bus:params.bus}},DiyaNode.prototype._generateId=function(){var id=this._nextId;return this._nextId++,id},module.exports=DiyaNode},{"./UNIXSocketHandler":20,inherits:3,"node-event-emitter":4,q:void 0}],19:[function(require,module,exports){"use strict";function newInstance(){var connection=new DiyaNode,d1inst=function(selector){return new DiyaSelector(selector,connection)};return d1inst.DiyaNode=DiyaNode,d1inst.DiyaSelector=DiyaSelector,d1inst.connect=function(addr,WSocket){return connection.connect(addr,WSocket)},d1inst.disconnect=function(){return connection.disconnect()},d1inst.isConnected=function(){return connection.isConnected()},d1inst.peers=function(){return connection.peers()},d1inst.self=function(){return connection.self()},d1inst.addr=function(){return connection.addr()},d1inst.user=function(){return connection.user()},d1inst.pass=function(){return connection.pass()},d1inst.isAuthenticated=function(){return connection.authenticated()},d1inst.parsePeer=function(addrStr){var peer={};return addrStr&&""!==addrStr?/^[0-9]*$/.test(addrStr)?peer.addr="ws://localhost:"+addrStr:"localhost"===addrStr?peer.addr="unix:///var/run/diya/diya-node.sock":IP_REGEX.test(addrStr)?(peer.addr="wss://"+addrStr+"/api",peer.addrNet="wss://"+addrStr+"/net"):IP_REGEX.test(addrStr.split(":")[0])&&/^[0-9]*$/.test(addrStr.split(":")[1])?peer.addr="ws://"+addrStr:0===addrStr.indexOf("wss://")||0===addrStr.indexOf("ws://")?peer.addr=addrStr:2===addrStr.split("/").length?(peer.addr="wss://"+addrStr+"/api",peer.addrNet="wss://"+addrStr+"/net",peer.name=addrStr.split("/")[1]):3===addrStr.split("/").length&&"api"===addrStr.split("/")[2]?(peer.addr="wss://"+addrStr,peer.addrNet="wss://"+addrStr.substr(0,addrStr.length-4),peer.name=addrStr.split("/")[1]):(peer.addr="wss://partnering-cloud.com/"+addrStr+"/api",peer.addrNet="wss://partnering-cloud.com/"+addrStr+"/net",peer.name=addrStr):(peer.addr="wss://localhost/api",peer.addrNet="wss://localhost/net"),peer},d1inst.tryConnect=function(servers,WSocket){function tc(i){d1inst.connect(servers[i],WSocket).then(function(e){return deferred.resolve(servers[i])}).catch(function(e){d1inst.disconnect().then(function(){if(!(++i<servers.length))return deferred.reject("Timeout");setTimeout(function(){tc(i)},100)})})}var deferred=Q.defer();return tc(0),deferred.promise},d1inst.currentServer=function(){return connection._addr},d1inst.on=function(event,callback){return connection.on(event,callback),d1inst},d1inst.removeListener=function(event,callback){return connection.removeListener(event,callback),d1inst},d1inst.connectAsUser=function(ip,user,password,WSocket){return d1inst.connect(ip,WSocket).then(function(){return d1inst("#self").auth(user,password)})},d1inst.deauthenticate=function(){connection.authenticated(!1),connection.user(null),connection.pass(null)},d1inst.setSecured=function(bSecured){connection.setSecured(bSecured)},d1inst.isSecured=function(){return connection._secured},d1inst.setWSocket=function(WSocket){connection.setWSocket(WSocket)},d1inst}function DiyaSelector(selector,connection){EventEmitter.call(this),this._connection=connection,this._selector=selector,this._listenerCount=0,this._listenCallback=null,this._callbackAttached=!1}function matchString(selector,str){return selector===str}function matchRegExp(selector,str){return str.match(selector)}function matchArray(selector,str){for(var i=0;i<selector.length;i++)if(selector[i]===str)return!0;return!1}function Subscription(selector,params,callback,options){var that=this;return this.selector=selector,this.params=params,this.callback=callback,this.options=options,this.subIds=[],this.doSubscribe=function(peerId){that.subIds.push(that._addSubscription(peerId)),that.state="open"},this.options&&this.options.auto?this.selector.on("peer-connected",this.doSubscribe):this.selector.each(this.doSubscribe),this}if("undefined"==typeof window)var Q=require("q");else var Q=window.Q;var EventEmitter=require("node-event-emitter"),inherits=require("inherits"),DiyaNode=require("./DiyaNode"),IP_REGEX=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,d1=newInstance();d1.newInstance=newInstance,inherits(DiyaSelector,EventEmitter),DiyaSelector.prototype.select=function(){return this._select()},DiyaSelector.prototype.each=function(cb){for(var peers=this._select(),i=0;i<peers.length;i++)cb.bind(this)(peers[i]);return this},DiyaSelector.prototype.request=function(params,callback,timeout,options){if(!this._connection)return this;if(options||(options={}),params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}var nbAnswers=0,nbExpected=this._select().length;return this.each(function(peerId){params.target=peerId;var opts={};for(var i in options)opts[i]=options[i];"function"==typeof opts.callback_partial&&(opts.callback_partial=function(err,data){options.callback_partial(peerId,err,data)}),this._connection.request(params,function(err,data){"function"==typeof callback&&callback(peerId,err,data),++nbAnswers==nbExpected&&options.bNotifyWhenFinished&&callback(null,err,"##END##")},timeout,opts)})},DiyaSelector.prototype.subscribe=function(params,callback,options){if(params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedSubscription";params={service:_params[0],func:_params[1]}}return new Subscription(this,params,callback,options)},DiyaSelector.prototype.unsubscribe=function(subscription){return Array.isArray(subscription)||!subscription.close?this.__old_deprecated_unsubscribe(subscription):subscription.close()},DiyaSelector.prototype.auth=function(user,password,callback,timeout){var that=this;"function"==typeof callback&&(callback=callback.bind(this));var deferred=Q.defer();return this.request({service:"auth",func:"Authenticate",data:{user:user,username:user,password:password}},function(peerId,err,data){if("ServiceNotFound"===err)return void("function"==typeof callback?callback(peerId,!0):deferred.reject(err));err||!data||!0!==data&&!0!==data.authenticated?(that._connection.authenticated(!1),"function"==typeof callback?callback(peerId,!1):deferred.reject("AccessDenied")):(that._connection.authenticated(!0),that._connection.user(user),that._connection.pass(password),"function"==typeof callback?callback(peerId,!0):deferred.resolve())},timeout),deferred.promise},DiyaSelector.prototype._select=function(selectorFunction){var that=this;return this._connection?this._connection.peers().filter(function(peerId){return that._match(that._selector,peerId)}):[]},DiyaSelector.prototype._match=function(selector,str){return!!selector&&("#self"===selector?this._connection&&str===this._connection.self():selector.not?!this._match(selector.not,str):"String"===selector.constructor.name?matchString(selector,str):"RegExp"===selector.constructor.name?matchRegExp(selector,str):!!Array.isArray(selector)&&matchArray(selector,str))},DiyaSelector.prototype._on=DiyaSelector.prototype.on,DiyaSelector.prototype.on=function(type,callback){var that=this;callback.___DiyaSelector_hidden_wrapper=function(peerId){that._match(that._selector,peerId)&&that.emit(type,peerId)},this._connection.on(type,callback.___DiyaSelector_hidden_wrapper);var ret=this._on(type,callback);if("peer-connected"===type&&this._connection.isConnected())for(var peers=this._connection.peers(),i=0;i<peers.length;i++)this._match(this._selector,peers[i])&&callback(peers[i]);return ret},DiyaSelector.prototype._removeListener=DiyaSelector.prototype.removeListener,DiyaSelector.prototype.removeListener=function(type,callback){callback.___DiyaSelector_hidden_wrapper&&this._connection.removeListener(type,callback.___DiyaSelector_hidden_wrapper),this._removeListener(type,callback)},Subscription.prototype.close=function(){for(var i=0;i<this.subIds.length;i++)this.selector._connection.unsubscribe(this.subIds[i]);this.subIds=[],this.selector.removeListener("peer-connected",this.doSubscribe),this.state="closed"},Subscription.prototype._addSubscription=function(peerId){var that=this,params={};for(var k in this.params)params[k]=this.params[k];params.target=peerId;var subId=this.selector._connection.subscribe(params,function(err,data){that.callback(peerId,err,data)});return this.options&&Array.isArray(this.options.subIds)&&(this.options.subIds[peerId]=subId),subId},DiyaSelector.prototype.listen=function(){},DiyaSelector.prototype.__old_deprecated_unsubscribe=function(subIds){return this.each(function(peerId){var subId=subIds[peerId];subId&&this._connection.unsubscribe(subId)}),this},module.exports=d1},{"./DiyaNode":18,inherits:3,"node-event-emitter":4,q:void 0}],20:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();if("undefined"==typeof window){var Q=require("q"),net=require("net"),JSONSocket=require("json-socket"),EventEmitter=require("node-event-emitter"),UNIXSocketHandler=function(_EventEmitter){function UNIXSocketHandler(addr,connectTimeout){_classCallCheck(this,UNIXSocketHandler);var _this=_possibleConstructorReturn(this,(UNIXSocketHandler.__proto__||Object.getPrototypeOf(UNIXSocketHandler)).call(this));return _this.addr=addr,_this._socket=new JSONSocket(new net.Socket),_this._socket.connect(_this.addr),_this._socketOpenCallback=_this._onopen.bind(_this),_this._socketCloseCallback=_this._onclose.bind(_this),_this._socketMessageCallback=_this._onmessage.bind(_this),_this._socketErrorCallback=_this._onerror.bind(_this),_this._socket.on("connect",_this._socketOpenCallback),_this._socket._socket.on("close",_this._socketCloseCallback),_this._socket.on("message",_this._socketMessageCallback),_this._socket._socket.on("error",_this._socketErrorCallback),setTimeout(function(_){"opened"!==_this._status&&"closed"!==_this._status&&(Logger.log("d1: "+that.addr+" timed out while connecting"),_this.close(),_this.emit("timeout",_this._socket))},connectTimeout),_this}return _inherits(UNIXSocketHandler,_EventEmitter),_createClass(UNIXSocketHandler,[{key:"close",value:function(){return this._disconnectionDeferred&&this._disconnectionDeferred.promise?this._disconnectionDeferred.promise:(this._disconnectionDeferred=Q.defer(),this._status="closing",this.emit("closing",this._socket),this._socket&&this._socket.end(),this._disconnectionDeferred.promise)}},{key:"send",value:function(msg){try{this._socket.sendMessage(msg)}catch(err){return console.error("Cannot send message: "+err.message),!1}return!0}},{key:"isConnected",value:function(){return!this._socket.isClosed()&&"opened"===this._status}},{key:"_onopen",value:function(){this._status="opened",this.emit("open",this._socket)}},{key:"_onclose",value:function(){this._status="closed",this.unregisterCallbacks(),this.emit("close",this._socket),this._disconnectionDeferred&&this._disconnectionDeferred.promise&&this._disconnectionDeferred.resolve()}},{key:"_onmessage",value:function(msg){this.emit("message",msg)}},{key:"_onerror",value:function(err){this.emit("error",err)}},{key:"unregisterCallbacks",value:function(){this._socket&&"function"==typeof this._socket.removeEventListener?(this._socket.removeEventListener("open",this._socketOpenCallback),this._socket.removeEventListener("close",this._socketCloseCallback),
this._socket.removeEventListener("message",this._socketMessageCallback)):this._socket&&"function"==typeof this._socket.removeAllListeners&&this._socket.removeAllListeners()}}]),UNIXSocketHandler}(EventEmitter);module.exports=UNIXSocketHandler}},{"json-socket":void 0,net:2,"node-event-emitter":4,q:void 0}],21:[function(require,module,exports){"use strict";var d1=require("./DiyaSelector.js");require("./services/rtc/rtc.js"),require("./services/ieq/ieq.js"),require("./services/peerAuth/PeerAuth.js"),require("./services/meshNetwork/MeshNetwork.js"),require("./utils/encoding/encoding.js"),require("./services/status/status.js"),module.exports=d1},{"./DiyaSelector.js":19,"./services/ieq/ieq.js":22,"./services/meshNetwork/MeshNetwork.js":23,"./services/peerAuth/PeerAuth.js":25,"./services/rtc/rtc.js":26,"./services/status/status.js":27,"./utils/encoding/encoding.js":28}],22:[function(require,module,exports){"use strict";function IEQ(selector){return this.selector=selector,this.dataModel={},this._coder=selector.encode(),this.subscriptions=[],this.dataConfig={criteria:{time:{start:null,end:null,range:null},robot:null,place:null},operator:"last",sensors:null,sampling:null},this}var DiyaSelector=require("../../DiyaSelector").DiyaSelector,Logger=(require("util"),require("../message"),{log:function(message){console.log(message)},error:function(message){console.error(message)}});IEQ.prototype.getDataModel=function(){return this.dataModel},IEQ.prototype.getDataRange=function(){return this.dataModel.range},IEQ.prototype.DataConfig=function(newDataConfig){return newDataConfig?(this.dataConfig=newDataConfig,this):this.dataConfig},IEQ.prototype.DataOperator=function(newOperator){return newOperator?(this.dataConfig.operator=newOperator,this):this.dataConfig.operator},IEQ.prototype.DataSampling=function(numSamples){return numSamples?(this.dataConfig.sampling=numSamples,this):this.dataConfig.sampling},IEQ.prototype.DataTime=function(newTimeStart,newTimeEnd,newRange){return newTimeStart||newTimeEnd||newRange?(this.dataConfig.criteria.time.start=newTimeStart.getTime(),this.dataConfig.criteria.time.end=newTimeEnd.getTime(),this.dataConfig.criteria.time.range=newRange,this):{start:new Date(this.dataConfig.criteria.time.start),end:new Date(this.dataConfig.criteria.time.end),range:new Date(this.dataConfig.criteria.time.range)}},IEQ.prototype.DataRobotIds=function(robotIds){return robotIds?(this.dataConfig.criteria.robot=robotIds,this):this.dataConfig.criteria.robot},IEQ.prototype.DataPlaceIds=function(placeIds){return placeIds?(this.dataConfig.criteria.placeId=placeIds,this):this.dataConfig.criteria.place},IEQ.prototype.getDataByName=function(sensorNames){var data=[];for(var n in sensorNames)data.push(this.dataModel[sensorNames[n]]);return data},IEQ.prototype.updateData=function(callback,dataConfig){var that=this;dataConfig&&this.DataConfig(dataConfig),this.selector.request({service:"ieq",func:"DataRequest",data:{type:"splReq",dataConfig:that.dataConfig}},function(dnId,err,data){return err?void Logger.error("["+that.dataConfig.sensors+"] Recv err: "+JSON.stringify(err)):data.header.error?(Logger.error("UpdateData:\n"+JSON.stringify(data.header.dataConfig)),void Logger.error("Data request failed ("+data.header.error.st+"): "+data.header.error.msg)):(that._getDataModelFromRecv(data),void(callback=callback.bind(that))(that.getDataModel()))})},IEQ.prototype._isDataModelWithNaN=function(){var sensorNan,dataModelNaN=!1;for(var n in this.dataModel)sensorNan=this.dataModel[n].data.reduce(function(nanPres,d){return nanPres&&isNaN(d)},!1),dataModelNaN=dataModelNaN&&sensorNan,Logger.log(n+" with nan : "+sensorNan+" ("+dataModelNaN+") / "+this.dataModel[n].data.length)},IEQ.prototype.getConfinementLevel=function(){return this.confinement},IEQ.prototype.getAirQualityLevel=function(){return this.airQuality},IEQ.prototype.getEnvQualityLevel=function(){return this.envQuality},IEQ.prototype.watch=function(data,callback){var that=this;data=data||{},data.timeRange=data.timeRange||"hours",data.cat=data.cat||"ieq";var subs=this.selector.subscribe({service:"ieq",func:"Data",data:data,obj:data.cat},function(dnId,err,data){return err?void Logger.error("WatchIEQRecvErr:"+JSON.stringify(err)):data.header.error?(Logger.error("WatchIEQ:\n"+JSON.stringify(data.header.dataConfig)),void Logger.error("Data request failed ("+data.header.error.st+"): "+data.header.error.msg)):(that._getDataModelFromRecv(data),void(callback=callback.bind(that))(that.getDataModel()))});this.subscriptions.push(subs)},IEQ.prototype.closeSubscriptions=function(){for(var i in this.subscriptions)this.subscriptions[i].close();this.subscriptions=[]},IEQ.prototype.getCSVData=function(sensorNames,_firstDay,callback){var firstDay=new Date(_firstDay),dataConfig={criteria:{time:{start:firstDay.getTime(),rangeUnit:"hour",range:180},places:[],robots:[]},sensors:sensorNames};this.updateData(callback,dataConfig)},IEQ.prototype._getDataModelFromRecv=function(data){var dataModel=null;if(data.err&&data.err.st>0)return Logger.error(data.err.msg),null;if(delete data.err,data&&data.header){for(var n in data)if("header"!=n&&"err"!=n){if(data[n].err&&data[n].err.st>0){Logger.error(n+" was in error: "+data[n].err.msg);continue}if(dataModel||(dataModel={}),dataModel[n]||(dataModel[n]={}),dataModel[n].range=data[n].range,dataModel[n].timeRange=data[n].timeRange,dataModel[n].label=data[n].label,dataModel[n].unit=data[n].unit,dataModel[n].precision=data[n].precision,dataModel[n].category=data[n].category,dataModel[n].zoomRange=[0,100],dataModel[n].qualityConfig={indexRange:data[n].indexRange},dataModel[n].time=this._coder.from(data[n].time,"b64",8),dataModel[n].data=data[n].data?this._coder.from(data[n].data,"b64",4):data[n].avg?this._coder.from(data[n].avg.d,"b64",4):null,dataModel[n].qualityIndex=data[n].data?this._coder.from(data[n].index,"b64",4):data[n].avg?this._coder.from(data[n].avg.i,"b64",4):null,dataModel[n].robotId=this._coder.from(data[n].robotId,"b64",4),dataModel[n].robotId){var dicoRobot={};data.header.robots.forEach(function(el){dicoRobot[el.id]=el.name}),dataModel[n].robotId=dataModel[n].robotId.map(function(el){return dicoRobot[el]})}dataModel[n].placeId=this._coder.from(data[n].placeId,"b64",4),dataModel[n].x=null,dataModel[n].y=null,data[n].avg&&(dataModel[n].avg={d:this._coder.from(data[n].avg.d,"b64",4),i:this._coder.from(data[n].avg.i,"b64",4)}),data[n].min&&(dataModel[n].min={d:this._coder.from(data[n].min.d,"b64",4),i:this._coder.from(data[n].min.i,"b64",4)}),data[n].max&&(dataModel[n].max={d:this._coder.from(data[n].max.d,"b64",4),i:this._coder.from(data[n].max.i,"b64",4)}),data[n].stddev&&(dataModel[n].stddev={d:this._coder.from(data[n].stddev.d,"b64",4),i:this._coder.from(data[n].stddev.i,"b64",4)}),data[n].stddev&&(dataModel[n].stddev={d:this._coder.from(data[n].stddev.d,"b64",4),i:this._coder.from(data[n].stddev.i,"b64",4)}),data[n].x&&(dataModel[n].x=this._coder.from(data[n].x,"b64",4)),data[n].y&&(dataModel[n].y=this._coder.from(data[n].y,"b64",4)),dataModel[n].trend="mss"}}else Logger.error("No Data to read or header is missing !");return this.dataModel=dataModel,dataModel},DiyaSelector.prototype.IEQ=function(){return new IEQ(this)}},{"../../DiyaSelector":19,"../message":24,util:8}],23:[function(require,module,exports){"use strict";var DiyaSelector=require("../../DiyaSelector").DiyaSelector,d1=require("../../DiyaSelector");if("undefined"==typeof window)var Q=require("q");else var Q=window.Q;d1.knownPeers=function(){return d1("#self").knownPeers()},d1.kp=d1.knownPeers,DiyaSelector.prototype.knownPeers=function(callback){var deferred=Q.defer();return this.request({service:"meshNetwork",func:"ListKnownPeers"},function(peerId,err,data){if(err)return deferred.reject(err);for(var peers=[],i=0;i<data.peers.length;i++)peers.push(data.peers[i].name);return deferred.resolve(peers)}),deferred.promise},d1.listenMeshNetwork=function(callback){return d1(/.*/).subscribe({service:"meshNetwork",func:"MeshNetwork"},callback,{auto:!0})}},{"../../DiyaSelector":19,q:void 0}],24:[function(require,module,exports){"use strict";function Message(service,func,obj,permanent){this.service=service,this.func=func,this.obj=obj,this.permanent=permanent}Message.buildSignature=function(msg){return msg.service+"."+msg.func+"."+msg.obj},Message.prototype.signature=function(){return this.service+"."+this.func+"."+this.obj},Message.prototype.exec=function(data){return{service:this.service,func:this.func,obj:this.obj,data:data}},module.exports=Message},{}],25:[function(require,module,exports){"use strict";var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),DiyaSelector=require("../../DiyaSelector").DiyaSelector,d1=require("../../DiyaSelector");if("undefined"==typeof window)var Q=require("q");else var Q=window.Q;if(void 0===INFO)var INFO=function(s){console.log(s)};if(void 0===OK)var OK=function(s){console.log(s)};d1.installNodeExt=function(ip,user,password,bootstrap_ip,bootstrap_user,bootstrap_password,bootstrap_net,callback){function join(peer,bootstrap_peer){d1("#self").join(bootstrap_net,!0,function(peer,err,data){return err||OK("JOINED !!!"),callback(peer,bootstrap_peer,err,data)})}if("string"!=typeof ip)throw"[installNode] ip should be an IP address";if("string"!=typeof bootstrap_ip)throw"[installNode] bootstrap_ip should be an IP address";if("string"!=typeof bootstrap_net)throw"[installNode] bootstrap_net should be an IP address";0!==bootstrap_ip.indexOf("ws://")&&0!==bootstrap_ip.indexOf("wss://")&&(bootstrap_ip=d1.isSecured()?"wss://"+bootstrap_ip:"ws://"+bootstrap_ip),0!==bootstrap_net.indexOf("ws://")&&0!==bootstrap_net.indexOf("wss://")&&(bootstrap_net=d1.isSecured()?"wss://"+bootstrap_net:"ws://"+bootstrap_net),d1.connectAsUser(ip,user,password).then(function(peer,err,data){d1("#self").givePublicKey(function(peer,err,data){return"ServiceNotFound"===err?(INFO("Peer Authentication disabled ... directly joining"),void join()):err?callback(peer,null,err,null):(INFO("Add trusted peer '"+peer+"' (ip="+ip+") to '"+bootstrap_ip+"' with public key\n"+data.public_key),void d1.connectAsUser(bootstrap_ip,bootstrap_user,bootstrap_password).then(function(){d1("#self").addTrustedPeer(peer,data.public_key,function(bootstrap_peer,err,_ref){var _ref2=_slicedToArray(_ref,2),alreadyTrusted=_ref2[0];_ref2[1];if(err)return callback(peer,bootstrap_peer,err,null);INFO(alreadyTrusted?peer+" already trusted by "+bootstrap_peer:bootstrap_peer+"(ip="+bootstrap_ip+") added "+peer+"(ip="+ip+") as a Trusted Peer"),d1("#self").givePublicKey(function(_,err,data){INFO("In return, add "+bootstrap_peer+" to "+peer+" as a Trusted Peer with public key "+data.public_key),d1.connectAsUser(ip,user,password).then(function(){d1("#self").addTrustedPeer(bootstrap_peer,data.public_key,function(peer,err,_ref3){var _ref4=_slicedToArray(_ref3,2),alreadyTrusted=_ref4[0];_ref4[1];return err?callback(peer,bootstrap_peer,err,null):INFO(alreadyTrusted?bootstrap_peer+" already trusted by "+peer:peer+"(ip="+ip+") added "+bootstrap_peer+"(ip="+bootstrap_ip+") as a Trusted Peer"),OK("KEYS OK ! Now, let "+peer+"(ip="+ip+") join the network via "+bootstrap_peer+"(ip="+bootstrap_net+") ..."),join(peer,bootstrap_peer)})})})})}))})})},d1.installNode=function(bootstrap_ip,bootstrap_net,callback){var ip=d1.addr(),user=d1.user(),password=d1.pass(),bootstrap_user=user,bootstrap_password=password;return console.log("[installNode]\nip:"+ip),d1.installNodeExt(ip,user,password,bootstrap_ip,bootstrap_user,bootstrap_password,bootstrap_net,callback)},DiyaSelector.prototype.join=function(bootstrap_ips,permanent,callback){if("string"==typeof bootstrap_ips&&(bootstrap_ips=[bootstrap_ips]),bootstrap_ips.constructor!==Array)throw"join() : bootstrap_ips should be an array of peers URIs";this.request({service:"meshNetwork",func:"Join",data:{bootstrap_ips:bootstrap_ips,permanent:permanent}},function(peerId,err,data){"function"==typeof callback&&callback(peerId,err,data)})},DiyaSelector.prototype.leave=function(bootstrap_ips,bPermanent,callback){if("string"==typeof bootstrap_ips&&(bootstrap_ips=[bootstrap_ips]),bootstrap_ips.constructor!==Array)throw"leave() : bootstrap_ips should be an array of peers URIs";this.request({service:"meshNetwork",func:"Leave",data:{bootstrap_ips:bootstrap_ips,bPermanent:bPermanent}},function(peerId,err,data){"function"==typeof callback&&callback(peerId,err,data)})},DiyaSelector.prototype.givePublicKey=function(callback){return this.request({service:"peerAuth",func:"GivePublicKey",data:{}},function(peerId,err,data){callback(peerId,err,data)})},DiyaSelector.prototype.addTrustedPeer=function(name,public_key,callback){return this.request({service:"peerAuth",func:"AddTrustedPeer",data:{peer_name:name,public_key:public_key}},function(peerId,err,data){callback(peerId,err,data)})},DiyaSelector.prototype.areTrusted=function(peers,callback){return this.request({service:"peerAuth",func:"AreTrusted",data:{peers:peers}},function(peerId,err,data){data.trusted?(OK(peers+" are trusted by "+peerId),callback(peerId,!0)):(ERR("Some peers in "+peers+" are untrusted by "+peerId),callback(peerId,!1))})},DiyaSelector.prototype.isTrusted=function(peer,callback){return this.areTrusted([peer],callback)},d1.trustedPeers=function(){var deferred=Q.defer();return d1("#self").request({service:"peerAuth",func:"GetTrustedPeers"},function(peerId,err,data){if(err)return deferred.reject(err);for(var peers=[],i=0;i<data.peers.length;i++)peers.push(data.peers[i].name);return deferred.resolve(peers)}),deferred.promise},d1.tp=d1.trustedPeers,d1.blacklistedPeers=function(){var deferred=Q.defer();return d1("#self").request({service:"peerAuth",func:"GetBlacklistedPeers"},function(peerId,err,data){if(err)return deferred.reject(err);for(var peers=[],i=0;i<data.peers.length;i++)peers.push(data.peers[i].name);return deferred.resolve(peers)}),deferred.promise},d1.bp=d1.blacklistedPeers},{"../../DiyaSelector":19,q:void 0}],26:[function(require,module,exports){"use strict";function Channel(dnId,name,datachannel_cb,stream_cb){EventEmitter.call(this),this.name=name,this.dnId=dnId,this.frequency=20,this.channel=void 0,this.stream=void 0,this.ondatachannel=datachannel_cb,this.onstream=stream_cb,this.closed=!1}function Peer(dnId,rtc,id,channels){this.dn=d1(dnId),this.dnId=dnId,this.id=id,this.channels=channels,this.rtc=rtc,this.peer=null,this.streams=[],this.connected=!1,this.closed=!1,this._connect()}function RTC(selector){this.selector=selector,this.requestedChannels=[],this.channelsByStream=[]}var DiyaSelector=require("../../DiyaSelector").DiyaSelector,EventEmitter=require("node-event-emitter"),inherits=require("inherits");require("webrtc-adapter"),inherits(Channel,EventEmitter),Channel.prototype.setDataChannel=function(datachannel){var that=this;this.channel=datachannel,this.channel.binaryType="arraybuffer",console.log("set data channel :"+this.name),datachannel.onmessage=function(message){var view=new DataView(message.data),typeChar=String.fromCharCode(view.getUint8(0));if("O"===typeChar)that.type="input";else{if("I"!==typeChar)throw"Unrecnognized channel type : "+typeChar;that.type="output"}var size=view.getInt32(1,!0);if(!size)throw"Wrong datachannel message size";that.size=size,that._buffer=new Float32Array(size),datachannel.onmessage=that._onMessage.bind(that),datachannel.onclose=that._onClose.bind(that),"function"==typeof that.ondatachannel&&that.ondatachannel(that.dnId,that),console.log("Open datachannel "+that.name)}},Channel.prototype.onAddStream=function(stream){this.stream=stream,"function"==typeof this.onstream?this.onstream(this.dnId,stream):console.warn("Ignore stream "+stream.id),console.log("Open stream "+this.name)},Channel.prototype.close=function(){this.closed=!0},Channel.prototype.write=function(index,value){return!(index<0||index>this.size||isNaN(value))&&(this._buffer[index]=value,this._requestSend(),!0)},Channel.prototype.writeAll=function(values){if(!Array.isArray(values)||values.length!==this.size)return!1;for(var i=0;i<values.length;i++){if(isNaN(values[i]))return!1;this._buffer[i]=values[i]}this._requestSend()},Channel.prototype._requestSend=function(){function doSend(){that._sendRequested=!1,that._lastSendTimestamp=(new Date).getTime(),that._send(that._buffer)&&that.autosend&&that._requestSend()}var that=this,elapsedTime=(new Date).getTime()-this._lastSendTimestamp,period=1e3/this.frequency;elapsedTime>=period?doSend():this._sendRequested||(this._sendRequested=!0,setTimeout(doSend,period-elapsedTime))},Channel.prototype._send=function(msg){if(this.closed||!this.channel)return!1;if("open"===this.channel.readyState){try{this.channel.send(msg)}catch(e){console.log("[rtc.channel.write] exception occured while sending data")}return!0}return console.log("[rtc.channel.write] warning : webrtc datachannel state = "+this.channel.readyState),!1},Channel.prototype._onMessage=function(message){var valArray=new Float32Array(message.data);this.emit("value",valArray)},Channel.prototype._onClose=function(){console.log("Close datachannel "+this.name),this.emit("close")},Peer.prototype._connect=function(){var that=this;this.subscription=this.dn.subscribe({service:"rtc",func:"Connect",obj:this.channels,data:{promID:this.id}},function(diya,err,data){data&&("TurnInfo"===data.eventType?that._turninfo=data.turn:"RemoteOffer"===data.eventType?that._createPeer(data):"RemoteICECandidate"===data.eventType&&that._addRemoteICECandidate(data))}),this._timeoutId=setTimeout(function(){that.connected||that.closed||that._reconnect()},4e4)},Peer.prototype._reconnect=function(){this.close(),this.peer=null,this.connected=!1,this.closed=!1,this._connect()},Peer.prototype._createPeer=function(data){var that=this,iceServers=[];this._turninfo?iceServers.push({urls:[this._turninfo.url],username:this._turninfo.username,credential:this._turninfo.password}):iceServers.push({urls:["stun:stun.l.google.com:19302"]});var config={iceServers:iceServers,iceTransportPolicy:"all"},constraints={mandatory:{DtlsSrtpKeyAgreement:!0,OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};console.log(config),console.log(constraints);var peer=new RTCPeerConnection(config,constraints);this.peer=peer,this.streams.forEach(function(s){peer.addStream(s)}),peer.setRemoteDescription(new RTCSessionDescription({sdp:data.sdp,type:data.type})),peer.createAnswer(function(session_description){peer.setLocalDescription(session_description),that.dn.request({service:"rtc",func:"Answer",data:{promID:data.promID,peerId:data.peerId,sdp:session_description.sdp,type:session_description.type}})},function(err){console.log(err)},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}),peer.oniceconnectionstatechange=function(){"connected"===peer.iceConnectionState?(that.connected=!0,that.subscription&&that.subscription.close()):"disconnected"!==peer.iceConnectionState&&"closed"!==peer.iceConnectionState&&"failed"!==peer.iceConnectionState||that.closed||that._reconnect()},peer.onicecandidate=function(evt){that.dn.request({service:"rtc",func:"ICECandidate",data:{peerId:data.peerId,promID:that.id,candidate:evt.candidate}})},peer.ondatachannel=function(evt){that.connected=!0,that.rtc._onDataChannel(that.dnId,evt.channel)},peer.onaddstream=function(evt){that.connected=!0,that.rtc._onAddStream(that.dnId,evt.stream)}},Peer.prototype._addRemoteICECandidate=function(data){try{var candidate=new RTCIceCandidate(data.candidate);this.peer.addIceCandidate(candidate,function(){},function(err){console.error(err)})}catch(err){console.error(err)}},Peer.prototype.sendChannelsStreamsMappings=function(){this.dn.request({service:"rtc",func:"ChannelsStreamsMappings",data:{peerId:0,mappings:this.rtc[this.dnId].channelsByStream}},function(peerId,err,data){err&&console.error(err)})},Peer.prototype.addStream=function(stream){this.sendChannelsStreamsMappings(),this.streams.filter(function(s){return stream.id===s})[0]||this.streams.push(stream),this._reconnect()},Peer.prototype.removeStream=function(stream){this.streams=this.streams.filter(function(s){return stream.id!==s}),this.peer&&this.peer.removeStream(stream)},Peer.prototype.close=function(){if(this.subscription&&this.subscription.close(),clearTimeout(this._timeoutId),this.peer){try{this.peer.close()}catch(e){}this.connected=!1,this.closed=!0}},RTC.prototype.use=function(name_regex,type,ondatachannel_callback,onaddstream_callback){return this.requestedChannels.push({regex:name_regex,type:type,cb:ondatachannel_callback,stream_cb:onaddstream_callback}),this},RTC.prototype.connect=function(){var that=this;return this.subscription=this.selector.subscribe({service:"rtc",func:"Peers"},function(dnId,err,data){if(that[dnId]||that._createDiyaNode(dnId),"SubscriptionClosed"===err||"PeerDisconnected"===err)return void that._closeDiyaNode(dnId);if(data&&data.eventType&&void 0!==data.promID)if("PeerConnected"===data.eventType){if(!that[dnId].peers[data.promID]){var channels=that._matchChannels(dnId,data.channels);channels.length>0&&(that[dnId].peers[data.promID]=new Peer(dnId,that,data.promID,channels)),that.channelsByStream.forEach(function(cbs){that.addStream(cbs.channel,cbs.mediaStream)})}that[dnId].peers[data.promID]&&that[dnId].peers[data.promID].sendChannelsStreamsMappings()}else"PeerClosed"===data.eventType&&that[dnId].peers[data.promID]&&(that._closePeer(dnId,data.promID),"function"==typeof that.onclose&&that.onclose(dnId))},{auto:!0}),this},RTC.prototype.disconnect=function(){var that=this;return this.selector.each(function(dnId){if(that[dnId])for(var promID in that[dnId].peers)that._closePeer(dnId,promID)}),this.subscription&&this.subscription.close(),this},RTC.prototype._createDiyaNode=function(dnId){var that=this;this[dnId]={dnId:dnId,usedChannels:[],requestedChannels:[],peers:[],channelsByStream:[]},this.requestedChannels.forEach(function(c){that[dnId].requestedChannels.push(c)})},RTC.prototype._closeDiyaNode=function(dnId){for(var promID in this[dnId].peers)this._closePeer(dnId,promID);delete this[dnId]},RTC.prototype._closePeer=function(dnId,promID){if(this[dnId].peers[promID]){var p=this[dnId].peers[promID];p.close();for(var i=0;i<p.channels.length;i++)delete this[dnId].usedChannels[p.channels[i]];delete this[dnId].peers[promID]}},RTC.prototype._matchChannels=function(dnId,receivedChannels){for(var that=this,channels=[],i=0;i<receivedChannels.length;i++){var name=receivedChannels[i],remoteStreamId=name.split("_;:_")[1];name=name.split("_;:_")[0];for(var j=0;j<that[dnId].requestedChannels.length;j++){var req=that[dnId].requestedChannels[j];if(name&&name.match(req.regex)&&!that[dnId].usedChannels[name]){var channel=new Channel(dnId,name,req.cb,req.stream_cb);that[dnId].usedChannels[name]=channel,channels.push(name),remoteStreamId&&(that[dnId].channelsByStream=that[dnId].channelsByStream.filter(function(cbs){return cbs.stream!==remoteStreamId&&cbs.channel!==channel}),that[dnId].channelsByStream.push({stream:remoteStreamId,channel:channel}),channel.streamId=streamId);var localStreamId=that.channelsByStream.filter(function(cbs){return cbs.channel===name})[0];localStreamId&&(that[dnId].channelsByStream=that[dnId].channelsByStream.filter(function(cbs){return cbs.stream!==localStreamId&&cbs.channel!==name}),that[dnId].channelsByStream.push({stream:localStreamId,channel:name}),channel.localStreamId=localStreamId)}}}return channels},RTC.prototype._onDataChannel=function(dnId,datachannel){if(!this[dnId])return console.warn("Tried to open a data channel on a closed peer");var channel=this[dnId].usedChannels[datachannel.label];if(!channel)return console.log("Datachannel "+datachannel.label+" unmatched, closing !"),void datachannel.close();channel.setDataChannel(datachannel)},RTC.prototype._onAddStream=function(dnId,stream){if(!this[dnId])return console.warn("Tried to open a stream on a closed peer");var channel=this[dnId].usedChannels[stream.id];if(!channel)return console.warn("Stream Channel "+stream.id+" unmatched, closing !"),void stream.close();channel.onAddStream(stream)},RTC.prototype.addStream=function(channel,stream){var that=this;this.channelsByStream=this.channelsByStream.filter(function(cbs){return cbs.channel!==channel&&cbs.stream!==stream.id}),this.channelsByStream.push({channel:channel,stream:stream.id,mediaStream:stream}),console.log("Open local stream "+channel),this.selector.each(function(dnId){if(that[dnId]){that[dnId].channelsByStream=that[dnId].channelsByStream.filter(function(cbs){return cbs.channel!==channel&&cbs.stream!==stream.id}),that[dnId].channelsByStream.push({channel:channel,stream:stream.id});for(var promID in that[dnId].peers)that[dnId].peers[promID].addStream(stream)}})},RTC.prototype.removeStream=function(channel,stream){var that=this;this.channelsByStream=this.channelsByStream.filter(function(cbs){return cbs.channel!==channel&&cbs.stream!==stream.id}),console.log("Close local stream "+channel),this.selector.each(function(dnId){if(that[dnId]){that[dnId].channelsByStream=that[dnId].channelsByStream.filter(function(cbs){return cbs.channel!==channel&&cbs.stream!==stream.id});for(var promID in that[dnId].peers)that[dnId].peers[promID].removeStream(stream)}})},DiyaSelector.prototype.rtc=function(){return new RTC(this)}},{"../../DiyaSelector":19,inherits:3,"node-event-emitter":4,"webrtc-adapter":9}],27:[function(require,module,exports){"use strict";function Status(selector){return this.selector=selector,this._coder=selector.encode(),this.subscriptions=[],this.robotModel=[],this._robotModelInit=!1,this.dataConfig={criteria:{time:{beg:null,end:null,range:null},robot:null},operator:"last",parts:null,status:null},this}var DiyaSelector=require("../../DiyaSelector").DiyaSelector,Logger=(require("util"),require("../message"),{log:function(message){console.log(message)},error:function(message){console.error(message)}});Status.prototype.getRobotModel=function(){return this.robotModel},Status.prototype.DataConfig=function(newDataConfig){return newDataConfig?(this.dataConfig=newDataConfig,this):this.dataConfig},Status.prototype.DataOperator=function(newOperator){return newOperator?(this.dataConfig.operator=newOperator,this):this.dataConfig.operator},Status.prototype.DataSampling=function(numSamples){return numSamples?(this.dataConfig.sampling=numSamples,this):this.dataConfig.sampling},Status.prototype.DataTime=function(newTimeBeg,newTimeEnd,newRange){return newTimeBeg||newTimeEnd||newRange?(this.dataConfig.criteria.time.beg=newTimeBeg.getTime(),this.dataConfig.criteria.time.end=newTimeEnd.getTime(),this.dataConfig.criteria.time.range=newRange,this):{beg:new Date(this.dataConfig.criteria.time.beg),end:new Date(this.dataConfig.criteria.time.end),range:new Date(this.dataConfig.criteria.time.range)}},Status.prototype.DataRobotIds=function(robotIds){return robotIds?(this.dataConfig.criteria.robot=robotIds,this):this.dataConfig.criteria.robot},Status.prototype.DataPlaceIds=function(placeIds){return placeIds?(this.dataConfig.criteria.placeId=placeIds,this):this.dataConfig.criteria.place},Status.prototype.getDataByName=function(sensorNames){var data=[];for(var n in sensorNames)data.push(this.dataModel[sensorNames[n]]);return data},Status.prototype.watch=function(robotNames,callback){var that=this,subs=this.selector.subscribe({service:"status",func:"Status",data:robotNames},function(peerId,err,data){err||data&&data.err&data.err.st?Logger.error("StatusSubscribe:"+(err||"")+"\n"+(data&&data.err?data.err:"")):(data&&data.header&&"init"===data.header.type&&(that.robotModelInit=!0),that.robotModelInit?(that._getRobotModelFromRecv2(data),"function"==typeof callback&&callback(that.robotModel)):Logger.error("Robot model has not been initialised, cannot be updated"))},{auto:!0});this.subscriptions.push(subs)},Status.prototype.closeSubscriptions=function(){for(var i in this.subscriptions)this.subscriptions[i].close();this.subscriptions=[]},Status.prototype.getData=function(callback,dataConfig){var that=this,dataModel={};dataConfig&&this.DataConfig(dataConfig),this.selector.request({service:"status",func:"DataRequest",data:{type:"splReq",dataConfig:that.dataConfig}},function(dnId,err,data){return err?void Logger.error("["+that.dataConfig.sensors+"] Recv err: "+JSON.stringify(err)):data.header.error?(Logger.error("UpdateData:\n"+JSON.stringify(data.header.reqConfig)),void Logger.error("Data request failed ("+data.header.error.st+"): "+data.header.error.msg)):(dataModel=that._getDataModelFromRecv(data),Logger.log(that.getDataModel()),void(callback=callback.bind(that))(dataModel))})},Status.prototype._getRobotModelFromRecv2=function(data){var dataRobots=data.robots,dataParts=data.partList;this.robotModel||(this.robotModel=[]);for(var n in this.robotModel)this.robotModel[n].parts={};for(var n in dataRobots)if(this.robotModel[n]||(this.robotModel[n]={}),this.robotModel[n].robot=dataRobots[n].robot,dataRobots[n]&&dataRobots[n].parts){var parts=dataRobots[n].parts;this.robotModel[n].parts={};var rParts=this.robotModel[n].parts;for(var p in parts)if(rParts[p]||(rParts[p]={}),parts[p]){rParts[p].category=dataParts[p].category,rParts[p].name=dataParts[p].name,rParts[p].label=dataParts[p].label,rParts[p].errorList||(rParts[p].errorList={});for(var el in dataParts[p].errorList)rParts[p].errorList[el]||(rParts[p].errorList[el]=dataParts[p].errorList[el]);var evts_tmp={time:this._coder.from(parts[p].time),code:this._coder.from(parts[p].code),codeRef:this._coder.from(parts[p].codeRef)};if(Array.isArray(evts_tmp.code)||Array.isArray(evts_tmp.time)||Array.isArray(evts_tmp.codeRef))if(evts_tmp.code.length===evts_tmp.codeRef.length&&evts_tmp.code.length===evts_tmp.time.length){rParts[p].evts=[];for(var i=0;i<evts_tmp.code.length;i++)rParts[p].evts.push({time:evts_tmp.time[i],code:evts_tmp.code[i],codeRef:evts_tmp.codeRef[i]})}else Logger.error("Status:Inconsistant lengths of buffers (time/code/codeRef)");else rParts[p].evts=[{time:evts_tmp.time,code:evts_tmp.code,codeRef:evts_tmp.codeRef}]}}else Logger.error("No parts to read for robot "+data[n].name)},Status.prototype._getRobotModelFromRecv=function(data){this.robotModel||(this.robotModel=[]);for(var n in data)if(this.robotModel[n]||(this.robotModel[n]={}),this.robotModel[n].robot=data[n].robot,data[n]&&data[n].parts){this.robotModel[n].parts||(this.robotModel[n].parts={});var parts=data[n].parts,rParts=this.robotModel[n].parts;for(var q in rParts)!parts[q]&&rParts[q].evts&&rParts[q].evts.code&&(rParts[q].evts={code:[0],codeRef:[0],time:[Date.now()]});for(var p in parts)if(parts[p]&&parts[p].err&&parts[p].err.st>0)Logger.error("Parts "+p+" was in error: "+data[p].err.msg);else if(rParts[p]||(rParts[p]={}),parts[p]){rParts[p].category=parts[p].category,rParts[p].name=parts[p].name,rParts[p].label=parts[p].label,rParts[p].errorList||(rParts[p].errorList={});for(var el in parts[p].errorList)rParts[p].errorList[el]||(rParts[p].errorList[el]=parts[p].errorList[el]);rParts[p].evts={code:this._coder.from(parts[p].evts.code),codeRef:this._coder.from(parts[p].evts.codeRef),time:this._coder.from(parts[p].evts.time)}}}else Logger.error("No parts to read for robot "+data[n].name)},DiyaSelector.prototype.Status=function(){return new Status(this)},DiyaSelector.prototype.setStatus=function(robotName,partName,code,source,callback){var funcName="SetStatus_"+partName;this.request({service:"status",func:funcName,data:{robotName:robotName,statusCode:code,partName:partName,source:1|source}},function(peerId,err,data){err?callback&&callback(!1):callback&&callback(!0)})},DiyaSelector.prototype.getStatus=function(robotName,partName,callback,_full){var full=_full||!1;this.request({service:"status",func:"GetStatus",data:{robotName:robotName,partName:partName,full:full}
},function(peerId,err,data){err?callback&&callback(-1):callback&&callback(data)})}},{"../../DiyaSelector":19,"../message":24,util:8}],28:[function(require,module,exports){"use strict";function NoCoding(){return this}function Base64Coding(){return this}function CodingHandler(){return this.b64=new Base64Coding,this.none=new NoCoding,this}var DiyaSelector=require("../../DiyaSelector").DiyaSelector,base64=require("base-64");NoCoding.prototype.from=function(data){return"number"===data.d||Array.isArray(data.d)?data.d:data},NoCoding.prototype.to=function(array){return{t:"no",d:array,s:array.length}};var b64ToUint6=function(nChr){return nChr>64&&nChr<91?nChr-65:nChr>96&&nChr<123?nChr-71:nChr>47&&nChr<58?nChr+4:43===nChr?62:47===nChr?63:0},base64DecToArr=function(sBase64,nBlocksSize){for(var nMod3,nMod4,sB64Enc=sBase64.replace(/[^A-Za-z0-9\+\/]/g,""),nInLen=sB64Enc.length,nOutLen=nBlocksSize?Math.ceil((3*nInLen+1>>2)/nBlocksSize)*nBlocksSize:3*nInLen+1>>2,buffer=new ArrayBuffer(nOutLen),taBytes=new Uint8Array(buffer),nUint24=0,nOutIdx=0,nInIdx=0;nInIdx<nInLen;nInIdx++)if(nMod4=3&nInIdx,nUint24|=b64ToUint6(sB64Enc.charCodeAt(nInIdx))<<18-6*nMod4,3===nMod4||nInLen-nInIdx==1){for(nMod3=0;nMod3<3&&nOutIdx<nOutLen;nMod3++,nOutIdx++)taBytes[nOutIdx]=nUint24>>>(16>>>nMod3&24)&255;nUint24=0}return buffer};Base64Coding.prototype.from=function(data){var byteCoding=data.b;if(4!==byteCoding&&8!==byteCoding)return null;var buf=base64DecToArr(data.d,data.b),fArray=null;switch(data.b){case 4:fArray=new Float32Array(buf);break;case 8:fArray=new Float64Array(buf);break;default:return console.log("Unexpected byteCoding! Should not happen!!"),null}var tab=[].slice.call(fArray);return data.s!==tab.length?(console.log("Size mismatch when decoding !"),null):tab},Base64Coding.prototype.to=function(array,byteCoding){if(4!==byteCoding&&8!==byteCoding)return null;var buffer=new ArrayBuffer(array.length*byteCoding);switch(byteCoding){case 4:new Float32Array(buffer).set(array);break;case 8:new Float64Array(buffer).set(array)}for(var buffChar=new Uint8Array(buffer),buffCharCoded=new Array(buffChar.length),n=0;n<buffChar.length;n++)buffCharCoded[n]=String.fromCharCode(buffChar[n]);var str=new String(buffCharCoded.join(""));return{t:"b64",b:byteCoding,d:base64.encode(str),s:array.length}},CodingHandler.prototype.from=function(data){if(void 0===data||null==data)return null;switch(data.t){case"b64":return this.b64.from(data);default:return this.none.from(data)}},CodingHandler.prototype.to=function(array,type,byteCoding){if("number"==typeof array&&(array=[array]),!Array.isArray(array))return console.log("CodingHandler.to only accepts array !"),null;switch(type){case"b64":return this.b64.to(array,byteCoding);case"no":default:return this.none.to(array)}},DiyaSelector.prototype.encode=function(){return new CodingHandler}},{"../../DiyaSelector":19,"base-64":1}]},{},[21])(21)});
