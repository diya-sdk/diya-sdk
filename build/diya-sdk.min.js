!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.d1=e()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){(function(global){!function(root){var freeExports="object"==typeof exports&&exports,freeModule="object"==typeof module&&module&&module.exports==freeExports&&module,freeGlobal="object"==typeof global&&global;(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal)&&(root=freeGlobal);var InvalidCharacterError=function(message){this.message=message};InvalidCharacterError.prototype=new Error,InvalidCharacterError.prototype.name="InvalidCharacterError";var error=function(message){throw new InvalidCharacterError(message)},TABLE="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",REGEX_SPACE_CHARACTERS=/[\t\n\f\r ]/g,decode=function(input){input=String(input).replace(REGEX_SPACE_CHARACTERS,"");var length=input.length;length%4==0&&(input=input.replace(/==?$/,""),length=input.length),(length%4==1||/[^+a-zA-Z0-9/]/.test(input))&&error("Invalid character: the string to be decoded is not correctly encoded.");for(var bitStorage,buffer,bitCounter=0,output="",position=-1;++position<length;)buffer=TABLE.indexOf(input.charAt(position)),bitStorage=bitCounter%4?64*bitStorage+buffer:buffer,bitCounter++%4&&(output+=String.fromCharCode(255&bitStorage>>(-2*bitCounter&6)));return output},encode=function(input){input=String(input),/[^\0-\xFF]/.test(input)&&error("The string to be encoded contains characters outside of the Latin1 range.");for(var a,b,c,buffer,padding=input.length%3,output="",position=-1,length=input.length-padding;++position<length;)a=input.charCodeAt(position)<<16,b=input.charCodeAt(++position)<<8,c=input.charCodeAt(++position),buffer=a+b+c,output+=TABLE.charAt(buffer>>18&63)+TABLE.charAt(buffer>>12&63)+TABLE.charAt(buffer>>6&63)+TABLE.charAt(63&buffer);return 2==padding?(a=input.charCodeAt(position)<<8,b=input.charCodeAt(++position),buffer=a+b,output+=TABLE.charAt(buffer>>10)+TABLE.charAt(buffer>>4&63)+TABLE.charAt(buffer<<2&63)+"="):1==padding&&(buffer=input.charCodeAt(position),output+=TABLE.charAt(buffer>>2)+TABLE.charAt(buffer<<4&63)+"=="),output},base64={encode:encode,decode:decode,version:"0.1.0"};if("function"==typeof define&&"object"==typeof define.amd&&define.amd)define(function(){return base64});else if(freeExports&&!freeExports.nodeType)if(freeModule)freeModule.exports=base64;else for(var key in base64)base64.hasOwnProperty(key)&&(freeExports[key]=base64[key]);else root.base64=base64}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(require,module,exports){function noop(){}var process=module.exports={};process.nextTick=function(){var canSetImmediate="undefined"!=typeof window&&window.setImmediate,canPost="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(canSetImmediate)return function(f){return window.setImmediate(f)};if(canPost){var queue=[];return window.addEventListener("message",function(ev){var source=ev.source;if((source===window||null===source)&&"process-tick"===ev.data&&(ev.stopPropagation(),queue.length>0)){var fn=queue.shift();fn()}},!0),function(fn){queue.push(fn),window.postMessage("process-tick","*")}}return function(fn){setTimeout(fn,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],3:[function(require,module,exports){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},{}],4:[function(require,module,exports){(function(process,global){function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};return array.forEach(function(val,idx){hash[val]=!0}),hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=arrayToHash(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(0>recurseTimes)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}return isNumber(value)?ctx.stylize(""+value,"number"):isBoolean(value)?ctx.stylize(""+value,"boolean"):isNull(value)?ctx.stylize("null","null"):void 0}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;l>i;++i)hasOwnProperty(value,String(i))?output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0)):output.push("");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if(desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]},desc.get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0,length=output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);return length>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||"undefined"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return 10>n?"0"+n.toString(10):n.toString(10)}function timestamp(){var d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));return objects.join(" ")}for(var i=1,args=arguments,len=args.length,str=String(f).replace(formatRegExp,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];len>i;x=args[++i])str+=isNull(x)||!isObject(x)?" "+x:" "+inspect(x);return str},exports.deprecate=function(fn,msg){function deprecated(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(fn,msg).apply(this,arguments)};if(process.noDeprecation===!0)return fn;var warned=!1;return deprecated};var debugEnviron,debugs={};exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":3,_process:2,inherits:5}],5:[function(require,module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],6:[function(require,module,exports){function EventEmitter(){EventEmitter.init.call(this)}var util={};util.isObject=function(arg){return"object"==typeof arg&&null!==arg},util.isNumber=function(arg){return"number"==typeof arg},util.isUndefined=function(arg){return void 0===arg},util.isFunction=function(arg){return"function"==typeof arg},module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.init=function(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(n){if(!util.isNumber(n)||0>n||isNaN(n))throw TypeError("n must be a positive number");return this._maxListeners=n,this},EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(this._events||(this._events={}),"error"===type&&!this._events.error)throw er=arguments[1],er instanceof Error?er:Error('Uncaught, unspecified "error" event.');if(handler=this._events[type],util.isUndefined(handler))return!1;if(util.isFunction(handler))switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];handler.apply(this,args)}else if(util.isObject(handler)){for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];for(listeners=handler.slice(),len=listeners.length,i=0;len>i;i++)listeners[i].apply(this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){var m;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",type,util.isFunction(listener.listener)?listener.listener:listener),this._events[type]?util.isObject(this._events[type])?this._events[type].push(listener):this._events[type]=[this._events[type],listener]:this._events[type]=listener,util.isObject(this._events[type])&&!this._events[type].warned){var m;m=util.isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,m&&m>0&&this._events[type].length>m&&(this._events[type].warned=!0,util.isFunction(console.error)&&console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[type].length),util.isFunction(console.trace)&&console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(type,listener){function g(){this.removeListener(type,g),fired||(fired=!0,listener.apply(this,arguments))}if(!util.isFunction(listener))throw TypeError("listener must be a function");var fired=!1;return g.listener=listener,this.on(type,g),this},EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!util.isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;if(list=this._events[type],length=list.length,position=-1,list===listener||util.isFunction(list.listener)&&list.listener===listener)delete this._events[type],this._events.removeListener&&this.emit("removeListener",type,listener);else if(util.isObject(list)){for(i=length;i-->0;)if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}if(0>position)return this;1===list.length?(list.length=0,delete this._events[type]):list.splice(position,1),this._events.removeListener&&this.emit("removeListener",type,listener)}return this},EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[type]&&delete this._events[type],this;if(0===arguments.length){for(key in this._events)"removeListener"!==key&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events={},this}if(listeners=this._events[type],util.isFunction(listeners))this.removeListener(type,listeners);else if(Array.isArray(listeners))for(;listeners.length;)this.removeListener(type,listeners[listeners.length-1]);return delete this._events[type],this},EventEmitter.prototype.listeners=function(type){var ret;return ret=this._events&&this._events[type]?util.isFunction(this._events[type])?[this._events[type]]:this._events[type].slice():[]},EventEmitter.listenerCount=function(emitter,type){var ret;return ret=emitter._events&&emitter._events[type]?util.isFunction(emitter._events[type])?1:emitter._events[type].length:0}},{}],7:[function(require,module,exports){(function(process){!function(definition){"use strict";if("function"==typeof bootstrap)bootstrap("promise",definition);else if("object"==typeof exports&&"object"==typeof module)module.exports=definition();else if("function"==typeof define&&define.amd)define(definition);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=definition}else{if("undefined"==typeof window&&"undefined"==typeof self)throw new Error("This environment was not anticipated by Q. Please file a bug.");var global="undefined"!=typeof window?window:self,previousQ=global.Q;global.Q=definition(),global.Q.noConflict=function(){return global.Q=previousQ,this}}}(function(){"use strict";function uncurryThis(f){return function(){return call.apply(f,arguments)}}function isObject(value){return value===Object(value)}function isStopIteration(exception){return"[object StopIteration]"===object_toString(exception)||exception instanceof QReturnValue}function makeStackTraceLong(error,promise){if(hasStacks&&promise.stack&&"object"==typeof error&&null!==error&&error.stack&&-1===error.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var stacks=[],p=promise;p;p=p.source)p.stack&&stacks.unshift(p.stack);stacks.unshift(error.stack);var concatedStacks=stacks.join("\n"+STACK_JUMP_SEPARATOR+"\n");error.stack=filterStackString(concatedStacks)}}function filterStackString(stackString){for(var lines=stackString.split("\n"),desiredLines=[],i=0;i<lines.length;++i){var line=lines[i];isInternalFrame(line)||isNodeFrame(line)||!line||desiredLines.push(line)}return desiredLines.join("\n")}function isNodeFrame(stackLine){return-1!==stackLine.indexOf("(module.js:")||-1!==stackLine.indexOf("(node.js:")}function getFileNameAndLineNumber(stackLine){var attempt1=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);if(attempt1)return[attempt1[1],Number(attempt1[2])];var attempt2=/at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);if(attempt2)return[attempt2[1],Number(attempt2[2])];var attempt3=/.*@(.+):(\d+)$/.exec(stackLine);return attempt3?[attempt3[1],Number(attempt3[2])]:void 0}function isInternalFrame(stackLine){var fileNameAndLineNumber=getFileNameAndLineNumber(stackLine);if(!fileNameAndLineNumber)return!1;var fileName=fileNameAndLineNumber[0],lineNumber=fileNameAndLineNumber[1];return fileName===qFileName&&lineNumber>=qStartingLine&&qEndingLine>=lineNumber}function captureLine(){if(hasStacks)try{throw new Error}catch(e){var lines=e.stack.split("\n"),firstLine=lines[0].indexOf("@")>0?lines[1]:lines[2],fileNameAndLineNumber=getFileNameAndLineNumber(firstLine);if(!fileNameAndLineNumber)return;return qFileName=fileNameAndLineNumber[0],fileNameAndLineNumber[1]}}function deprecate(callback,name,alternative){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(name+" is deprecated, use "+alternative+" instead.",new Error("").stack),callback.apply(callback,arguments)}}function Q(value){return value instanceof Promise?value:isPromiseAlike(value)?coerce(value):fulfill(value)}function defer(){function become(newPromise){resolvedPromise=newPromise,promise.source=newPromise,array_reduce(messages,function(undefined,message){Q.nextTick(function(){newPromise.promiseDispatch.apply(newPromise,message)})},void 0),messages=void 0,progressListeners=void 0}var resolvedPromise,messages=[],progressListeners=[],deferred=object_create(defer.prototype),promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,operands){var args=array_slice(arguments);messages?(messages.push(args),"when"===op&&operands[1]&&progressListeners.push(operands[1])):Q.nextTick(function(){resolvedPromise.promiseDispatch.apply(resolvedPromise,args)})},promise.valueOf=function(){if(messages)return promise;var nearerValue=nearer(resolvedPromise);return isPromise(nearerValue)&&(resolvedPromise=nearerValue),nearerValue},promise.inspect=function(){return resolvedPromise?resolvedPromise.inspect():{state:"pending"}},Q.longStackSupport&&hasStacks)try{throw new Error}catch(e){promise.stack=e.stack.substring(e.stack.indexOf("\n")+1)}return deferred.promise=promise,deferred.resolve=function(value){resolvedPromise||become(Q(value))},deferred.fulfill=function(value){resolvedPromise||become(fulfill(value))},deferred.reject=function(reason){resolvedPromise||become(reject(reason))},deferred.notify=function(progress){resolvedPromise||array_reduce(progressListeners,function(undefined,progressListener){Q.nextTick(function(){progressListener(progress)})},void 0)},deferred}function promise(resolver){if("function"!=typeof resolver)throw new TypeError("resolver must be a function.");var deferred=defer();try{resolver(deferred.resolve,deferred.reject,deferred.notify)}catch(reason){deferred.reject(reason)}return deferred.promise}function race(answerPs){return promise(function(resolve,reject){for(var i=0,len=answerPs.length;len>i;i++)Q(answerPs[i]).then(resolve,reject)})}function Promise(descriptor,fallback,inspect){void 0===fallback&&(fallback=function(op){return reject(new Error("Promise does not support operation: "+op))}),void 0===inspect&&(inspect=function(){return{state:"unknown"}});var promise=object_create(Promise.prototype);if(promise.promiseDispatch=function(resolve,op,args){var result;try{result=descriptor[op]?descriptor[op].apply(promise,args):fallback.call(promise,op,args)}catch(exception){result=reject(exception)}resolve&&resolve(result)},promise.inspect=inspect,inspect){var inspected=inspect();"rejected"===inspected.state&&(promise.exception=inspected.reason),promise.valueOf=function(){var inspected=inspect();return"pending"===inspected.state||"rejected"===inspected.state?promise:inspected.value}}return promise}function when(value,fulfilled,rejected,progressed){return Q(value).then(fulfilled,rejected,progressed)}function nearer(value){if(isPromise(value)){var inspected=value.inspect();if("fulfilled"===inspected.state)return inspected.value}return value}function isPromise(object){return object instanceof Promise}function isPromiseAlike(object){return isObject(object)&&"function"==typeof object.then}function isPending(object){return isPromise(object)&&"pending"===object.inspect().state}function isFulfilled(object){return!isPromise(object)||"fulfilled"===object.inspect().state}function isRejected(object){return isPromise(object)&&"rejected"===object.inspect().state}function resetUnhandledRejections(){unhandledReasons.length=0,unhandledRejections.length=0,trackUnhandledRejections||(trackUnhandledRejections=!0)}function trackRejection(promise,reason){trackUnhandledRejections&&("object"==typeof process&&"function"==typeof process.emit&&Q.nextTick.runAfter(function(){-1!==array_indexOf(unhandledRejections,promise)&&(process.emit("unhandledRejection",reason,promise),reportedUnhandledRejections.push(promise))}),unhandledRejections.push(promise),reason&&"undefined"!=typeof reason.stack?unhandledReasons.push(reason.stack):unhandledReasons.push("(no stack) "+reason))}function untrackRejection(promise){if(trackUnhandledRejections){var at=array_indexOf(unhandledRejections,promise);-1!==at&&("object"==typeof process&&"function"==typeof process.emit&&Q.nextTick.runAfter(function(){var atReport=array_indexOf(reportedUnhandledRejections,promise);-1!==atReport&&(process.emit("rejectionHandled",unhandledReasons[at],promise),reportedUnhandledRejections.splice(atReport,1))}),unhandledRejections.splice(at,1),unhandledReasons.splice(at,1))}}function reject(reason){var rejection=Promise({when:function(rejected){return rejected&&untrackRejection(this),rejected?rejected(reason):this}},function(){return this},function(){return{state:"rejected",reason:reason}});return trackRejection(rejection,reason),rejection}function fulfill(value){return Promise({when:function(){return value},get:function(name){return value[name]},set:function(name,rhs){value[name]=rhs},"delete":function(name){delete value[name]},post:function(name,args){return null===name||void 0===name?value.apply(void 0,args):value[name].apply(value,args)},apply:function(thisp,args){return value.apply(thisp,args)},keys:function(){return object_keys(value)}},void 0,function(){return{state:"fulfilled",value:value}})}function coerce(promise){var deferred=defer();return Q.nextTick(function(){try{promise.then(deferred.resolve,deferred.reject,deferred.notify)}catch(exception){deferred.reject(exception)}}),deferred.promise}function master(object){return Promise({isDef:function(){}},function(op,args){return dispatch(object,op,args)},function(){return Q(object).inspect()})}function spread(value,fulfilled,rejected){return Q(value).spread(fulfilled,rejected)}function async(makeGenerator){return function(){function continuer(verb,arg){var result;if("undefined"==typeof StopIteration){try{result=generator[verb](arg)}catch(exception){return reject(exception)}return result.done?Q(result.value):when(result.value,callback,errback)}try{result=generator[verb](arg)}catch(exception){return isStopIteration(exception)?Q(exception.value):reject(exception)}return when(result,callback,errback)}var generator=makeGenerator.apply(this,arguments),callback=continuer.bind(continuer,"next"),errback=continuer.bind(continuer,"throw");return callback()}}function spawn(makeGenerator){Q.done(Q.async(makeGenerator)())}function _return(value){throw new QReturnValue(value)}function promised(callback){return function(){return spread([this,all(arguments)],function(self,args){return callback.apply(self,args)})}}function dispatch(object,op,args){return Q(object).dispatch(op,args)}function all(promises){return when(promises,function(promises){var pendingCount=0,deferred=defer();return array_reduce(promises,function(undefined,promise,index){var snapshot;isPromise(promise)&&"fulfilled"===(snapshot=promise.inspect()).state?promises[index]=snapshot.value:(++pendingCount,when(promise,function(value){promises[index]=value,0===--pendingCount&&deferred.resolve(promises)},deferred.reject,function(progress){deferred.notify({index:index,value:progress})}))},void 0),0===pendingCount&&deferred.resolve(promises),deferred.promise})}function any(promises){if(0===promises.length)return Q.resolve();var deferred=Q.defer(),pendingCount=0;return array_reduce(promises,function(prev,current,index){function onFulfilled(result){deferred.resolve(result)}function onRejected(){pendingCount--,0===pendingCount&&deferred.reject(new Error("Can't get fulfillment value from any promise, all promises were rejected."))}function onProgress(progress){deferred.notify({index:index,value:progress})}var promise=promises[index];pendingCount++,when(promise,onFulfilled,onRejected,onProgress)},void 0),deferred.promise}function allResolved(promises){return when(promises,function(promises){return promises=array_map(promises,Q),when(all(array_map(promises,function(promise){return when(promise,noop,noop)})),function(){return promises})})}function allSettled(promises){return Q(promises).allSettled()}function progress(object,progressed){return Q(object).then(void 0,void 0,progressed)}function nodeify(object,nodeback){return Q(object).nodeify(nodeback)}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qFileName,QReturnValue,qStartingLine=captureLine(),noop=function(){},nextTick=function(){function flush(){for(var task,domain;head.next;)head=head.next,task=head.task,head.task=void 0,domain=head.domain,domain&&(head.domain=void 0,domain.enter()),runSingle(task,domain);for(;laterQueue.length;)task=laterQueue.pop(),runSingle(task);flushing=!1}function runSingle(task,domain){try{task()}catch(e){if(isNodeJS)throw domain&&domain.exit(),setTimeout(flush,0),domain&&domain.enter(),e;setTimeout(function(){throw e},0)}domain&&domain.exit()}var head={task:void 0,next:null},tail=head,flushing=!1,requestTick=void 0,isNodeJS=!1,laterQueue=[];if(nextTick=function(task){tail=tail.next={task:task,domain:isNodeJS&&process.domain,next:null},flushing||(flushing=!0,requestTick())},"object"==typeof process&&"[object process]"===process.toString()&&process.nextTick)isNodeJS=!0,requestTick=function(){process.nextTick(flush)};else if("function"==typeof setImmediate)requestTick="undefined"!=typeof window?setImmediate.bind(window,flush):function(){setImmediate(flush)};else if("undefined"!=typeof MessageChannel){var channel=new MessageChannel;channel.port1.onmessage=function(){requestTick=requestPortTick,channel.port1.onmessage=flush,flush()};var requestPortTick=function(){channel.port2.postMessage(0)};requestTick=function(){setTimeout(flush,0),requestPortTick()}}else requestTick=function(){setTimeout(flush,0)};return nextTick.runAfter=function(task){laterQueue.push(task),flushing||(flushing=!0,requestTick())},nextTick}(),call=Function.call,array_slice=uncurryThis(Array.prototype.slice),array_reduce=uncurryThis(Array.prototype.reduce||function(callback,basis){var index=0,length=this.length;if(1===arguments.length)for(;;){if(index in this){basis=this[index++];break}if(++index>=length)throw new TypeError}for(;length>index;index++)index in this&&(basis=callback(basis,this[index],index));return basis}),array_indexOf=uncurryThis(Array.prototype.indexOf||function(value){for(var i=0;i<this.length;i++)if(this[i]===value)return i;return-1}),array_map=uncurryThis(Array.prototype.map||function(callback,thisp){var self=this,collect=[];return array_reduce(self,function(undefined,value,index){collect.push(callback.call(thisp,value,index,self))},void 0),
collect}),object_create=Object.create||function(prototype){function Type(){}return Type.prototype=prototype,new Type},object_hasOwnProperty=uncurryThis(Object.prototype.hasOwnProperty),object_keys=Object.keys||function(object){var keys=[];for(var key in object)object_hasOwnProperty(object,key)&&keys.push(key);return keys},object_toString=uncurryThis(Object.prototype.toString);QReturnValue="undefined"!=typeof ReturnValue?ReturnValue:function(value){this.value=value};var STACK_JUMP_SEPARATOR="From previous event:";Q.resolve=Q,Q.nextTick=nextTick,Q.longStackSupport=!1,"object"==typeof process&&process&&process.env&&process.env.Q_DEBUG&&(Q.longStackSupport=!0),Q.defer=defer,defer.prototype.makeNodeResolver=function(){var self=this;return function(error,value){error?self.reject(error):arguments.length>2?self.resolve(array_slice(arguments,1)):self.resolve(value)}},Q.Promise=promise,Q.promise=promise,promise.race=race,promise.all=all,promise.reject=reject,promise.resolve=Q,Q.passByCopy=function(object){return object},Promise.prototype.passByCopy=function(){return this},Q.join=function(x,y){return Q(x).join(y)},Promise.prototype.join=function(that){return Q([this,that]).spread(function(x,y){if(x===y)return x;throw new Error("Can't join: not the same: "+x+" "+y)})},Q.race=race,Promise.prototype.race=function(){return this.then(Q.race)},Q.makePromise=Promise,Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(fulfilled,rejected,progressed){function _fulfilled(value){try{return"function"==typeof fulfilled?fulfilled(value):value}catch(exception){return reject(exception)}}function _rejected(exception){if("function"==typeof rejected){makeStackTraceLong(exception,self);try{return rejected(exception)}catch(newException){return reject(newException)}}return reject(exception)}function _progressed(value){return"function"==typeof progressed?progressed(value):value}var self=this,deferred=defer(),done=!1;return Q.nextTick(function(){self.promiseDispatch(function(value){done||(done=!0,deferred.resolve(_fulfilled(value)))},"when",[function(exception){done||(done=!0,deferred.resolve(_rejected(exception)))}])}),self.promiseDispatch(void 0,"when",[void 0,function(value){var newValue,threw=!1;try{newValue=_progressed(value)}catch(e){if(threw=!0,!Q.onerror)throw e;Q.onerror(e)}threw||deferred.notify(newValue)}]),deferred.promise},Q.tap=function(promise,callback){return Q(promise).tap(callback)},Promise.prototype.tap=function(callback){return callback=Q(callback),this.then(function(value){return callback.fcall(value).thenResolve(value)})},Q.when=when,Promise.prototype.thenResolve=function(value){return this.then(function(){return value})},Q.thenResolve=function(promise,value){return Q(promise).thenResolve(value)},Promise.prototype.thenReject=function(reason){return this.then(function(){throw reason})},Q.thenReject=function(promise,reason){return Q(promise).thenReject(reason)},Q.nearer=nearer,Q.isPromise=isPromise,Q.isPromiseAlike=isPromiseAlike,Q.isPending=isPending,Promise.prototype.isPending=function(){return"pending"===this.inspect().state},Q.isFulfilled=isFulfilled,Promise.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},Q.isRejected=isRejected,Promise.prototype.isRejected=function(){return"rejected"===this.inspect().state};var unhandledReasons=[],unhandledRejections=[],reportedUnhandledRejections=[],trackUnhandledRejections=!0;Q.resetUnhandledRejections=resetUnhandledRejections,Q.getUnhandledReasons=function(){return unhandledReasons.slice()},Q.stopUnhandledRejectionTracking=function(){resetUnhandledRejections(),trackUnhandledRejections=!1},resetUnhandledRejections(),Q.reject=reject,Q.fulfill=fulfill,Q.master=master,Q.spread=spread,Promise.prototype.spread=function(fulfilled,rejected){return this.all().then(function(array){return fulfilled.apply(void 0,array)},rejected)},Q.async=async,Q.spawn=spawn,Q["return"]=_return,Q.promised=promised,Q.dispatch=dispatch,Promise.prototype.dispatch=function(op,args){var self=this,deferred=defer();return Q.nextTick(function(){self.promiseDispatch(deferred.resolve,op,args)}),deferred.promise},Q.get=function(object,key){return Q(object).dispatch("get",[key])},Promise.prototype.get=function(key){return this.dispatch("get",[key])},Q.set=function(object,key,value){return Q(object).dispatch("set",[key,value])},Promise.prototype.set=function(key,value){return this.dispatch("set",[key,value])},Q.del=Q["delete"]=function(object,key){return Q(object).dispatch("delete",[key])},Promise.prototype.del=Promise.prototype["delete"]=function(key){return this.dispatch("delete",[key])},Q.mapply=Q.post=function(object,name,args){return Q(object).dispatch("post",[name,args])},Promise.prototype.mapply=Promise.prototype.post=function(name,args){return this.dispatch("post",[name,args])},Q.send=Q.mcall=Q.invoke=function(object,name){return Q(object).dispatch("post",[name,array_slice(arguments,2)])},Promise.prototype.send=Promise.prototype.mcall=Promise.prototype.invoke=function(name){return this.dispatch("post",[name,array_slice(arguments,1)])},Q.fapply=function(object,args){return Q(object).dispatch("apply",[void 0,args])},Promise.prototype.fapply=function(args){return this.dispatch("apply",[void 0,args])},Q["try"]=Q.fcall=function(object){return Q(object).dispatch("apply",[void 0,array_slice(arguments,1)])},Promise.prototype.fcall=function(){return this.dispatch("apply",[void 0,array_slice(arguments)])},Q.fbind=function(object){var promise=Q(object),args=array_slice(arguments,1);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Promise.prototype.fbind=function(){var promise=this,args=array_slice(arguments);return function(){return promise.dispatch("apply",[this,args.concat(array_slice(arguments))])}},Q.keys=function(object){return Q(object).dispatch("keys",[])},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Q.all=all,Promise.prototype.all=function(){return all(this)},Q.any=any,Promise.prototype.any=function(){return any(this)},Q.allResolved=deprecate(allResolved,"allResolved","allSettled"),Promise.prototype.allResolved=function(){return allResolved(this)},Q.allSettled=allSettled,Promise.prototype.allSettled=function(){return this.then(function(promises){return all(array_map(promises,function(promise){function regardless(){return promise.inspect()}return promise=Q(promise),promise.then(regardless,regardless)}))})},Q.fail=Q["catch"]=function(object,rejected){return Q(object).then(void 0,rejected)},Promise.prototype.fail=Promise.prototype["catch"]=function(rejected){return this.then(void 0,rejected)},Q.progress=progress,Promise.prototype.progress=function(progressed){return this.then(void 0,void 0,progressed)},Q.fin=Q["finally"]=function(object,callback){return Q(object)["finally"](callback)},Promise.prototype.fin=Promise.prototype["finally"]=function(callback){return callback=Q(callback),this.then(function(value){return callback.fcall().then(function(){return value})},function(reason){return callback.fcall().then(function(){throw reason})})},Q.done=function(object,fulfilled,rejected,progress){return Q(object).done(fulfilled,rejected,progress)},Promise.prototype.done=function(fulfilled,rejected,progress){var onUnhandledError=function(error){Q.nextTick(function(){if(makeStackTraceLong(error,promise),!Q.onerror)throw error;Q.onerror(error)})},promise=fulfilled||rejected||progress?this.then(fulfilled,rejected,progress):this;"object"==typeof process&&process&&process.domain&&(onUnhandledError=process.domain.bind(onUnhandledError)),promise.then(void 0,onUnhandledError)},Q.timeout=function(object,ms,error){return Q(object).timeout(ms,error)},Promise.prototype.timeout=function(ms,error){var deferred=defer(),timeoutId=setTimeout(function(){error&&"string"!=typeof error||(error=new Error(error||"Timed out after "+ms+" ms"),error.code="ETIMEDOUT"),deferred.reject(error)},ms);return this.then(function(value){clearTimeout(timeoutId),deferred.resolve(value)},function(exception){clearTimeout(timeoutId),deferred.reject(exception)},deferred.notify),deferred.promise},Q.delay=function(object,timeout){return void 0===timeout&&(timeout=object,object=void 0),Q(object).delay(timeout)},Promise.prototype.delay=function(timeout){return this.then(function(value){var deferred=defer();return setTimeout(function(){deferred.resolve(value)},timeout),deferred.promise})},Q.nfapply=function(callback,args){return Q(callback).nfapply(args)},Promise.prototype.nfapply=function(args){var deferred=defer(),nodeArgs=array_slice(args);return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfcall=function(callback){var args=array_slice(arguments,1);return Q(callback).nfapply(args)},Promise.prototype.nfcall=function(){var nodeArgs=array_slice(arguments),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.fapply(nodeArgs).fail(deferred.reject),deferred.promise},Q.nfbind=Q.denodeify=function(callback){var baseArgs=array_slice(arguments,1);return function(){var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(callback).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nfbind=Promise.prototype.denodeify=function(){var args=array_slice(arguments);return args.unshift(this),Q.denodeify.apply(void 0,args)},Q.nbind=function(callback,thisp){var baseArgs=array_slice(arguments,2);return function(){function bound(){return callback.apply(thisp,arguments)}var nodeArgs=baseArgs.concat(array_slice(arguments)),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(bound).fapply(nodeArgs).fail(deferred.reject),deferred.promise}},Promise.prototype.nbind=function(){var args=array_slice(arguments,0);return args.unshift(this),Q.nbind.apply(void 0,args)},Q.nmapply=Q.npost=function(object,name,args){return Q(object).npost(name,args)},Promise.prototype.nmapply=Promise.prototype.npost=function(name,args){var nodeArgs=array_slice(args||[]),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nsend=Q.nmcall=Q.ninvoke=function(object,name){var nodeArgs=array_slice(arguments,2),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),Q(object).dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Promise.prototype.nsend=Promise.prototype.nmcall=Promise.prototype.ninvoke=function(name){var nodeArgs=array_slice(arguments,1),deferred=defer();return nodeArgs.push(deferred.makeNodeResolver()),this.dispatch("post",[name,nodeArgs]).fail(deferred.reject),deferred.promise},Q.nodeify=nodeify,Promise.prototype.nodeify=function(nodeback){return nodeback?void this.then(function(value){Q.nextTick(function(){nodeback(null,value)})},function(error){Q.nextTick(function(){nodeback(error)})}):this},Q.noConflict=function(){throw new Error("Q.noConflict only works when Q is used as a global")};var qEndingLine=captureLine();return Q})}).call(this,require("_process"))},{_process:2}],8:[function(require,module,exports){function DiyaNode(){EventEmitter.call(this),this._status="closed",this._addr=null,this._socket=null,this._nextId=0,this._connectionDeferred=null,this._disconnectionDeferred=null,this._pendingMessages=[],this._peers=[],this._reconnectTimeout=1e3,this._connectTimeout=5e3}function SocketHandler(WSocket,addr,timeout){var that=this;this.addr=addr,WSocket?this._WSocket=WSocket:this._WSocket||(this._WSocket=window.WebSocket),WSocket=this._WSocket,this._status="opening";try{this._socket=0===addr.indexOf("wss://")?new WSocket(addr,void 0,{rejectUnauthorized:!1}):new WSocket(addr),this._socketOpenCallback=this._onopen.bind(this),this._socketCloseCallback=this._onclose.bind(this),this._socketMessageCallback=this._onmessage.bind(this),this._socket.addEventListener("open",this._socketOpenCallback),this._socket.addEventListener("close",this._socketCloseCallback),this._socket.addEventListener("message",this._socketMessageCallback),this._socket.addEventListener("error",function(err){Logger.error("[WS] error : "+JSON.stringify(err)),that._socket.close()}),setTimeout(function(){"opened"!==that._status&&"closed"!==that._status&&(Logger.log("d1: "+that.addr+" timed out while connecting"),that.close(),that.emit("timeout",that._socket))},timeout)}catch(e){Logger.error(e.stack),that.close()}}var Q=require("q"),EventEmitter=require("node-event-emitter"),inherits=require("inherits"),DEBUG=!1,Logger={log:function(message){DEBUG&&console.log(message)},error:function(message){DEBUG&&console.error(message)}};inherits(DiyaNode,EventEmitter),DiyaNode.prototype.addr=function(){return this._addr},DiyaNode.prototype.peers=function(){return this._peers},DiyaNode.prototype.self=function(){return this._self},DiyaNode.prototype.setSecured=function(bSecured){this._secured=bSecured!==!1},DiyaNode.prototype.setWSocket=function(WSocket){this._WSocket=WSocket},DiyaNode.prototype.connect=function(addr,WSocket){var that=this;if(this.bDontReconnected=!1,WSocket?this._WSocket=WSocket:this._WSocket||(this._WSocket=window.WebSocket),WSocket=this._WSocket,0===addr.indexOf("ws://")&&this._secured)return Q.reject("Please use a secured connection ("+addr+")");if(0===addr.indexOf("wss://")&&this._secured===!1)return Q.reject("Please use a non-secured connection ("+addr+")");if(0!==addr.indexOf("ws://")&&0!==addr.indexOf("wss://")&&(addr=this._secured?"wss://"+addr:"ws://"+addr),this._addr===addr){if("opened"===this._status)return Q(this.self());if(this._connectionDeferred&&this._connectionDeferred.promise&&this._connectionDeferred.promise.isPending())return this._connectionDeferred.promise}return this.close().then(function(){that._addr=addr,that._connectionDeferred=Q.defer(),Logger.log("d1: connect to "+that._addr);var sock=new SocketHandler(WSocket,that._addr,that._connectTimeout);return that._socketHandler||(that._socketHandler=sock),sock.on("open",function(){return that._socketHandler!==sock?void console.log("[d1] Websocket responded but already connected to a different one"):(that._socketHandler=sock,that._status="opened",void that._setupPingResponse())}),sock.on("close",function(){that._socketHandler===sock&&(that._socketHandler=null,that._status="closed",that._stopPingResponse(),that._onclose(),that._connectionDeferred&&(that._connectionDeferred.reject("closed"),that._connectionDeferred=null))}),sock.on("timeout",function(){that._socketHandler===sock&&(that._socketHandler=null,that._status="closed",that._connectionDeferred&&(that._connectionDeferred.reject("closed"),that._connectionDeferred=null))}),sock.on("message",function(message){that._onmessage(message)}),that._connectionDeferred.promise})},DiyaNode.prototype.disconnect=function(){return this.bDontReconnected=!0,this.close()},DiyaNode.prototype.close=function(){return this._stopPingResponse(),this._socketHandler?this._socketHandler.close():Q()},DiyaNode.prototype.isConnected=function(){return this._socketHandler&&this._socketHandler.isConnected()},DiyaNode.prototype.request=function(params,callback,timeout,options){var that=this;if(options||(options={}),params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}if(!params.service)return Logger.error("No service defined for request !"),!1;var message=this._createMessage(params,"Request");return this._appendMessage(message,callback),"function"==typeof options.callback_partial&&(this._pendingMessages[message.id].callback_partial=options.callback_partial),message.options=options,!isNaN(timeout)&&timeout>0&&setTimeout(function(){var handler=that._removeMessage(message.id);handler&&that._notifyListener(handler,"Timeout exceeded ("+timeout+"ms) !")},timeout),this._send(message)?!0:(this._removeMessage(message.id),console.error("Cannot send request !"),!1)},DiyaNode.prototype.subscribe=function(params,callback){if(params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}if(!params.service)return Logger.error("No service defined for subscription !"),-1;var message=this._createMessage(params,"Subscription");return this._appendMessage(message,callback),this._send(message)?message.id:(this._removeMessage(message.id),Logger.error("Cannot send subscription !"),-1)},DiyaNode.prototype.unsubscribe=function(subId){if(this._pendingMessages[subId]&&"Subscription"===this._pendingMessages[subId].type){var subscription=this._removeMessage(subId),message=this._createMessage({target:subscription.target,data:{subId:subId}},"Unsubscribe");return this._send(message)?!0:(Logger.error("Cannot send unsubscribe !"),!1)}return!1},DiyaNode.prototype._appendMessage=function(message,callback){this._pendingMessages[message.id]={callback:callback,type:message.type,target:message.target}},DiyaNode.prototype._removeMessage=function(messageId){var handler=this._pendingMessages[messageId];return handler?(delete this._pendingMessages[messageId],handler):null},DiyaNode.prototype._clearMessages=function(err,data){for(var messageId in this._pendingMessages){var handler=this._removeMessage(messageId);this._notifyListener(handler,err,data)}},DiyaNode.prototype._clearPeers=function(){for(;this._peers.length;)this.emit("peer-disconnected",this._peers.pop())},DiyaNode.prototype._getMessageHandler=function(messageId){var handler=this._pendingMessages[messageId];return handler?handler:null},DiyaNode.prototype._notifyListener=function(handler,error,data){if(handler&&"function"==typeof handler.callback){error=error?error:null,data=data?data:null;try{handler.callback(error,data)}catch(e){console.log(e.stack)}}},DiyaNode.prototype._send=function(message){return this._socketHandler.send(message)},DiyaNode.prototype._setupPingResponse=function(){function checkPing(){var curTime=(new Date).getTime();curTime-that._lastPing>that._pingTimeout?(that._forceClose(),Logger.log("d1:  timed out !")):(Logger.log("d1: last ping ok"),that._pingSetTimeoutId=setTimeout(checkPing,Math.round(that._pingTimeout/2.1)))}var that=this;this._pingTimeout=15e3,this._lastPing=(new Date).getTime(),checkPing()},DiyaNode.prototype._stopPingResponse=function(){clearTimeout(this._pingSetTimeoutId)},DiyaNode.prototype._forceClose=function(){this._socketHandler.close(),this._onclose()},DiyaNode.prototype._onmessage=function(message){if(isNaN(message.id))return this._handleInternalMessage(message);var handler=this._getMessageHandler(message.id);if(handler)switch(handler.type){case"Request":this._handleRequest(handler,message);break;case"Subscription":this._handleSubscription(handler,message)}},DiyaNode.prototype._onclose=function(){var that=this;this._clearMessages("PeerDisconnected"),this._clearPeers(),Logger.log("d1: connection lost, try reconnecting"),setTimeout(function(){that.connect(that._addr,that._WSocket)["catch"](function(err){})},that._reconnectTimeout),this.emit("close",this._addr)},DiyaNode.prototype._handleInternalMessage=function(message){switch(message.type){case"PeerConnected":this._handlePeerConnected(message);break;case"PeerDisconnected":this._handlePeerDisconnected(message);break;case"Handshake":this._handleHandshake(message);break;case"Ping":this._handlePing(message)}},DiyaNode.prototype._handlePing=function(message){message.type="Pong",this._lastPing=(new Date).getTime(),this._send(message)},DiyaNode.prototype._handleHandshake=function(message){if(void 0===message.peers||"string"!=typeof message.self)return void Logger.error("Missing arguments for Handshake message, dropping...");this._self=message.self;for(var i=0;i<message.peers.length;i++)this._peers.push(message.peers[i]),this.emit("peer-connected",message.peers[i]);this._connectionDeferred.resolve(this.self()),this.emit("open",this._addr),this._status="opened",this._connectionDeferred=null},DiyaNode.prototype._handlePeerConnected=function(message){return void 0===message.peerId?void Logger.error("Missing arguments for PeerConnected message, dropping..."):(this._peers.push(message.peerId),void this.emit("peer-connected",message.peerId))},DiyaNode.prototype._handlePeerDisconnected=function(message){if(void 0===message.peerId)return void Logger.error("Missing arguments for PeerDisconnected Message, dropping...");for(var messageId in this._pendingMessages){var handler=this._getMessageHandler(messageId);handler&&handler.target===message.peerId&&(this._removeMessage(messageId),this._notifyListener(handler,"PeerDisconnected",null))}for(var i=this._peers.length-1;i>=0;i--)if(this._peers[i]===message.peerId){this._peers.splice(i,1);break}this.emit("peer-disconnected",message.peerId)},DiyaNode.prototype._handleRequest=function(handler,message){if("PartialAnswer"===message.type){if("function"==typeof this._pendingMessages[message.id].callback_partial){var error=message.error?message.error:null,data=message.data?message.data:null;this._pendingMessages[message.id].callback_partial(error,data)}}else this._removeMessage(message.id),this._notifyListener(handler,message.error,message.data)},DiyaNode.prototype._handleSubscription=function(handler,message){"closed"===message.result&&(this._removeMessage(message.id),message.error="SubscriptionClosed"),this._notifyListener(handler,message.error,message.data?message.data:null)},inherits(SocketHandler,EventEmitter),SocketHandler.prototype.close=function(){return this._disconnectionDeferred&&this._disconnectionDeferred.promise?this._disconnectionDeferred.promise:(this._disconnectionDeferred=Q.defer(),this._status="closing",this._socket&&this._socket.close(),this._disconnectionDeferred.promise)},SocketHandler.prototype.send=function(message){try{var data=JSON.stringify(message)}catch(err){return console.error("Cannot serialize message"),!1}try{this._socket.send(data)}catch(err){return console.error("Cannot send message"),console.error(err),!1}return!0},SocketHandler.prototype.isConnected=function(){return this._socket.readyState==this._WSocket.OPEN&&"opened"===this._status},SocketHandler.prototype._onopen=function(){this._status="opened",this.emit("open",this._socket)},SocketHandler.prototype._onclose=function(){this._status="closed",this.unregisterCallbacks(),this.emit("close",this._socket),this._disconnectionDeferred&&this._disconnectionDeferred.promise&&this._disconnectionDeferred.resolve()},SocketHandler.prototype._onmessage=function(evt){try{var message=JSON.parse(evt.data);this.emit("message",message)}catch(err){Logger.error("[WS] cannot parse message, dropping...")}},SocketHandler.prototype.unregisterCallbacks=function(){this._socket&&"function"==typeof this._socket.removeEventListener?(this._socket.removeEventListener("open",this._socketOpenCallback),this._socket.removeEventListener("close",this._socketCloseCallback),this._socket.removeEventListener("message",this._socketMessageCallback)):this._socket&&"function"==typeof this._socket.removeAllListeners&&this._socket.removeAllListeners()},DiyaNode.prototype._createMessage=function(params,type){return!params||!type||"Request"!==type&&"Subscription"!==type&&"Unsubscribe"!==type?null:{type:type,id:this._generateId(),service:params.service,target:params.target,token:params.token,func:params.func,obj:params.obj,data:params.data}},DiyaNode.prototype._generateId=function(){var id=this._nextId;return this._nextId++,id},module.exports=DiyaNode},{inherits:5,"node-event-emitter":6,q:7}],9:[function(require,module,exports){function d1(selector){return new DiyaSelector(selector)}function DiyaSelector(selector){EventEmitter.call(this),this._selector=selector,this._listenerCount=0,this._listenCallback=null,this._callbackAttached=!1}function match(selector,str){return selector?"#self"===selector?connection&&str===connection.self():selector.not?!match(selector.not,str):"String"===selector.constructor.name?matchString(selector,str):"RegExp"===selector.constructor.name?matchRegExp(selector,str):Array.isArray(selector)?matchArray(selector,str):!1:!1}function matchString(selector,str){return selector===str}function matchRegExp(selector,str){return str.match(selector)}function matchArray(selector,str){for(var i=0;i<selector.length;i++)if(selector[i]===str)return!0;return!1}function Subscription(selector,params,callback,options){var that=this;return this.selector=selector,this.params=params,this.callback=callback,this.options=options,this.subIds=[],this.doSubscribe=function(peerId){that.subIds.push(that._addSubscription(peerId)),that.state="open"},this.options&&this.options.auto?this.selector.on("peer-connected",this.doSubscribe):this.selector.each(this.doSubscribe),this}var Q=require("q"),EventEmitter=require("node-event-emitter"),inherits=require("inherits"),DiyaNode=require("./DiyaNode"),connection=new DiyaNode,token=(new EventEmitter,null),_user=null,_pass=null;d1.DiyaNode=DiyaNode,d1.DiyaSelector=DiyaSelector,d1.connect=function(addr,WSocket){return connection.connect(addr,WSocket)},d1.disconnect=function(){return token=null,connection.disconnect()},d1.isConnected=function(){return connection.isConnected()},d1.peers=function(){return connection.peers()},d1.self=function(){return connection.self()},d1.addr=function(){return connection.addr()},d1.user=function(){return _user},d1.pass=function(){return _pass},d1.isAuthenticated=function(){return null!=token},d1.tryConnect=function(servers,WSocket){function tc(i){d1.connect(servers[i],WSocket).then(function(e){return deferred.resolve(servers[i])})["catch"](function(e){d1.disconnect().then(function(){return i++,i<servers.length?void setTimeout(function(){tc(i)},100):deferred.reject("Timeout")})})}var deferred=Q.defer();return tc(0),deferred.promise},d1.currentServer=function(){return connection._addr},d1.on=function(event,callback){return connection.on(event,callback),d1},d1.connectAsUser=function(ip,user,password,WSocket){return d1.connect(ip,WSocket).then(function(){return d1("#self").auth(user,password)})},d1.deauthenticate=function(){token=null,_user=null,_pass=null},d1.setSecured=function(bSecured){connection.setSecured(bSecured)},d1.isSecured=function(){return connection._secured},d1.setWSocket=function(WSocket){connection.setWSocket(WSocket)},d1.selfConnect=function(port,signature,WSocket){return d1.connect("ws://localhost:"+port,WSocket).then(function(){var deferred=Q.defer();return d1("#self").request({service:"peerAuth",func:"SelfAuthenticate",data:{signature:signature}},function(peerId,err,data){return err?deferred.reject(err):void(data&&data.authenticated&&data.token?(token=data.token,_user="#DiyaNode#"+peerId,deferred.resolve()):deferred.reject("AccessDenied"))}),deferred.promise})},inherits(DiyaSelector,EventEmitter),DiyaSelector.prototype.select=function(){return this._select()},DiyaSelector.prototype.each=function(cb){for(var peers=this._select(),i=0;i<peers.length;i++)cb.bind(this)(peers[i]);return this},DiyaSelector.prototype.request=function(params,callback,timeout,options){if(!connection)return this;if(options||(options={}),params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedRequest";params={service:_params[0],func:_params[1]}}var nbAnswers=0,nbExpected=this._select().length;return this.each(function(peerId){params.target=peerId,params.token=token;var opts={};for(var i in options)opts[i]=options[i];"function"==typeof opts.callback_partial&&(opts.callback_partial=function(err,data){options.callback_partial(peerId,err,data)}),connection.request(params,function(err,data){"function"==typeof callback&&callback(peerId,err,data),nbAnswers++,nbAnswers==nbExpected&&options.bNotifyWhenFinished&&callback(null,err,"##END##")},timeout,opts)})},DiyaSelector.prototype.subscribe=function(params,callback,options){if(params.constructor===String){var _params=params.split(".");if(2!=_params.length)throw"MalformedSubscription";params={service:_params[0],func:_params[1]}}return new Subscription(this,params,callback,options)},DiyaSelector.prototype.unsubscribe=function(subscription){return Array.isArray(subscription)||!subscription.close?this.__old_deprecated_unsubscribe(subscription):subscription.close()},DiyaSelector.prototype.auth=function(user,password,callback,timeout){"function"==typeof callback&&(callback=callback.bind(this));var deferred=Q.defer();return this.request({service:"auth",func:"Authenticate",data:{user:user,password:password}},function(peerId,err,data){return"ServiceNotFound"===err?void("function"==typeof callback?callback(peerId,!0):deferred.reject(err)):void(!err&&data&&data.authenticated&&data.token?(token=data.token,_user=user,_pass=password,"function"==typeof callback?callback(peerId,!0):deferred.resolve()):"function"==typeof callback?callback(peerId,!1):deferred.reject("AccessDenied"))},timeout),deferred.promise},DiyaSelector.prototype._select=function(selectorFunction){var that=this;return connection?connection.peers().filter(function(peerId){return match(that._selector,peerId)}):[]},DiyaSelector.prototype._on=DiyaSelector.prototype.on,DiyaSelector.prototype.on=function(type,callback){callback.___DiyaSelector_hidden_wrapper=function(peerId){match(this._selector,peerId)&&this.emit(type,peerId)},connection.on(type,callback.___DiyaSelector_hidden_wrapper);var ret=this._on(type,callback);if("peer-connected"===type&&connection.isConnected())for(var peers=connection.peers(),i=0;i<peers.length;i++)match(this._selector,peers[i])&&callback(peers[i]);return ret},DiyaSelector.prototype._removeListener=DiyaSelector.prototype.removeListener,DiyaSelector.prototype.removeListener=function(type,callback){callback.___DiyaSelector_hidden_wrapper&&connection.removeListener(type,callback.___DiyaSelector_hidden_wrapper),this._removeListener(type,callback)},Subscription.prototype.close=function(){for(var i=0;i<this.subIds.length;i++)connection.unsubscribe(this.subIds[i]);this.subIds=[],this.selector.removeListener("peer-connected",this.doSubscribe),this.state="closed"},Subscription.prototype._addSubscription=function(peerId){var that=this;params={};for(var k in this.params)params[k]=this.params[k];params.target=peerId,params.token=token;var subId=connection.subscribe(params,function(err,data){that.callback(peerId,err,data)});return this.options&&Array.isArray(this.options.subIds)&&(this.options.subIds[peerId]=subId),subId},DiyaSelector.prototype.listen=function(){},DiyaSelector.prototype.__old_deprecated_unsubscribe=function(subIds){return this.each(function(peerId){var subId=subIds[peerId];subId&&connection.unsubscribe(subId)}),this},module.exports=d1},{"./DiyaNode":8,inherits:5,"node-event-emitter":6,q:7}],10:[function(require,module,exports){var d1=require("./DiyaSelector.js");require("./services/timer/timer.js"),require("./services/rtc/rtc.js"),require("./services/explorer/explorer.js"),require("./services/pico/pico.js"),require("./services/viewer_explorer/viewer_explorer.js"),require("./services/ieq/ieq.js"),require("./services/networkId/NetworkId.js"),require("./services/maps/maps.js"),require("./services/peerAuth/PeerAuth.js"),require("./services/meshNetwork/MeshNetwork.js"),require("./services/verbose/Verbose.js"),require("./utils/encoding/encoding.js"),require("./services/status/status.js"),module.exports=d1},{"./DiyaSelector.js":9,"./services/explorer/explorer.js":11,"./services/ieq/ieq.js":12,"./services/maps/maps.js":13,"./services/meshNetwork/MeshNetwork.js":14,"./services/networkId/NetworkId.js":16,"./services/peerAuth/PeerAuth.js":17,"./services/pico/pico.js":18,"./services/rtc/rtc.js":19,"./services/status/status.js":20,"./services/timer/timer.js":21,"./services/verbose/Verbose.js":22,"./services/viewer_explorer/viewer_explorer.js":23,"./utils/encoding/encoding.js":24}],11:[function(require,module,exports){function explorer(node){return this.node=node,this}DiyaSelector=require("../../DiyaSelector").DiyaSelector,DiyaSelector.prototype.listFiles=function(file,callback){return this.request({service:"explorer",func:"ListFiles",data:{elt:file}},function(peerId,err,data){
data?callback(peerId,null,data):err&&callback(peerId,err,null)}),this},DiyaSelector.prototype.openFile=function(file,type,callback){return this.request({service:"explorer",func:"OpenFile",data:{file:file,type:type}},function(peerId,err,data){callback(peerId,null,data)}),this};var exp={explorer:explorer};module.exports=exp},{"../../DiyaSelector":9}],12:[function(require,module,exports){function IEQ(selector){return this.selector=selector,this.dataModel={},this._coder=selector.encode(),this.dataConfig={criteria:{time:{beg:null,end:null,range:null},robot:null,place:null},operator:"last",sensors:null,sampling:null},this}var DiyaSelector=require("../../DiyaSelector").DiyaSelector,DEBUG=(require("util"),require("../message"),!0),Logger={log:function(message){DEBUG&&console.log(message)},error:function(message){DEBUG&&console.error(message)}};IEQ.prototype.getDataModel=function(){return this.dataModel},IEQ.prototype.getDataRange=function(){return this.dataModel.range},IEQ.prototype.DataConfig=function(newDataConfig){return newDataConfig?(this.dataConfig=newDataConfig,this):this.dataConfig},IEQ.prototype.DataOperator=function(newOperator){return newOperator?(this.dataConfig.operator=newOperator,this):this.dataConfig.operator},IEQ.prototype.DataSampling=function(numSamples){return numSamples?(this.dataConfig.sampling=numSamples,this):this.dataConfig.sampling},IEQ.prototype.DataTime=function(newTimeBeg,newTimeEnd,newRange){return newTimeBeg||newTimeEnd||newRange?(this.dataConfig.criteria.time.beg=newTimeBeg.getTime(),this.dataConfig.criteria.time.end=newTimeEnd.getTime(),this.dataConfig.criteria.time.range=newRange,this):{beg:new Date(this.dataConfig.criteria.time.beg),end:new Date(this.dataConfig.criteria.time.end),range:new Date(this.dataConfig.criteria.time.range)}},IEQ.prototype.DataRobotIds=function(robotIds){return robotIds?(this.dataConfig.criteria.robot=robotIds,this):this.dataConfig.criteria.robot},IEQ.prototype.DataPlaceIds=function(placeIds){return placeIds?(this.dataConfig.criteria.placeId=placeIds,this):this.dataConfig.criteria.place},IEQ.prototype.getDataByName=function(sensorNames){var data=[];for(var n in sensorNames)data.push(this.dataModel[sensorNames[n]]);return data},IEQ.prototype.updateData=function(callback,dataConfig){var that=this;dataConfig&&this.DataConfig(dataConfig),this.selector.request({service:"ieq",func:"DataRequest",data:{type:"splReq",dataConfig:that.dataConfig}},function(dnId,err,data){return err?void Logger.error("["+that.dataConfig.sensors+"] Recv err: "+JSON.stringify(err)):data.header.error?(Logger.error("UpdateData:\n"+JSON.stringify(data.header.dataConfig)),void Logger.error("Data request failed ("+data.header.error.st+"): "+data.header.error.msg)):(that._getDataModelFromRecv(data),callback=callback.bind(that),void callback(that.getDataModel()))})},IEQ.prototype._isDataModelWithNaN=function(){var sensorNan,dataModelNaN=!1;for(var n in this.dataModel)sensorNan=this.dataModel[n].data.reduce(function(nanPres,d){return nanPres&&isNaN(d)},!1),dataModelNaN=dataModelNaN&&sensorNan,Logger.log(n+" with nan : "+sensorNan+" ("+dataModelNaN+") / "+this.dataModel[n].data.length)},IEQ.prototype.getConfinementLevel=function(){return this.confinement},IEQ.prototype.getAirQualityLevel=function(){return this.airQuality},IEQ.prototype.getEnvQualityLevel=function(){return this.envQuality},IEQ.prototype.watch=function(data,callback){var that=this;data=data||{timeRange:"hours"},this.selector.subscribe({service:"ieq",func:"Watch",data:data},function(dnId,err,data){return err?void Logger.error("WatchIEQRecvErr:"+JSON.stringify(err)):data.header.error?(Logger.error("WatchIEQ:\n"+JSON.stringify(data.header.dataConfig)),void Logger.error("Data request failed ("+data.header.error.st+"): "+data.header.error.msg)):(that._getDataModelFromRecv(data),callback=callback.bind(that),void callback(that.getDataModel()))})},IEQ.prototype._getDataModelFromRecv=function(data){var dataModel=null;if(data.err&&data.err.st>0)return Logger.error(err.msg),null;if(delete data.err,data&&data.header){for(var n in data)if("header"!=n&&"err"!=n){if(data[n].err&&data[n].err.st>0){Logger.error(n+" was in error: "+data[n].err.msg);continue}dataModel||(dataModel={}),dataModel[n]||(dataModel[n]={}),dataModel[n].range=data[n].range,dataModel[n].timeRange=data[n].timeRange,dataModel[n].label=data[n].label,dataModel[n].unit=data[n].unit,dataModel[n].zoomRange=[0,100],dataModel[n].qualityConfig={indexRange:data[n].indexRange},dataModel[n].time=this._coder.from(data[n].time,"b64",8),dataModel[n].data=data[n].data?this._coder.from(data[n].data,"b64",4):data[n].avg?this._coder.from(data[n].avg.d,"b64",4):null,dataModel[n].qualityIndex=data[n].data?this._coder.from(data[n].index,"b64",4):data[n].avg?this._coder.from(data[n].avg.i,"b64",4):null,dataModel[n].robotId=this._coder.from(data[n].robotId,"b64",4),dataModel[n].placeId=this._coder.from(data[n].placeId,"b64",4),dataModel[n].x=null,dataModel[n].y=null,data[n].avg&&(dataModel[n].avg={d:this._coder.from(data[n].avg.d,"b64",4),i:this._coder.from(data[n].avg.i,"b64",4)}),data[n].min&&(dataModel[n].min={d:this._coder.from(data[n].min.d,"b64",4),i:this._coder.from(data[n].min.i,"b64",4)}),data[n].max&&(dataModel[n].max={d:this._coder.from(data[n].max.d,"b64",4),i:this._coder.from(data[n].max.i,"b64",4)}),data[n].stddev&&(dataModel[n].stddev={d:this._coder.from(data[n].stddev.d,"b64",4),i:this._coder.from(data[n].stddev.i,"b64",4)}),dataModel[n].trend="mss"}}else Logger.error("No Data to read or header is missing !");return this.dataModel=dataModel,dataModel},DiyaSelector.prototype.IEQ=function(){return new IEQ(this)}},{"../../DiyaSelector":9,"../message":15,util:4}],13:[function(require,module,exports){function Maps(peerIds){this._peerIds=peerIds,this._subIds={},this._diyas={},this.listDiya=this._peerIds}EventEmitter=require("node-event-emitter"),inherits(Maps,EventEmitter),DiyaSelector.prototype.getCurrentPlace=function(peerId,func){this.request({service:"maps",func:"GetCurrentPlace",obj:[peerId]},function(peerId,err,data){func(peerId,err,data)})},Maps.prototype._round=function(val){return Math.round(1e6*parseFloat(val))/1e6},Maps.prototype._isFloatEqual=function(val1,val2){return this._round(val1)===this._round(val2)},Maps.prototype.mapIsModified=function(peerId,map_info){return map_info.scale=Array.isArray(map_info.scale)?map_info.scale[0]:map_info.scale,!(this._isFloatEqual(this._diyas[peerId].path.scale,map_info.scale)&&this._isFloatEqual(this._diyas[peerId].path.rotate,map_info.rotate)&&this._isFloatEqual(this._diyas[peerId].path.translate[0],map_info.translate[0])&&this._isFloatEqual(this._diyas[peerId].path.translate[1],map_info.translate[1])&&this._isFloatEqual(this._diyas[peerId].path.ratio,map_info.ratio))},Maps.prototype.placeIsModified=function(peerId,place_info){return!(this._isFloatEqual(this._diyas[peerId].places[place_info.id].x,place_info.x)&&this._isFloatEqual(this._diyas[peerId].places[place_info.id].y,place_info.y))},Maps.prototype.removePeer=function(peerId){this._diyas[peerId]&&(delete this._diyas[peerId],this.emit("peer-unsubscribed",peerId)),null===this._subIds[peerId]||isNaN(this._subIds[peerId])||(d1(peerId).unsubscribe(this._subIds),delete this._subIds[peerId])},Maps.prototype.connect=function(){var that=this,options={auto:!0,subIds:[]};d1("#self").subscribe({service:"maps",func:"ListenMap",obj:this._peerIds},function(peerId,err,data){if(err||data.error)return void console.log("Maps: fail to get info from map, error:",err||data.error,"!");if(null!=data){if(peerId=data.peerId,!peerId)return void console.log("Maps: received info without a peerId");Array.isArray(data.places)||(data.places=[]),void 0!==data.place&&data.places.push(data.place);var map_info=null,places_info=[];"MapInfo"===data.type&&(null==that._diyas[peerId]?that._diyas[peerId]={path:{translate:[data.tx,data.ty],scale:data.scale,rotate:data.rotate,ratio:data.ratio},places:{}}:(null==that._diyas[peerId].path&&(that._diyas[peerId].path={}),that._diyas[peerId].path.translate=[data.tx,data.ty],that._diyas[peerId].path.scale=data.scale,that._diyas[peerId].path.rotate=data.rotate,that._diyas[peerId].path.ratio=data.ratio,null==that._diyas[peerId].places&&(that._diyas[peerId].places={})),map_info={id:data.id,name:data.name,rotate:data.rotate,scale:data.scale,translate:[data.tx,data.ty],ratio:data.ratio}),data.places.map(function(place){if(place){var id=place.neuronId;place={id:id,label:place.label,x:place.x,y:place.y,t:360*place.t},null==that._diyas[peerId].places[id]&&(that._diyas[peerId].places[id]=place),places_info.push(Object.create(place))}else places_info.push(null)}),0===places_info.length&&(places_info=null),that.emit("peer-subscribed",peerId,map_info,places_info)}},options);for(var peerId in options.subIds)null===this._subIds[peerId]||isNaN(this._subIds[peerId])?this._subIds[peerId]=options.subIds[peerId]:(d1("#self").unsubscribe(this._subIds),delete this._subIds[peerId],console.log("Maps: bug: existed subscription ??"));return this},Maps.prototype.disconnect=function(){var that=this;d1("#self").unsubscribe(this._subIds),this._diyas={},this._peerIds.forEach(function(peerId){that.emit("peer-unsubscribed",peerId)}),this.removeAllListeners()},Maps.prototype.saveMap=function(peerId,map_info,cb){var _map_info=Object.create(map_info),that=this;_map_info.scale=Array.isArray(_map_info.scale)?_map_info.scale[0]:_map_info.scale,this.mapIsModified(peerId,_map_info)?d1("#self").request({service:"maps",func:"UpdateMap",obj:[peerId],data:{scale:_map_info.scale,tx:_map_info.translate[0],ty:_map_info.translate[1],rotate:_map_info.rotate,ratio:_map_info.ratio}},function(peerId,err,data){null!=err&&(that._diyas[peerId].path.scale=_map_info.scale,that._diyas[peerId].path.rotate=_map_info.rotate,that._diyas[peerId].path.translate[0]=_map_info.translate[0],that._diyas[peerId].path.translate[1]=_map_info.translate[1]),cb&&cb(err)}):cb&&cb(new Error("No change to map '"+this._map+"'!"))},Maps.prototype.savePlace=function(peerId,place_info,cb){var that=this,_place_info=Object.create(place_info);this.placeIsModified(peerId,_place_info)?d1("#self").request({service:"maps",func:"UpdatePlace",obj:[peerId],data:{neuronId:_place_info.id,x:_place_info.x,y:_place_info.y}},function(peerId,err,data){null!=err&&(that._diyas[peerId].places[_place_info.id].x=_place_info.x,that._diyas[peerId].places[_place_info.id].y=_place_info.y),cb&&cb(err)}):cb&&cb(new Error("No change to place n°"+_place_info.id+"!"))},Maps.prototype.clearPlaces=function(peerId,cb){var that=this;d1("#self").request({service:"maps",func:"ClearMap",obj:[peerId]},function(peerId,err,data){null!=err&&(that._diyas[peerId].places={}),cb&&cb(err)})},DiyaSelector.prototype.maps=function(peerIds){var maps=new Maps(peerIds);return maps}},{"node-event-emitter":6}],14:[function(require,module,exports){var DiyaSelector=require("../../DiyaSelector").DiyaSelector,d1=require("../../DiyaSelector"),Q=require("q");d1.knownPeers=function(){return d1("#self").knownPeers()},d1.kp=d1.knownPeers,DiyaSelector.prototype.knownPeers=function(callback){var deferred=Q.defer();return this.request({service:"meshNetwork",func:"ListKnownPeers"},function(peerId,err,data){if(err)return deferred.reject(err);for(var peers=[],i=0;i<data.peers.length;i++)peers.push(data.peers[i].name);return deferred.resolve(peers)}),deferred.promise},d1.listenMeshNetwork=function(callback){return d1(/.*/).subscribe({service:"meshNetwork",func:"SubscribeMeshNetwork"},callback,{auto:!0})}},{"../../DiyaSelector":9,q:7}],15:[function(require,module,exports){function Message(service,func,obj,permanent){this.service=service,this.func=func,this.obj=obj,this.permanent=permanent}Message.buildSignature=function(msg){return msg.service+"."+msg.func+"."+msg.obj},Message.prototype.signature=function(){return this.service+"."+this.func+"."+this.obj},Message.prototype.exec=function(data){return{service:this.service,func:this.func,obj:this.obj,data:data}},module.exports=Message},{}],16:[function(require,module,exports){var DiyaSelector=require("../../DiyaSelector").DiyaSelector;DiyaSelector.prototype.ip=function(iface,callback){return this.request({service:"networkId",func:"GetLocalIP",data:{iface:iface}},function(peerId,err,data){callback(peerId,!err&&data&&data.address?data.address:null)})}},{"../../DiyaSelector":9}],17:[function(require,module,exports){var DiyaSelector=require("../../DiyaSelector").DiyaSelector,d1=require("../../DiyaSelector"),Q=require("q");"undefined"==typeof INFO&&(INFO=function(s){console.log(s)}),"undefined"==typeof OK&&(OK=function(s){console.log(s)}),d1.installNodeExt=function(ip,user,password,bootstrap_ip,bootstrap_user,bootstrap_password,bootstrap_net,callback){function join(peer,bootstrap_peer){d1("#self").join(bootstrap_net,!0,function(peer,err,data){return err||OK("JOINED !!!"),callback(peer,bootstrap_peer,err,data)})}if("string"!=typeof ip)throw"[installNode] ip should be an IP address";if("string"!=typeof bootstrap_ip)throw"[installNode] bootstrap_ip should be an IP address";if("string"!=typeof bootstrap_net)throw"[installNode] bootstrap_net should be an IP address";0!==bootstrap_ip.indexOf("ws://")&&0!==bootstrap_ip.indexOf("wss://")&&(bootstrap_ip=d1.isSecured()?"wss://"+bootstrap_ip:"ws://"+bootstrap_ip),0!==bootstrap_net.indexOf("ws://")&&0!==bootstrap_net.indexOf("wss://")&&(bootstrap_net=d1.isSecured()?"wss://"+bootstrap_net:"ws://"+bootstrap_net),d1.connectAsUser(ip,user,password).then(function(peer,err,data){d1("#self").givePublicKey(function(peer,err,data){return"ServiceNotFound"===err?(INFO("Peer Authentication disabled ... directly joining"),void join()):err?callback(peer,null,err,null):(INFO("Add trusted peer "+peer+"(ip="+ip+") to "+bootstrap_ip+" with public key "+data.public_key.slice(0,20)),void d1.connectAsUser(bootstrap_ip,bootstrap_user,bootstrap_password).then(function(){d1("#self").addTrustedPeer(peer,data.public_key,function(bootstrap_peer,err,data){return err?callback(peer,bootstrap_peer,err,null):(data.alreadyTrusted?INFO(peer+" already trusted by "+bootstrap_peer):INFO(bootstrap_peer+"(ip="+bootstrap_ip+") added "+peer+"(ip="+ip+") as a Trusted Peer"),INFO("In return, add "+bootstrap_peer+" to "+peer+" as a Trusted Peer with public key "+data.public_key.slice(0,20)),void d1.connectAsUser(ip,user,password).then(function(){d1("#self").addTrustedPeer(bootstrap_peer,data.public_key,function(peer,err,data){return err?callback(peer,bootstrap_peer,err,null):data.alreadyTrusted?INFO(bootstrap_peer+" already trusted by "+peer):INFO(peer+"(ip="+ip+") added "+bootstrap_peer+"(ip="+bootstrap_ip+") as a Trusted Peer"),OK("KEYS OK ! Now, let "+peer+"(ip="+ip+") join the network via "+bootstrap_peer+"(ip="+bootstrap_net+") ..."),join(peer,bootstrap_peer)})}))})}))})})},d1.installNode=function(bootstrap_ip,bootstrap_net,callback){var ip=d1.addr(),user=d1.user(),password=d1.pass(),bootstrap_user=user,bootstrap_password=password;return d1.installNodeExt(ip,user,password,bootstrap_ip,bootstrap_user,bootstrap_password,bootstrap_net,callback)},DiyaSelector.prototype.join=function(bootstrap_ips,bPermanent,callback){if("string"==typeof bootstrap_ips&&(bootstrap_ips=[bootstrap_ips]),bootstrap_ips.constructor!==Array)throw"join() : bootstrap_ips should be an array of peers URIs";this.request({service:"meshNetwork",func:"Join",data:{bootstrap_ips:bootstrap_ips,bPermanent:bPermanent}},function(peerId,err,data){"function"==typeof callback&&callback(peerId,err,data)})},DiyaSelector.prototype.leave=function(bootstrap_ips,bPermanent,callback){if("string"==typeof bootstrap_ips&&(bootstrap_ips=[bootstrap_ips]),bootstrap_ips.constructor!==Array)throw"leave() : bootstrap_ips should be an array of peers URIs";this.request({service:"meshNetwork",func:"Leave",data:{bootstrap_ips:bootstrap_ips,bPermanent:bPermanent}},function(peerId,err,data){"function"==typeof callback&&callback(peerId,err,data)})},DiyaSelector.prototype.givePublicKey=function(callback){return this.request({service:"peerAuth",func:"GivePublicKey",data:{}},function(peerId,err,data){callback(peerId,err,data)})},DiyaSelector.prototype.addTrustedPeer=function(name,public_key,callback){return this.request({service:"peerAuth",func:"AddTrustedPeer",data:{name:name,public_key:public_key}},function(peerId,err,data){callback(peerId,err,data)})},DiyaSelector.prototype.areTrusted=function(peers,callback){return this.request({service:"peerAuth",func:"AreTrusted",data:{peers:peers}},function(peerId,err,data){var allTrusted=data.trusted;allTrusted?(OK(peers+" are trusted by "+peerId),callback(peerId,!0)):(ERR("Some peers in "+peers+" are untrusted by "+peerId),callback(peerId,!1))})},DiyaSelector.prototype.isTrusted=function(peer,callback){return this.areTrusted([peer],callback)},d1.trustedPeers=function(){var deferred=Q.defer();return d1("#self").request({service:"peerAuth",func:"GetTrustedPeers"},function(peerId,err,data){if(err)return deferred.reject(err);for(var peers=[],i=0;i<data.peers.length;i++)peers.push(data.peers[i].name);return deferred.resolve(peers)}),deferred.promise},d1.tp=d1.trustedPeers},{"../../DiyaSelector":9,q:7}],18:[function(require,module,exports){function pico(node){return this.node=node,this}DiaSelector=require("../../DiyaSelector").DiyaSelector,DiyaSelector.prototype.power=function(){this.request({service:"pico",func:"Power"},function(peerId,err,data){})},DiyaSelector.prototype.zoom=function(callback){this.request({service:"pico",func:"Zoom"},function(data){})},DiyaSelector.prototype.back=function(callback){this.request({service:"pico",func:"Back"},function(data){})},DiyaSelector.prototype.up=function(callback){this.request({service:"pico",func:"Up"},function(data){})},DiyaSelector.prototype.left=function(callback){this.request({service:"pico",func:"Left"},function(data){})},DiyaSelector.prototype.ok=function(callback){this.request({service:"pico",func:"Ok"},function(data){})},DiyaSelector.prototype.right=function(callback){this.request({service:"pico",func:"Right"},function(data){})},DiyaSelector.prototype.down=function(callback){this.request({service:"pico",func:"Down"},function(data){})},DiyaSelector.prototype.prev=function(callback){this.request({service:"pico",func:"Prev"},function(data){})},DiyaSelector.prototype.play=function(callback){this.request({service:"pico",func:"Play"},function(data){})},DiyaSelector.prototype.next=function(callback){this.request({service:"pico",func:"Next"},function(data){})},DiyaSelector.prototype.lumiDown=function(callback){this.request({service:"pico",func:"LumiDown"},function(data){})},DiyaSelector.prototype.lumiUp=function(callback){this.request({service:"pico",func:"LumiUp"},function(data){})},DiyaSelector.prototype.volumeDown=function(callback){this.request({service:"pico",func:"VolumeDown"},function(data){})},DiyaSelector.prototype.mute=function(callback){this.request({service:"pico",func:"Mute"},function(data){})},DiyaSelector.prototype.volumeUp=function(callback){this.request({service:"pico",func:"VolumeUp"},function(data){})},DiyaSelector.prototype.display=function(callback){this.request({service:"pico",func:"Display"},function(data){})};var exp={pico:pico};module.exports=exp},{"../../DiyaSelector":9}],19:[function(require,module,exports){function Channel(dnId,name,open_cb){EventEmitter.call(this),this.name=name,this.dnId=dnId,this.frequency=20,this.channel=void 0,this.onopen=open_cb,this.closed=!1}function Peer(dnId,rtc,id,channels){this.dn=d1(dnId),this.dnId=dnId,this.id=id,this.channels=channels,this.rtc=rtc,this.peer=null,this.connected=!1,this.closed=!1,this._connect()}function RTC(selector){this.selector=selector,this.requestedChannels=[]}function createNeuronsFromDOM(domNode,selectedNodes,rtc){if(domNode&&domNode.querySelectorAll){for(var neuronNodeList=domNode.querySelectorAll("*"),neuronNodes=[],i=0;i<neuronNodeList.length;i++)isNeuronTag(neuronNodeList[i])&&(neuronNodes.push(neuronNodeList[i]),Array.isArray(selectedNodes)&&selectedNodes.push(neuronNodeList[i]));neuronNodes.forEach(function(neuronNode){var channel=getChannel(neuronNode.attributes.name.value);rtc.use(channel,function(dnId,neuron){neuronNode.setNeuron(dnId,neuron)})})}}function isNeuronTag(node){return node.tagName.startsWith("NEURON-")&&node.attributes.name&&"function"==typeof node.setNeuron}function getChannel(name){return name.replace(/\s+/,"")}if(DiyaSelector=require("../../DiyaSelector").DiyaSelector,EventEmitter=require("node-event-emitter"),inherits=require("inherits"),"undefined"!=typeof window)var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;inherits(Channel,EventEmitter),Channel.prototype.setChannel=function(datachannel){this.channel=datachannel,this.channel.binaryType="arraybuffer",this._negociate()},Channel.prototype.close=function(){this.closed=!0},Channel.prototype.write=function(index,value){return 0>index||index>this.size||isNaN(value)?!1:(this._buffer[index]=value,this._requestSend(),!0)},Channel.prototype.writeAll=function(values){if(!Array.isArray(values)||values.length!==this.size)return!1;for(var i=0;i<values.length;i++){if(isNaN(values[i]))return!1;this._buffer[i]=values[i]}this._requestSend()},Channel.prototype._requestSend=function(){function doSend(){that._sendRequested=!1,that._lastSendTimestamp=(new Date).getTime();var ret=that._send(that._buffer);ret&&that.autosend&&that._requestSend()}var that=this,elapsedTime=(new Date).getTime()-this._lastSendTimestamp,period=1e3/this.frequency;elapsedTime>=period?doSend():this._sendRequested||(this._sendRequested=!0,setTimeout(doSend,period-elapsedTime))},Channel.prototype._send=function(msg){if(this.closed)return!1;if("open"===this.channel.readyState){try{this.channel.send(msg)}catch(e){console.log("[rtc.channel.write] exception occured while sending data")}return!0}return console.log("[rtc.channel.write] warning : webrtc datachannel state = "+this.channel.readyState),!1},Channel.prototype._negociate=function(){var that=this;this.channel.onmessage=function(message){var view=new DataView(message.data),typeChar=String.fromCharCode(view.getUint8(0));"O"===typeChar?that.type="input":"I"===typeChar&&(that.type="output");var size=view.getInt32(1,!0);void 0!=size&&(that.size=size,that._buffer=new Float32Array(size)),that.channel.onmessage=that._onMessage.bind(that),that.channel.onclose=that._onClose.bind(that),"function"==typeof that.onopen&&that.onopen(that.dnId,that),console.log("channel "+that.name+" negociated !")}},Channel.prototype._onMessage=function(message){var valArray=new Float32Array(message.data);this.emit("value",valArray)},Channel.prototype._onClose=function(){console.log("channel "+this.name+" closed !"),this.emit("close")},Peer.prototype._connect=function(){var that=this;this.subscription=this.dn.subscribe({service:"rtc",func:"Connect",obj:this.channels,data:{promID:this.id}},function(diya,err,data){data&&that._handleNegociationMessage(data)}),setTimeout(function(){that.connected||that.closed||that._reconnect()},1e4)},Peer.prototype._reconnect=function(){this.close(),this.peer=null,this.connected=!1,this.closed=!1,this._connect()},Peer.prototype._handleNegociationMessage=function(msg){"RemoteOffer"===msg.eventType?this._createPeer(msg):"RemoteICECandidate"===msg.eventType&&this._addRemoteICECandidate(msg)};var servers={iceServers:[{url:"stun:stun.l.google.com:19302"}]};Peer.prototype._createPeer=function(data){var that=this,peer=new RTCPeerConnection(servers,{mandatory:[{DtlsSrtpKeyAgreement:!0},{EnableDtlsSrtp:!0}]});this.peer=peer,peer.setRemoteDescription(new RTCSessionDescription({sdp:data.sdp,type:data.type})),peer.createAnswer(function(session_description){peer.setLocalDescription(session_description),that.dn.request({service:"rtc",func:"Answer",data:{promID:data.promID,peerId:data.peerId,sdp:session_description.sdp,type:session_description.type}})},function(err){console.log("RTC: cannot create answer :"),console.log(err)},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}),peer.oniceconnectionstatechange=function(){console.log("RTC: state change("+that.id+":"+that.dnId+") : "+peer.iceConnectionState),"connected"===peer.iceConnectionState?(that.connected=!0,that.subscription&&that.subscription.close()):"disconnected"===peer.iceConnectionState&&(that.closed||that._reconnect())},peer.onicecandidate=function(evt){console.log("local candidate : "),console.log(evt.candidate),that.dn.request({service:"rtc",func:"ICECandidate",data:{peerId:data.peerId,promID:that.id,candidate:evt.candidate}})},peer.ondatachannel=function(evt){that.connected=!0,that.rtc._onDataChannel(that.dnId,evt.channel)}},Peer.prototype._addRemoteICECandidate=function(data){var that=this;console.log("remote candidate : "),console.log(data.candidate);try{var candidate=new RTCIceCandidate(data.candidate);this.peer.addIceCandidate(candidate,function(){console.log("RTC: candidate added("+that.id+":"+that.dnId+") : "+that.peer.iceConnectionState)},function(err){console.error("RTC: cannot add RemoteICECandidate :"),console.error(err)})}catch(err){console.error("RTC: cannot add RemoteICECandidate : "),console.error(err)}},Peer.prototype.close=function(){if(this.subscription&&this.subscription.close(),this.peer){try{this.peer.close()}catch(e){}this.connected=!1,this.closed=!0}},RTC.prototype.disconnect=function(){var that=this;return this.selector.each(function(dnId){if(that[dnId])for(var promID in that[dnId].peers)that._closePeer(dnId,promID)}),this.subscription&&this.subscription.close(),this},RTC.prototype.use=function(name_regex,onopen_callback){return this.requestedChannels.push({regex:name_regex,cb:onopen_callback}),this},RTC.prototype.connect=function(){var that=this;return this.subscription=this.selector.subscribe({service:"rtc",func:"ListenPeers"},function(dnId,err,data){if(that[dnId]||that._createDiyaNode(dnId),"SubscriptionClosed"===err||"PeerDisconnected"===err)return void that._closeDiyaNode(dnId);if(data&&data.eventType&&void 0!==data.promID)if("PeerConnected"===data.eventType){if(!that[dnId].peers[data.promID]){var channels=that._matchChannels(dnId,data.channels);channels.length>0&&(that[dnId].peers[data.promID]=new Peer(dnId,that,data.promID,channels))}}else"PeerClosed"===data.eventType&&that[dnId].peers[data.promID]&&(that._closePeer(dnId,data.promID),"function"==typeof that.onclose&&that.onclose(dnId))},{auto:!0}),this},RTC.prototype._createDiyaNode=function(dnId){var that=this;this[dnId]={dnId:dnId,usedChannels:[],requestedChannels:[],peers:[]},this.requestedChannels.forEach(function(c){that[dnId].requestedChannels.push(c)})},RTC.prototype._closeDiyaNode=function(dnId){for(var promID in this[dnId].peers)this._closePeer(dnId,promID);delete this[dnId]},RTC.prototype._closePeer=function(dnId,promID){if(this[dnId].peers[promID]){var p=this[dnId].peers[promID];p.close();for(var i=0;i<p.channels.length;i++)delete this[dnId].usedChannels[p.channels[i]];delete this[dnId].peers[promID]}},RTC.prototype._matchChannels=function(dnId,receivedChannels){for(var that=this,channels=[],i=0;i<receivedChannels.length;i++)for(var name=receivedChannels[i],j=0;j<that[dnId].requestedChannels.length;j++){var req=that[dnId].requestedChannels[j];name&&name.match(req.regex)&&!that[dnId].usedChannels[name]&&(that[dnId].usedChannels[name]=new Channel(dnId,name,req.cb),channels.push(name))}return channels},RTC.prototype._onDataChannel=function(dnId,datachannel){var channel=this[dnId].usedChannels[datachannel.label];return channel?(console.log("Channel "+datachannel.label+" created !"),void channel.setChannel(datachannel)):(console.log("Channel "+datachannel.label+" unmatched, closing !"),void datachannel.close())},DiyaSelector.prototype.rtc=function(domNode,selectedNodes){var rtc=new RTC(this);return domNode&&createNeuronsFromDOM(domNode,selectedNodes,rtc),rtc}},{"../../DiyaSelector":9,inherits:5,"node-event-emitter":6}],20:[function(require,module,exports){function Status(selector){return this.selector=selector,this._coder=selector.encode(),this.robotModel=[],this._robotModelInit=!1,this.dataConfig={criteria:{time:{beg:null,end:null,range:null},robot:null},operator:"last",parts:null,status:null},this}var DiyaSelector=require("../../DiyaSelector").DiyaSelector,DEBUG=(require("util"),require("../message"),!0),Logger={log:function(message){DEBUG&&console.log(message)},error:function(message){DEBUG&&console.error(message)}};Status.prototype.getRobotModel=function(){return this.robotModel},Status.prototype.DataConfig=function(newDataConfig){return newDataConfig?(this.dataConfig=newDataConfig,this):this.dataConfig},Status.prototype.DataOperator=function(newOperator){return newOperator?(this.dataConfig.operator=newOperator,this):this.dataConfig.operator},Status.prototype.DataSampling=function(numSamples){return numSamples?(this.dataConfig.sampling=numSamples,this):this.dataConfig.sampling},Status.prototype.DataTime=function(newTimeBeg,newTimeEnd,newRange){return newTimeBeg||newTimeEnd||newRange?(this.dataConfig.criteria.time.beg=newTimeBeg.getTime(),this.dataConfig.criteria.time.end=newTimeEnd.getTime(),this.dataConfig.criteria.time.range=newRange,this):{beg:new Date(this.dataConfig.criteria.time.beg),end:new Date(this.dataConfig.criteria.time.end),range:new Date(this.dataConfig.criteria.time.range)}},Status.prototype.DataRobotIds=function(robotIds){return robotIds?(this.dataConfig.criteria.robot=robotIds,this):this.dataConfig.criteria.robot},Status.prototype.DataPlaceIds=function(placeIds){return placeIds?(this.dataConfig.criteria.placeId=placeIds,this):this.dataConfig.criteria.place},Status.prototype.getDataByName=function(sensorNames){var data=[];for(var n in sensorNames)data.push(this.dataModel[sensorNames[n]]);return data},Status.prototype.watch=function(robotNames,callback){var that=this;this.selector.subscribe({service:"status",func:"Watch",data:robotNames},function(peerId,err,data){err||data&&data.err&data.err.st?Logger.error("StatusSubscribe:"+(err?err:"")+"\n"+(data&&data.err?data.err:"")):(data&&data.header&&data.header.reqConfig&&"init"===data.header.reqConfig.type&&(that.robotModelInit=!0),that.robotModelInit?(that._getRobotModelFromRecv2(data),"function"==typeof callback&&callback(that.robotModel)):Logger.error("Robot model has not been initialised, cannot be updated"))},{auto:!0})},Status.prototype.getData=function(callback,dataConfig){var that=this,dataModel={};dataConfig&&this.DataConfig(dataConfig),this.selector.request({service:"status",func:"DataRequest",data:{type:"splReq",dataConfig:that.dataConfig}},function(dnId,err,data){return err?void Logger.error("["+that.dataConfig.sensors+"] Recv err: "+JSON.stringify(err)):data.header.error?(Logger.error("UpdateData:\n"+JSON.stringify(data.header.reqConfig)),void Logger.error("Data request failed ("+data.header.error.st+"): "+data.header.error.msg)):(dataModel=that._getDataModelFromRecv(data),Logger.log(that.getDataModel()),callback=callback.bind(that),void callback(dataModel))})},Status.prototype._getRobotModelFromRecv2=function(data){var dataRobots=data.robots,dataParts=data.partList;this.robotModel||(this.robotModel=[]);for(var n in dataRobots)if(this.robotModel[n]||(this.robotModel[n]={}),this.robotModel[n].robot=dataRobots[n].robot,dataRobots[n]&&dataRobots[n].parts){this.robotModel[n].parts||(this.robotModel[n].parts={});var parts=dataRobots[n].parts,rParts=this.robotModel[n].parts;for(var q in rParts)!parts[q]&&rParts[q].evts&&rParts[q].evts.code&&(rParts[q].evts={code:0,codeRef:0,time:Date.now()});for(var p in parts)if(rParts[p]||(rParts[p]={}),parts[p]){rParts[p].category=dataParts[p].category,rParts[p].name=dataParts[p].name,rParts[p].label=dataParts[p].label,rParts[p].errorList||(rParts[p].errorList={});for(var el in dataParts[p].errorList)rParts[p].errorList[el]||(rParts[p].errorList[el]=dataParts[p].errorList[el]);rParts[p].evts={
code:parts[p].code,codeRef:parts[p].codeRef,time:parts[p].time}}}else Logger.error("No parts to read for robot "+data[n].name)},Status.prototype._getRobotModelFromRecv=function(data){this.robotModel||(this.robotModel=[]);for(var n in data)if(this.robotModel[n]||(this.robotModel[n]={}),this.robotModel[n].robot=data[n].robot,data[n]&&data[n].parts){this.robotModel[n].parts||(this.robotModel[n].parts={});var parts=data[n].parts,rParts=this.robotModel[n].parts;for(var q in rParts)!parts[q]&&rParts[q].evts&&rParts[q].evts.code&&(rParts[q].evts={code:[0],codeRef:[0],time:[Date.now()]});for(var p in parts)if(parts[p]&&parts[p].err&&parts[p].err.st>0)Logger.error("Parts "+p+" was in error: "+data[p].err.msg);else if(rParts[p]||(rParts[p]={}),parts[p]){rParts[p].category=parts[p].category,rParts[p].name=parts[p].name,rParts[p].label=parts[p].label,rParts[p].errorList||(rParts[p].errorList={});for(var el in parts[p].errorList)rParts[p].errorList[el]||(rParts[p].errorList[el]=parts[p].errorList[el]);rParts[p].evts={code:this._coder.from(parts[p].evts.code),codeRef:this._coder.from(parts[p].evts.codeRef),time:this._coder.from(parts[p].evts.time)}}}else Logger.error("No parts to read for robot "+data[n].name)},DiyaSelector.prototype.Status=function(){return new Status(this)},DiyaSelector.prototype.setStatus=function(robotName,partName,code,source,callback){var funcName="SetStatus_"+partName;this.request({service:"status",func:funcName,data:{robotName:robotName,statusCode:code,source:1|source}},function(peerId,err,data){err?callback&&callback(!1):callback&&callback(!0)})},DiyaSelector.prototype.getStatus=function(robotName,partName,callback,_full){var full=_full||!1;this.request({service:"status",func:"GetStatus",data:{robotName:robotName,partName:partName,full:full}},function(peerId,err,data){err?callback&&callback(-1):callback&&callback(data)})}},{"../../DiyaSelector":9,"../message":15,util:4}],21:[function(require,module,exports){DiyaSelector=require("../../DiyaSelector").DiyaSelector,DiyaSelector.prototype.time=function(loop,callback){return loop?this.subscribe({service:"timer",func:"SubscribeTimer"},callback,{auto:!0}):this.request({service:"timer",func:"GetTime"},callback),this}},{"../../DiyaSelector":9}],22:[function(require,module,exports){var d1=(require("util"),require("../../DiyaSelector"));d1.verbose=function(bVerbose){"undefined"==typeof bVerbose&&(bVerbose=!0);var options={subIds:[]};bVerbose?(d1("#self").subscribe({service:"maps",func:"ListenMap",obj:[this._map]},function(peerId,err,data){err?console.log("[ERR] "+err):console.log(data)},options),_verbose_subIds=options.subIds):d1("#self").unsubscribe(_verbose_subIds)};var _verbose_subIds=[]},{"../../DiyaSelector":9,util:4}],23:[function(require,module,exports){DiyaSelector=require("../../DiyaSelector").DiyaSelector,DiyaSelector.prototype.listenViewers=function(callback){return this.subscribe({service:"explorer",func:"ListenViewers"},function(peerId,err,data){callback(peerId,null,data)}),this}},{"../../DiyaSelector":9}],24:[function(require,module,exports){function NoCoding(){return this}function Base64Coding(){return this}function CodingHandler(){return this.b64=new Base64Coding,this.none=new NoCoding,this}var DiyaSelector=require("../../DiyaSelector").DiyaSelector,base64=require("base-64");NoCoding.prototype.from=function(data){return data.d},NoCoding.prototype.to=function(array){return{t:"no",d:array,s:array.length}};var b64ToUint6=function(nChr){return nChr>64&&91>nChr?nChr-65:nChr>96&&123>nChr?nChr-71:nChr>47&&58>nChr?nChr+4:43===nChr?62:47===nChr?63:0},base64DecToArr=function(sBase64,nBlocksSize){for(var nMod3,nMod4,sB64Enc=sBase64.replace(/[^A-Za-z0-9\+\/]/g,""),nInLen=sB64Enc.length,nOutLen=nBlocksSize?Math.ceil((3*nInLen+1>>2)/nBlocksSize)*nBlocksSize:3*nInLen+1>>2,buffer=new ArrayBuffer(nOutLen),taBytes=new Uint8Array(buffer),nUint24=0,nOutIdx=0,nInIdx=0;nInLen>nInIdx;nInIdx++)if(nMod4=3&nInIdx,nUint24|=b64ToUint6(sB64Enc.charCodeAt(nInIdx))<<18-6*nMod4,3===nMod4||nInLen-nInIdx===1){for(nMod3=0;3>nMod3&&nOutLen>nOutIdx;nMod3++,nOutIdx++)taBytes[nOutIdx]=nUint24>>>(16>>>nMod3&24)&255;nUint24=0}return buffer};Base64Coding.prototype.from=function(data){var byteCoding=data.b;if(4!==byteCoding&&8!==byteCoding)return null;var buf=base64DecToArr(data.d,data.b),fArray=null;switch(data.b){case 4:fArray=new Float32Array(buf);break;case 8:fArray=new Float64Array(buf);break;default:return console.log("Unexpected byteCoding! Should not happen!!"),null}var tab=[].slice.call(fArray);return data.s!==tab.length?(console.log("Size mismatch when decoding !"),null):tab},Base64Coding.prototype.to=function(array,byteCoding){if(4!==byteCoding&&8!==byteCoding)return null;var buffer=new ArrayBuffer(array.length*byteCoding);switch(byteCoding){case 4:var buf32=new Float32Array(buffer);buf32.set(array);break;case 8:var buf64=new Float64Array(buffer);buf64.set(array)}var buffChar=new Uint8Array(buffer),str=String.fromCharCode.apply(null,buffChar),b64Buff=base64.encode(str);return{t:"b64",b:byteCoding,d:b64Buff,s:array.length}},CodingHandler.prototype.from=function(data){if(!data||null===data)return null;switch(data.t){case"b64":return this.b64.from(data);default:return this.none.from(data)}},CodingHandler.prototype.to=function(array,type,byteCoding){if("number"==typeof array&&(array=[array]),!Array.isArray(array))return console.log("CodingHandler.to only accepts array !"),null;switch(type){case"b64":return this.b64.to(array,byteCoding);case"no":default:return this.none.to(array)}},DiyaSelector.prototype.encode=function(){return new CodingHandler}},{"../../DiyaSelector":9,"base-64":1}]},{},[10])(10)});
