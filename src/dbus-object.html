
<dom-module id="dbus-object">
	<template>
	</template>
	<script>
		class DBusObject extends Polymer.Element {
			static get is () { return 'dbus-object' }
			static get properties () {
				return {
					selector: { observer: 'updateState' },
					service: { type: String, observer: 'updateState' },
					objectPath: { type: String, observer: 'updateState' },
					object: { type: Object, notify: true },
					partialObject: { type: Object },
					watchChanges: { type: Boolean, value: false }
				}
			}

			constructor () {
				super()

			}

			updateState () {
				if (this.object != null) {
					this.object.removeListener('properties-changed', this._propertiesChangedCallback)
					this.object = null
				}

				if (this.selector == null || this.service == null || this.objectPath == null) {	
					return
				}

				let obj = d1(this.selector).dbusObject(this.service, this.objectPath, this.partialObject)

				if (obj.length !== 1) {
					this.dispatchEvent('error', new CustomEvent({ detail: 'dbus-object : unsupported object count ('+obj.lengh+')' }))
				}

				this.object = obj[0]

				this._propertiesChangedCallback = (iface, changedProperties, invalidatedProperties) => {
					this._onPropertiesChanged (iface, changedProperties, invalidatedProperties)
				}
				this.object.on('properties-changed', this._propertiesChangedCallback)

				if (this.watchChanges) {
					this.initPropertiesChangedSignal()
				}
			}

			get (iface, propName) {
				if (this.object == null) {
					return
				}

				this.object.get(iface, propName)
			}

			getAll (iface) {
				if (this.object == null) {
					return
				}

				this.object.getAll(iface)
			}

			initPropertiesChangedSignal () {
				if (this.object == null) {
					return
				}

				this.object.initPropertiesChangedSignal()
			}

			_onPropertiesChanged (iface, changedProperties, invalidatedProperties) {
				for (let propName in changedProperties) {
					this.notifyPath(`object.${iface}.${propName}`)
				}

				invalidatedProperties.forEach(propName => {
					this.notifyPath(`object.${iface}.${propName}`)
				})
			}
		}

		customElements.define(DBusObject.is, DBusObject)
	</script>
</dom-module>
