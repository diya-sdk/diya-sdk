
<dom-module id="dbus-object">
	<template>
	</template>
	<script>
		class DBusObject extends Polymer.Element {
			static get is () { return 'dbus-object' }

			/**
			 * signals is an array of signal objects. Each signal object has the form { id, name, objectPath, iface, listener }. The unique ids are for reference purpose. Signal's names may be duplicate, but id are not.
			 */
			static get properties () {
				return {
					selector: { observer: 'updateState' },
					service: { type: String, observer: 'updateState' },
					objectPath: { type: String, observer: 'updateState' },
					object: { type: Object, notify: true },
					partialObject: { type: Object },
					signals: { type: Array, observer: 'updateState' },
					watchChanges: { type: Boolean, value: false }
				}
			}

			constructor () {
				super()
			}

			updateState () {
				console.log(`updateState, selector = ${this.selector}, service = ${this.service}, objectPath = ${this.objectPath}, object = ${this.object}, signals = ${this.signals == null ? null : this.signals[0].id}`)
				// remove old callbacks
				if (this.object != null) {
					this.object.removeListener('properties-changed', this._propertiesChangedCallback)
					if (this.signals != null) {
						this.signals.forEach(signal => {
							console.warn(`updateState, removing listener ${signal.id}`)
							this.object.removeListener(signal.id, signal.listener)
						})
					}
					this.object = null
				}

				if (this.selector == null || this.service == null || this.objectPath == null) {
					return
				}

				let obj = d1(this.selector).dbusObject(this.service, this.objectPath, this.partialObject, this.signals)

				if (obj.length !== 1) {
					this.dispatchEvent(new CustomEvent('error', { detail: 'dbus-object : unsupported object count ('+obj.lengh+')' }))
				}

				this.object = obj[0]

				if (this.object == null) {
					console.warn('updateState, unregistered object. Terminated.')
					return
				}

				this._propertiesChangedCallback = (iface, changedProperties, invalidatedProperties) => {
					this._onPropertiesChanged (iface, changedProperties, invalidatedProperties)
				}

				// listen to property changes, and signals
				this.object.on('properties-changed', this._propertiesChangedCallback)

				if (this.signals != null) {
					this.signals.forEach(signal => {
						this.object.on(signal.id, signal.listener)
					})
				}

				if (this.watchChanges) {
					this.initPropertiesChangedSignal()
					this.subscribeToSignals()
				}
			}

			get (iface, propName) {
				if (this.object == null) {
					return
				}

				this.object.get(iface, propName)
			}

			getAll (iface) {
				if (this.object == null) {
					return
				}

				this.object.getAll(iface)
			}

			initPropertiesChangedSignal () {
				if (this.object == null) {
					return
				}

				this.object.initPropertiesChangedSignal()
			}

			subscribeToSignals () {
				if (this.object == null) {
					return
				}
				this.object.subscribeToSignals()
			}

			/**
			 * Array properties not taken into consideration in this case
			 */
			_onPropertiesChanged (iface, changedProperties, invalidatedProperties) {
				for (let propName in changedProperties) {
					this.notifyPath(`object.${iface}.${propName}`)
				}

				invalidatedProperties.forEach(propName => {
					this.notifyPath(`object.${iface}.${propName}`)
				})
			}
		}

		customElements.define(DBusObject.is, DBusObject)
	</script>
</dom-module>
