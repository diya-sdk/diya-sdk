
<dom-module id="dbus-object">
	<template>
	</template>
	<script>
		class DBusObject extends Polymer.Element {
			static get is () { return 'dbus-object' }

			/**
			 * signals is an array of signal objects. Each signal object has the form { id, name, objectPath, iface, listener }. The unique ids are for reference purpose. Signal's names may be duplicate, but id are not.
			 */
			static get properties () {
				return {
					selector: { observer: 'updateState' },
					service: { type: String, observer: 'updateState' },
					objectPath: { type: String, observer: 'updateState' },
					object: { type: Object, notify: true },
					partialObject: { type: Object },
					signals: { type: Array, observer: 'updateState' },
					watchChanges: { type: Boolean, value: false },
					debug: { type: Boolean },
				}
			}

			constructor () {
				super()
			}

			updateState () {
				// remove old callbacks
				if (this.object != null) {
					this.unwatchProperties()
					this.object.removeListener ('properties-changed', this._propertiesChangedCallback)
					this.object = null
				}

				if (this.selector == null 
					|| (Array.isArray(this.selector) && this.selector.length === 0) 
					|| this.service == null 
					|| this.objectPath == null) {
					return
				}

				let obj = d1(this.selector).dbusObject(this.service, this.objectPath, this.partialObject)

				if (obj.length !== 1) {
					this.dispatchEvent(new CustomEvent('error', { detail: 'dbus-object : unsupported object count ('+obj.lengh+')' }))
				}

				this.object = obj[0]

				this._propertiesChangedCallback = (...args) => this._onPropertiesChanged(...args)
				this.object.on('properties-changed', this._propertiesChangedCallback)

				if (this.watchChanges) {
					this.watchProperties ()
				}
			}

			get (iface, propName) {
				if (this.object == null) {
					return
				}

				this.object.get(iface, propName)
			}

			getAll (iface) {
				if (this.object == null) {
					return
				}

				this.object.getAll(iface)
			}

			call (method, data, callback) {
				if (this.object == null) {
					return
				}

				this.object.call (method, data, callback)
			}

			watchProperties () {
				if (this.object == null) {
					return
				}
				
				this.object.watchProperties (this)
			}

			unwatchProperties () {
				if (this.object == null) {
					return
				}

				this.object.unwatchProperties (this)
			}

			watchSignal (signal, callback) {
				if (this.object == null) {
					return 
				}

				this.object.on(signal, callback, this)
			}

			unwatchSignal (signal, callback) {
				if (this.object == null) {
					return
				}

				this.object.removeListener (signal, callback, this)
			}

			_onPropertiesChanged (iface, changedProperties, invalidatedProperties) {
				for (let propName in changedProperties) {
					this.notifyPath(`object.${iface}.${propName}`)
				}

				invalidatedProperties.forEach(propName => {
					this.notifyPath(`object.${iface}.${propName}`)
				})
			}
		}

		customElements.define(DBusObject.is, DBusObject)
	</script>
</dom-module>
